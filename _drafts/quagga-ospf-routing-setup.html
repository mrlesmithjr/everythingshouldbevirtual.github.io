---
layout: post
title: Quagga OSPF Routing Setup
date: 
type: post
published: false
status: draft
categories: []
tags: []
meta:
  _edit_last: '11'
  snap_MYURL: ''
  snapEdIT: '1'
  snapDL: s:102:"a:1:{i:0;a:3:{s:4:"doDL";s:1:"1";s:11:"SNAPformatT";s:7:"%TITLE%";s:10:"SNAPformat";s:9:"%EXCERPT%";}}";
  snapFB: s:253:"a:1:{i:0;a:8:{s:4:"doFB";s:1:"1";s:8:"postType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";}}";
  snapLI: s:247:"a:1:{i:0;a:8:{s:4:"doLI";s:1:"1";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"SNAPformatT";s:1:" ";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";}}";
  snapSU: s:119:"a:1:{i:0;a:4:{s:4:"doSU";s:1:"1";s:7:"apSUCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";}}";
  snapTW: 's:172:"a:1:{i:0;a:5:{s:4:"doTW";s:1:"1";s:10:"SNAPformat";s:42:"%TITLE%
    - %URL% #everythingshouldbevirtual";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";}}";'
  _s2mail: 'yes'
author:
  login: larry.e.smith.jr
  email: larry.e.smith.jr@gmail.com
  display_name: mrlesmithjr
  first_name: Larry
  last_name: Smith
---
<p>In this post I will be setting up my network for OSPF routing between my Cisco 3750G switch stack and a Ubuntu VM running Quagga. The end goal in this is to move all of my layer 3 routing functionality into VMs and making my 3750G's become only layer 2 for VLANs and etc. But for now I want to go through how to set all of this up initially and then there will be follow up posts which will take us through additional functionality and setup. This setup will also allow for me to setup different tenant environments by deploying additional Quagga VMs or by creating additional VLANs and adding them to an existing Quagga VM. I began working through some of this after I have been working with VMware NSX for the past several months and I wanted to explore some similar setup scenarios utilizing all opensource and my infrastructure that I currently have in my home lab.</p>
<p>So the first thing we need to do is create the VLANs on the Cisco switches.</p>
<p>Now we need to create a new vDS portgroup and use VLAN trunking as our VLAN type.</p>
<p>Create new portgroup - vDS-In_Guest_VLAN_Tagging</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/09/Screen-Shot-2014-09-28-at-8.19.37-PM.png"><img class="alignnone size-medium wp-image-3238" src="{{ site.baseurl }}/assets/Screen-Shot-2014-09-28-at-8.19.37-PM-300x174.png" alt="Screen Shot 2014-09-28 at 8.19.37 PM" width="300" height="174" /></a></p>
<p>&nbsp;</p>
<p>Next, and select the drop-down under VLAN type and select VLAN trunking. Now enter the VLAN trunk range that we want to pass through to our Quagga VM. So in my setup I am entering 1,101-108,666,700-703.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/09/Screen-Shot-2014-09-28-at-8.21.09-PM.png"><img class="alignnone size-medium wp-image-3241" src="{{ site.baseurl }}/assets/Screen-Shot-2014-09-28-at-8.21.09-PM-300x175.png" alt="Screen Shot 2014-09-28 at 8.21.09 PM" width="300" height="175" /></a></p>
<p>Install VLAN support on Ubuntu</p>
<pre>sudo apt-get install vlan</pre>
<p>Install quagga</p>
<pre>sudo apt-get install quagga quagga-doc</pre>
<p>Now we need to setup the basics of Quagga. So we first need to enable IP forwarding within Ubuntu itself so we can forward IP traffic through each and every interface on our VM.</p>
<pre>echo "net.ipv4.conf.all.forwarding=1" | sudo tee -a /etc/sysctl.conf 
echo "net.ipv4.conf.default.forwarding=1" | sudo tee -a /etc/sysctl.conf 
sed 's/#net.ipv6.conf.all.forwarding=1/net.ipv6.conf.all.forwarding=1/g' /etc/sysctl.conf | sudo tee /etc/sysctl.conf
echo "net.ipv6.conf.default.forwarding=1" | sudo tee -a /etc/sysctl.conf 
sudo sysctl -p
</pre>
<p>Install DHCP Relay and DNSmasq</p>
<pre>sudo apt-get install isc-dhcp-server dnsmasq</pre>
<p>Now we need to configure the adapter on your Ubuntu VM on the new portgroup which will allow us to utilize VLAN tagging within our guest VM. You can also just add an additional network adapter to you VM.</p>
<p>So for my setup my /etc/network/interfaces looks like the following. You will need to adjust this to match your environment. What we are doing here is manually bringing up all of our physical adapters as well as creating our VLAN adapters which in my case are using eth2 which I configured on the newly created portgroup from above. We will be using Quagga to assign IP addresses to each VLAN interface instead of adding them here in our /etc/network/interfaces.</p>
<pre>iface lo inet loopback
auto lo

auto eth0
iface eth0 inet manual
up ip link set $IFACE up

auto eth1
iface eth1 inet manual
up ip link set $IFACE up

auto eth2
iface eth2 inet manual
up ip link set $IFACE up

auto vlan10
iface vlan10 inet manual
vlan_raw_device eth2
up ip link set $IFACE up

auto vlan101
iface vlan101 inet manual
vlan_raw_device eth2
up ip link set $IFACE up

auto vlan102
iface vlan102 inet manual
vlan_raw_device eth2
up ip link set $IFACE up

auto vlan105
iface vlan105 inet manual
vlan_raw_device eth2
up ip link set $IFACE up

auto vlan666
iface vlan666 inet manual
vlan_raw_device eth2
up ip link set $IFACE up

dns-search      everythingshouldbevirtual.local
dns-nameservers 10.0.101.110 10.0.101.111 10.0.110.112</pre>
<p>&nbsp;</p>
<p>Create NAT rules</p>
<pre>iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</pre>
<pre>sudo apt-get install iptables-persistent</pre>
<p>Now save all of your current firewall rules so they will be applied on reboot.</p>
<pre>sudo service iptables-persistent save</pre>
<p>While going through this I have also decided to replace my PFsense firewall once again and build out a new Ubuntu firewall/gateway using many pieces of this setup. So I will be updating throughout this post.</p>
<p>Now let's install DNSmasq (This will allow DNS caching for frequently accessed domain names therefore making the majority of DNS resolutions to come from the local cache and extremely fast)</p>
<pre>sudo apt-get install dnsmasq</pre>
<p>Install Squid proxy (We will be setting this up as transparent on tcp/3128 so there is not any configuration required on your clients. This will also require an IPTables rule to redirect all HTTP traffic through squid)</p>
<pre>sudo apt-get install squid
sudo update-rc.d squid3 defaults</pre>
