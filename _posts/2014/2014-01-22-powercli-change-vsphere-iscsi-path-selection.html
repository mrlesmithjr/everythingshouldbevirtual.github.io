---
layout: post
title: PowerCLI – Change vSphere iSCSI Path Selection
date: 2014-01-22 19:16:55.000000000 -05:00
type: post
published: true
status: publish
categories:
- PowerCLI
- Virtualization
- VMware
tags:
- iSCSI
- mpio
- powercli
meta:
  snapEdIT: '1'
  snap_MYURL: ''
  _edit_last: '11'
  snapSU: s:259:"a:1:{i:0;a:9:{s:4:"doSU";s:1:"1";s:7:"apSUCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:6:"71qIB9";s:7:"postURL";s:6:"71qIB9";s:5:"pDate";s:19:"2014-01-23
    00:17:02";}}";
  snap_isAutoPosted: '1'
  bwps_enable_ssl: ''
  _s2mail: 'yes'
  snapDL: s:102:"a:1:{i:0;a:3:{s:4:"doDL";s:1:"1";s:11:"SNAPformatT";s:7:"%TITLE%";s:10:"SNAPformat";s:9:"%EXCERPT%";}}";
  snapFB: s:416:"a:1:{i:0;a:13:{s:4:"doFB";s:1:"1";s:8:"PostType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:31:"389547404477041_529980417100405";s:5:"pDate";s:19:"2014-01-23
    00:16:56";s:8:"postType";s:1:"A";}}";
  snapLI: s:274:"a:1:{i:0;a:9:{s:4:"doLI";s:1:"1";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"SNAPformatT";s:1:" ";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";}}";
  snapTW: 's:298:"a:1:{i:0;a:9:{s:4:"doTW";s:1:"1";s:10:"SNAPformat";s:42:"%TITLE%
    - %URL% #everythingshouldbevirtual";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"426146519025455104";s:5:"pDate";s:19:"2014-01-23
    00:17:02";}}";'
  _yoast_wpseo_focuskw: PowerCLI - Change vSphere iSCSI
  _yoast_wpseo_linkdex: '58'
  _wp_rp_image: empty
  _wp_rp_related_posts_query_result_cache_expiration: '1510056275'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:4:"2280";s:5:"score";s:18:"120.84095654916797";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:4:"3114";s:5:"score";s:17:"88.56608228936072";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:4:"2156";s:5:"score";s:17:"85.19328438214885";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:4:"2329";s:5:"score";s:17:"77.47063861586084";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:3:"909";s:5:"score";s:17:"66.50491869052618";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"3826";s:5:"score";s:18:"54.215182051340776";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:3:"199";s:5:"score";s:18:"50.660215290583025";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:3:"755";s:5:"score";s:16:"49.6622329589879";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:2:"41";s:5:"score";s:16:"49.6622329589879";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:3:"887";s:5:"score";s:18:"47.355090612466796";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:2:"34";s:5:"score";s:18:"46.452419758546434";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:2:"98";s:5:"score";s:17:"46.34250198971219";}}
  dsq_thread_id: '3352153391'
author:
  login: larry.e.smith.jr
  email: larry.e.smith.jr@gmail.com
  display_name: mrlesmithjr
  first_name: Larry
  last_name: Smith
---
<p>Here is just a quick PowerCLI script to change all of your iSCSI datastores to "Round Robin" path selection. The default path selection for all datastores is "Most Recently Used" which means that any given time you will only be utilizing one storage path. So why would we want to do this? The answer is that we want to utilize multiple paths to our storage to increase our throughput which is called MPIO (MultiPath I/O). So in order to automate these changes we can use a PowerCLI script which is what is provided below. You will need to tweak the variables ($vi_server, $vcuser and $vcpass) to match your vCenter environment.</p>
<p>Updated because below caused a loop!</p>
<pre><del>$vi_server = "vcsa"
$vcuser = "root"
$vcpass = "vmware1"
Connect-VIServer -Server $vi_server -User $vcuser -Password $vcpass
foreach ($vmhost in $vmhosts) {
$HBANumber = Get-VMHostHba -VMHost $vmhost -Type iSCSI
Get-ScsiLun –Hba $HBANumber | Set-ScsiLun –MultipathPolicy “RoundRobin”
}</del></pre>
<p>The correct way to do this is as below.</p>
<pre> PowerCLI Script for building lab hosts
# @mrlesmithjr
# EverythingShouldBeVirtual.com

$vi_server = "vcenter"
$vcuser = "root"
$vcpass = "vmware1"

Connect-VIServer -Server $vi_server -User $vcuser -Password $vcpass

# Setup variable to use in script for all hosts in vCenter
$vmhosts = @(Get-VMHost)

foreach ($vmhost in $vmhosts) {
	# Setup esxcli for use on each host
	$esxcli = Get-EsxCli -VMHost $vmhost
	# Get a list of all available LUNs, sorting them by device name
	$lunList = Get-VMHost $vmhost | Get-ScsiLun -CanonicalName “*” | % {$_.CanonicalName}
	foreach ($lun in $lunList) {
		$esxcli.storage.nmp.device.set($null,$lun,”VMW_PSP_RR”)
	}
}

Disconnect-VIServer * -Confirm:$false</pre>
<p>Enjoy!</p>
