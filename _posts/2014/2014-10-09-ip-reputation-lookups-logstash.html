---
layout: post
title: IP Reputation Lookups with Logstash
date: 2014-10-09 17:28:56.000000000 -04:00
type: post
published: true
status: publish
categories:
- Logstash
- Monitoring
tags:
- logstash
meta:
  _edit_last: '11'
  snap_MYURL: ''
  snapEdIT: '1'
  snapDL: s:242:"a:1:{i:0;a:7:{s:4:"doDL";s:1:"1";s:11:"SNAPformatT";s:7:"%TITLE%";s:10:"SNAPformat";s:9:"%EXCERPT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:32:"68980feee8bf8118f0bc8234e9e1fa33";s:5:"pDate";s:19:"2014-10-09
    21:28:57";}}";
  snapSU: s:304:"a:1:{i:0;a:9:{s:4:"doSU";s:1:"1";s:7:"apSUCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:6:"1tTkul";s:7:"postURL";s:50:"http://www.stumbleupon.com/content/1tTkul/comments";s:5:"pDate";s:19:"2014-10-09
    21:29:08";}}";
  snapTW: 's:316:"a:1:{i:0;a:9:{s:4:"doTW";s:1:"1";s:10:"SNAPformat";s:60:"%TITLE%
    - %URL% #everythingshouldbevirtual #logstash #devops";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"520325113728991232";s:5:"pDate";s:19:"2014-10-09
    21:29:09";}}";'
  _s2mail: 'yes'
  _yoast_wpseo_focuskw: ip reputation lookup
  _yoast_wpseo_metadesc: ip reputation lookup
  _yoast_wpseo_linkdex: '81'
  snap_isAutoPosted: '1'
  snapFB: s:280:"a:1:{i:0;a:9:{s:4:"doFB";s:1:"1";s:8:"postType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";}}";
  snapLI: s:274:"a:1:{i:0;a:9:{s:4:"doLI";s:1:"1";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"SNAPformatT";s:1:" ";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";}}";
  _wp_rp_image: empty
  _wp_rp_related_posts_query_result_cache_expiration: '1509639077'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:4:"3353";s:5:"score";s:17:"76.20818691132402";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:4:"2854";s:5:"score";s:17:"72.77128401891517";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:4:"3341";s:5:"score";s:17:"68.70296451493621";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:4:"2985";s:5:"score";s:17:"64.99589085753567";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"4466";s:5:"score";s:17:"64.95155273419157";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"3793";s:5:"score";s:17:"62.68874851101456";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:4:"2870";s:5:"score";s:17:"61.69076617941944";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"4695";s:5:"score";s:17:"61.40164803234873";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"2242";s:5:"score";s:16:"60.7678246104127";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"4447";s:5:"score";s:17:"57.09854102263739";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:4:"3313";s:5:"score";s:17:"57.09854102263739";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"4297";s:5:"score";s:17:"36.88685046787958";}}
  dsq_thread_id: '3348015030'
author:
  login: larry.e.smith.jr
  email: larry.e.smith.jr@gmail.com
  display_name: mrlesmithjr
  first_name: Larry
  last_name: Smith
---
<p>I had a great question yesterday about how to configure Logstash to integrateÂ IP reputation lookups within Logstash and Kibana without having to copy and paste an IP address and etc. I thought this was a great idea and one that I had not myself thought about so I gave it a shot to see what I could come up with. And believe it or not it was actually quite simple to put in place and I figured I may as well share with everyone as well.</p>
<p>So in this setup I wanted to add IP reputation links for Apache type events which added a new field and provided the url to click on within Kibana. I will be setting up <a title="http://senderbase.org" href="http://senderbase.org">senderbase</a> and <a title="http://spamhaus.org" href="http://spamhaus.org">spamhaus</a> for now to provide this info. (I apologize if your IP address is the one used in this but....)</p>
<p>Within your logstash.conf file you would add the following snippet of code under your Apache parsing to do this.</p>
<pre>mutate {
	add_field =&gt; [ "senderbase_lookup", "http://www.senderbase.org/lookup/?search_string=%{src_ip}" ]
	add_field =&gt; [ "spamhaus_lookup", "http://www.spamhaus.org/query/bl?ip=%{src_ip}" ]
}</pre>
<p>A complete Apache parsing setup that I use including this looks like this.</p>
<pre># Setting up Apache web server parsing
filter {
        if [type] =~ "apache" {
                grok {
                        pattern =&gt; "%{COMBINEDAPACHELOG}"
                }
                geoip {
                        source =&gt; "clientip"
                        target =&gt; "geoip"
                        add_field =&gt; [ "[geoip][coordinates]", "%{[geoip][longitude]}" ]
                        add_field =&gt; [ "[geoip][coordinates]", "%{[geoip][latitude]}"  ]
                }
                date {
                        match =&gt; [ "timestamp" , "dd/MMM/yyyy:HH:mm:ss Z" ]
                }
                mutate {
                        add_field =&gt; [ "src_ip", "%{clientip}" ]
                        convert =&gt; [ "[geoip][coordinates]", "float" ]
                        rename =&gt; [ "verb" , "method" ]
                }
                grok {
                        match =&gt; [
                                "message", "%{DATA:apache_vhost} "
                        ]
                }
                useragent {
                        add_tag =&gt; [ "UA" ]
                        source =&gt; "agent"
                }
                if "UA" in [tags] {
                        mutate {
                                rename =&gt; [ "name", "browser_name" ]
                        }
                }
		<strong>mutate {
			add_field =&gt; [ "senderbase_lookup", "http://www.senderbase.org/lookup/?search_string=%{src_ip}" ]
			add_field =&gt; [ "spamhaus_lookup", "http://www.spamhaus.org/query/bl?ip=%{src_ip}" ]
		}</strong>
        }
}</pre>
<p>With this setup you will get the following bit of info in your events now.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/10/Screen-Shot-2014-10-09-at-5.18.02-PM.png"><img class="alignnone size-medium wp-image-3306" src="{{ site.baseurl }}/assets/Screen-Shot-2014-10-09-at-5.18.02-PM-300x144.png" alt="Screen Shot 2014-10-09 at 5.18.02 PM" width="300" height="144" /></a></p>
<p>As you can from the image above you now have clickable URL's for each of these including the original src_ip from the source.</p>
<p>So that is it and you should be able to apply this same method to other types of parsing as you see fit.</p>
<p>Enjoy!</p>
