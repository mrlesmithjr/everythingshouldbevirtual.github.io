---
layout: post
title: vSphere - Enable SSH using PowerCLI
date: 2014-07-28 15:47:37.000000000 -04:00
type: post
published: true
status: publish
categories:
- PowerCLI
- vCenter
- VMware
- vSphere 5.1
- vSphere 5.5
tags:
- powercli
- Vsphere
meta:
  snapLI: s:521:"a:1:{i:0;a:13:{s:4:"doLI";s:1:"1";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"SNAPformatT";s:0:"";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:19:"5899610962817740800";s:7:"postURL";s:124:"http://www.linkedin.com/updates?discuss=&amp;scope=138895851&amp;stype=M&amp;topic=5899610962817740800&amp;type=U&amp;a=x85t";s:5:"pDate";s:19:"2014-07-28
    19:47:43";}}";
  snapSU: s:304:"a:1:{i:0;a:9:{s:4:"doSU";s:1:"1";s:7:"apSUCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:6:"5eL12M";s:7:"postURL";s:50:"http://www.stumbleupon.com/content/5eL12M/comments";s:5:"pDate";s:19:"2014-07-28
    19:47:51";}}";
  _edit_last: '11'
  snap_MYURL: ''
  snapEdIT: '1'
  snapDL: s:242:"a:1:{i:0;a:7:{s:4:"doDL";s:1:"1";s:11:"SNAPformatT";s:7:"%TITLE%";s:10:"SNAPformat";s:9:"%EXCERPT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:32:"f8c3b6548cd39c62605f064019488a50";s:5:"pDate";s:19:"2014-07-28
    19:47:38";}}";
  snapTW: 's:317:"a:1:{i:0;a:9:{s:4:"doTW";s:1:"1";s:10:"SNAPformat";s:61:"%TITLE%
    - %URL% #everythingshouldbevirtual #vsphere #powercli";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"493845310322769920";s:5:"pDate";s:19:"2014-07-28
    19:47:52";}}";'
  snap_isAutoPosted: '1'
  snapFB: s:280:"a:1:{i:0;a:9:{s:4:"doFB";s:1:"1";s:8:"postType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";}}";
  _s2mail: 'yes'
  _wp_rp_image: empty
  _wp_rp_related_posts_query_result_cache_expiration: '1511951818'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:4:"2280";s:5:"score";s:18:"151.40058413457157";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:4:"2156";s:5:"score";s:18:"117.68552017323591";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:4:"2329";s:5:"score";s:18:"102.52492873446751";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:4:"2314";s:5:"score";s:17:"88.66332710571295";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:3:"626";s:5:"score";s:17:"73.41482136300539";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"2233";s:5:"score";s:17:"61.00083829243086";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:4:"1935";s:5:"score";s:18:"54.392851747530024";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"1695";s:5:"score";s:16:"49.2259351004582";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"1190";s:5:"score";s:18:"46.217780306556136";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:3:"909";s:5:"score";s:17:"45.91432743470068";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:4:"1879";s:5:"score";s:18:"44.560823840286695";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:3:"522";s:5:"score";s:18:"42.906172640798616";}}
  dsq_thread_id: '3348942140'
author:
  login: larry.e.smith.jr
  email: larry.e.smith.jr@gmail.com
  display_name: mrlesmithjr
  first_name: Larry
  last_name: Smith
---
<p>In case you have the need to enable SSH, set SSH service to start on boot and also set the firewall rule to allow ALL IPs you can use the following PowerCLI script. If you need to lock down the firewall to only allow from a certain IP you can uncomment the appropriate lines and comment out the others. This script will also disable the SSH alert for every host in vCenter to get rid of the nagging alert. This script will connect to vCenter and run against every host in vCenter as well.</p>
<pre># PowerCLI Script for enabling SSH, setting firewall and disable SSH alert in vCenter
# @mrlesmithjr
# EverythingShouldBeVirtual.com

# Setup common variables to use
$vi_server = "vcsa.everythingshouldbevirtual.local" # Set to your vCenter hostname|IP
$vcuser = "vcenteruser" # Set to your vCenter username to connect
$vcpass = "vcenterpassword" # Set to your vCenter username password to connect
$ip = 10.0.101.122 # Set IP to your manamgement station if you are locking down the firewall

Connect-VIServer -Server $vi_server -User $vcuser -Password $vcpass

# Setup variable to use in script for all hosts in vCenter
$vmhosts = @(Get-VMHost)

foreach ($vmhost in $vmhosts) {
	write-host "Configuring SSH on host: $($vmHost.Name)" -fore Yellow
    if((Get-VMHostService -VMHost $vmHost | where {$_.Key -eq "TSM-SSH"}).Policy -ne "on"){
        Write-Host "Setting SSH service policy to automatic on $($vmHost.Name)"
        Get-VMHostService -VMHost $vmHost | where { $_.key -eq "TSM-SSH" } | Set-VMHostService -Policy "On" -Confirm:$false -ea 1 | Out-null
	}
	if((Get-VMHostService -VMHost $vmHost | where {$_.Key -eq "TSM-SSH"}).Running -ne $true){
        Write-Host "Starting SSH service on $($vmHost.Name)"
        Start-VMHostService -HostService (Get-VMHost $vmHost | Get-VMHostService | Where { $_.Key -eq "TSM-SSH"}) | Out-null
    }
	$esxcli = Get-EsxCli -VMHost $vmhost
	if($esxcli -ne $null){
		# Uncomment below to set firewall to allow only from a certain IP
		#if(($esxcli.network.firewall.ruleset.allowedip.list("sshServer") | select AllowedIPAddresses).AllowedIPAddresses -eq "All"){
			#Write-Host "Changing the sshServer firewall configuration"        
				#$esxcli.network.firewall.ruleset.set($false, $true, "sshServer")
				#$esxcli.network.firewall.ruleset.allowedip.add("$ip", "sshServer")
				#$esxcli.network.firewall.refresh()
		#}
		# End Uncomment
		# Comment out below if using the above to set firewall to a specific IP
		if(($esxcli.network.firewall.ruleset.allowedip.list("sshServer") | select AllowedIPAddresses).AllowedIPAddresses -ne "All"){
        	Write-Host "Changing the sshServer firewall configuration"        
        		$esxcli.network.firewall.ruleset.set($true, $true, "sshServer")
            	$esxcli.network.firewall.refresh()
        }
		# End Comment
		if(($vmHost | Get-AdvancedSetting | Where {$_.Name -eq "UserVars.SuppressShellWarning"}).Value -ne "1"){
        	Write-Host "Suppress the SSH warning message"
        		$vmHost | Get-AdvancedSetting | Where {$_.Name -eq "UserVars.SuppressShellWarning"} | Set-AdvancedSetting -Value "1" -Confirm:$false | Out-null
    	}
}
# Disconnect from vCenter
Disconnect-VIServer * -Confirm:$false
</pre>
<p>Enjoy!</p>
