---
layout: post
title: IPTables Cluster Script
date: 2014-09-26 18:28:10.000000000 -04:00
type: post
published: true
status: publish
categories:
- Linux
tags:
- iptables
meta:
  _edit_last: '11'
  snap_MYURL: ''
  snapEdIT: '1'
  snapDL: s:242:"a:1:{i:0;a:7:{s:4:"doDL";s:1:"1";s:11:"SNAPformatT";s:7:"%TITLE%";s:10:"SNAPformat";s:9:"%EXCERPT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:32:"bd7233d2e54508cfeca614c8c3746581";s:5:"pDate";s:19:"2014-09-26
    22:28:11";}}";
  snapSU: s:304:"a:1:{i:0;a:9:{s:4:"doSU";s:1:"1";s:7:"apSUCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:6:"1bwq7e";s:7:"postURL";s:50:"http://www.stumbleupon.com/content/1bwq7e/comments";s:5:"pDate";s:19:"2014-09-26
    22:28:25";}}";
  snapTW: 's:331:"a:1:{i:0;a:9:{s:4:"doTW";s:1:"1";s:10:"SNAPformat";s:75:"%TITLE%
    - %URL% #everythingshouldbevirtual #ubuntu #linux #devops #iptables";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"515628990519054337";s:5:"pDate";s:19:"2014-09-26
    22:28:26";}}";'
  snap_isAutoPosted: '1'
  snapFB: s:280:"a:1:{i:0;a:9:{s:4:"doFB";s:1:"1";s:8:"postType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";}}";
  snapLI: s:274:"a:1:{i:0;a:9:{s:4:"doLI";s:1:"1";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"SNAPformatT";s:1:" ";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";}}";
  _s2mail: 'yes'
  _wp_rp_related_posts_query_result_cache_expiration: '1510180481'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:3:"699";s:5:"score";s:18:"119.57139625861058";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:3:"878";s:5:"score";s:17:"61.79587059167181";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:3:"729";s:5:"score";s:17:"56.99631710968734";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:3:"668";s:5:"score";s:17:"56.99631710968734";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"7208";s:5:"score";s:17:"29.70111229976955";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"2586";s:5:"score";s:18:"29.687997497846066";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:4:"2646";s:5:"score";s:18:"26.961653610214228";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"2985";s:5:"score";s:17:"25.94048656662406";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"3114";s:5:"score";s:18:"24.919653641727955";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"2314";s:5:"score";s:17:"24.50143451290153";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:4:"4695";s:5:"score";s:17:"22.75344165194558";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"3249";s:5:"score";s:17:"22.75344165194558";}}
  _wp_rp_image: empty
  dsq_thread_id: '3346749207'
author:
  login: larry.e.smith.jr
  email: larry.e.smith.jr@gmail.com
  display_name: mrlesmithjr
  first_name: Larry
  last_name: Smith
---
<p>I have been working on some interesting virtualized networking setups (More on this in another post soon) and needed a way to configure IPTables rules on all nodes which are to be considered part of a cluster (HA) setup. What I wanted was the ability to take a rule or a set of rules and apply them to any number of nodes so they were all consistent and the rules to be saved and not have to login to each node individually. Now I know that I can do this with an automated solution (Puppet, Chef, Ansible or Salt) but I instead wanted to do this using a very simple shell script. So here is what I came up with and it works perfectly therefore I wanted to share this in the odd chance that maybe someone else may benefit from it as well.</p>
<p>If you do not want to be prompted each time for a password when running the script (SSH login prompts) you should setup passwordless ssh sessions between your servers and the central server that you plan on running the script from. The account used to execute the script will also need to be root or have sudo permissions.</p>
<pre>ssh-keygen
ssh-copy-id remote-user@hostname</pre>
<p>Now we need to create the following files.</p>
<pre>sudo nano /opt/nodes.txt</pre>
<p>Add all of the nodes that you would like to be part of your cluster and save the file.</p>
<pre>sudo nano /opt/iptables_cluster.sh</pre>
<p>Now paste the following code into this file and save it.</p>
<p>https://gist.github.com/mrlesmithjr/b4d1c4d7df2c9d2c1e20</p>
<p>Now make the script executable</p>
<pre>sudo chmod +x /opt/iptables_cluster.sh</pre>
<p>Now you are ready to deploy out your IPTables rule(s) to all of your nodes. When you run the script it will prompt for you to enter the rule or rules that you would like to apply. You can copy and paste your rules or type them all out. You will need to enter the rules exactly as you would from the CLI and then type done and press enter on the very last line of your rules.</p>
<pre>/opt/iptables_cluster.sh</pre>
<p>Below is what you will see when executing the script.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/09/Screen-Shot-2014-09-26-at-6.16.55-PM.png"><img class="alignnone size-medium wp-image-3218" src="{{ site.baseurl }}/assets/Screen-Shot-2014-09-26-at-6.16.55-PM-300x70.png" alt="Screen Shot 2014-09-26 at 6.16.55 PM" width="300" height="70" /></a></p>
<p>Now just enter your rule or rules like below and type done and enter at the end. (If you are using sudo instead of root you will need to prepend the iptables rules with sudo)</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/09/Screen-Shot-2014-09-26-at-6.17.14-PM.png"><img class="alignnone size-medium wp-image-3222" src="{{ site.baseurl }}/assets/Screen-Shot-2014-09-26-at-6.17.14-PM-300x74.png" alt="Screen Shot 2014-09-26 at 6.17.14 PM" width="300" height="74" /></a></p>
<p>And off you go. I will be adding more functionality to this as time goes on but for now this is what I was needing.</p>
<p>Enjoy!</p>
