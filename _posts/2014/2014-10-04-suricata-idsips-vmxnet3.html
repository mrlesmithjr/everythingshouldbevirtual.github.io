---
layout: post
title: Suricata IDS/IPS VMXNET3
date: 2014-10-04 23:15:48.000000000 -04:00
type: post
published: true
status: publish
categories:
- Linux
- Security
- Suricata
- Ubuntu
tags:
- linux
- suricata
meta:
  _yoast_wpseo_focuskw: suricata ids
  _yoast_wpseo_metadesc: suricata
  _yoast_wpseo_linkdex: '76'
  _edit_last: '11'
  snap_MYURL: ''
  snapEdIT: '1'
  snapDL: s:98:"a:1:{i:0;a:3:{s:4:"doDL";i:0;s:11:"SNAPformatT";s:7:"%TITLE%";s:10:"SNAPformat";s:9:"%EXCERPT%";}}";
  snapFB: s:249:"a:1:{i:0;a:8:{s:4:"doFB";i:0;s:8:"postType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";}}";
  snapLI: s:243:"a:1:{i:0;a:8:{s:4:"doLI";i:0;s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"SNAPformatT";s:1:" ";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";}}";
  snapSU: s:115:"a:1:{i:0;a:4:{s:4:"doSU";i:0;s:7:"apSUCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";}}";
  snapTW: 's:168:"a:1:{i:0;a:5:{s:4:"doTW";i:0;s:10:"SNAPformat";s:42:"%TITLE% - %URL%
    #everythingshouldbevirtual";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";}}";'
  _s2mail: 'yes'
  _wp_rp_related_posts_query_result_cache_expiration: '1511934473'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:3:"699";s:5:"score";s:17:"90.26186791684427";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:3:"687";s:5:"score";s:17:"83.69218335903516";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:3:"878";s:5:"score";s:17:"82.69838473123613";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:3:"164";s:5:"score";s:17:"56.04279641792627";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:3:"729";s:5:"score";s:18:"49.707157815526976";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"1566";s:5:"score";s:17:"49.48692038910935";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:4:"1016";s:5:"score";s:16:"44.9106165164589";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:3:"668";s:5:"score";s:17:"41.45935108659968";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"2254";s:5:"score";s:17:"36.41933487633338";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"2646";s:5:"score";s:18:"34.683157615819525";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:4:"4695";s:5:"score";s:17:"32.06334844564616";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"3249";s:5:"score";s:17:"32.06334844564616";}}
  _wp_rp_image: empty
  dsq_thread_id: '3346750649'
author:
  login: larry.e.smith.jr
  email: larry.e.smith.jr@gmail.com
  display_name: mrlesmithjr
  first_name: Larry
  last_name: Smith
---
<p>As part of a bigger post coming soon I have been using <a title="http://suricata-ids.org/" href="http://suricata-ids.org/" target="_blank">Suricata IDS</a> and my Logstash server has been getting hammered and unable to keep up (running a single node setup) but finally figured out why this was happening so I am sharing this with others in case you decide to send Suricata IDS logs to Logstash or any other Syslog collector you will more than likely run into this as well.</p>
<p>What I was noticing in /var/log/suricata/fast.log was the following entries being spit out (note the timestamps to see how fast these were being generated)</p>
<pre>10/03/2014-20:45:32.046859  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:49202 -&gt; y.y.y.y:443
10/03/2014-20:45:32.046909  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:49202 -&gt; y.y.y.y:443
10/03/2014-20:45:32.046938  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:49202 -&gt; y.y.y.y:443
10/03/2014-20:45:32.046966  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:49202 -&gt; y.y.y.y:443
10/03/2014-20:45:32.046995  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:49202 -&gt; y.y.y.y:443
10/03/2014-20:45:32.055373  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:49202 -&gt; y.y.y.y:443
10/03/2014-20:45:32.055449  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:49202 -&gt; y.y.y.y:443
10/03/2014-20:45:32.094880  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:49202 -&gt; y.y.y.y:443
10/03/2014-20:45:32.094951  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:49202 -&gt; y.y.y.y:443
10/03/2014-20:45:32.171191  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:49202 -&gt; y.y.y.y:443
10/03/2014-20:45:32.171253  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:49202 -&gt; y.y.y.y:443
10/03/2014-20:45:32.211188  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:49202 -&gt; y.y.y.y:443
10/03/2014-20:45:32.211348  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:49202 -&gt; y.y.y.y:443
10/03/2014-20:45:32.215418  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:49202 -&gt; y.y.y.y:443
10/03/2014-20:45:32.215471  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:49202 -&gt; y.y.y.y:443
10/03/2014-20:45:32.216030  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:49202 -&gt; y.y.y.y:443
</pre>
<p>So basically this has been doing this non-stop for about 2-3 days now and being that I am sending the Suricata logs through a Redis cache broker it was overload the queues and chewing up all of the available memory and crashing Redis and also in turn crashing Elasticsearch. (Sounds like fun right?)<br />
Anyways here is what the issue with this is. These invalid checksum alerts are being generated because by default Suricata has checksum-validation set to yes in /etc/suricata/suricata.yaml and by default checksum offloading is turned on for VMXNET3 (Other adapters as well). So now the decision is to set checksum-validation to no in Suricata or turn off checksum offloading on the adapter. At least in my case I still want Suricata to detect <strong>TRUE</strong> invalid checksums therefore I chose to disable checksum offloading on the adapter. So being that Suricata is running on a Linux VM you need to use the ethtool to turn this off.<br />
If on a Ubuntu system you can install this using apt.</p>
<pre>sudo apt-get install ethtool</pre>
<p>Now to validate if checksum offloading is turned on for the adapter that you have Suricata setup to listen on do the following. (Change eth0 to whichever adapter is in your setup)</p>
<pre>sudo ethtool -k eth0</pre>
<p>And you should see output similar to below.</p>
<pre>Offload parameters for eth0:
<strong>rx-checksumming: on</strong>
<strong>tx-checksumming: on</strong>
<strong>scatter-gather: on</strong>
<strong>tcp-segmentation-offload: on</strong>
udp-fragmentation-offload: off
<strong>generic-segmentation-offload: on</strong>
generic-receive-offload: on
large-receive-offload: off
rx-vlan-offload: on
tx-vlan-offload: on
ntuple-filters: off
receive-hashing: off</pre>
<p>All of the settings in bold above represent what settings are on when checksum offloading is turned on. So all you need to do to turn off checksum offloading is run the following.</p>
<pre>sudo ethtool --offload eth0 rx off tx off</pre>
<p>Now if you validate your settings you should the following</p>
<pre>Offload parameters for eth0:
<strong>rx-checksumming: off
tx-checksumming: off
scatter-gather: off</strong>
<strong>tcp-segmentation-offload: off
</strong>udp-fragmentation-offload: off
<strong>generic-segmentation-offload: off
</strong>generic-receive-offload: on
large-receive-offload: off
rx-vlan-offload: on
tx-vlan-offload: on
ntuple-filters: off
receive-hashing: off
</pre>
<p>And now if you take a look at your /var/log/suricata/fast.log it should be much cleaner. And should only be seeing invalid checksums for valid packets instead of the majority.</p>
<pre>10/03/2014-21:57:32.101095  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:53742 -&gt; y.y.y.y:80
10/03/2014-21:57:51.013553  [**] [1:2200074:1] SURICATA TCPv4 invalid checksum [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:49593 -&gt; y.y.y.y:80
10/03/2014-21:57:54.392025  [**] [1:2210044:1] SURICATA STREAM Packet with invalid timestamp [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:65264 -&gt; y.y.y.y:80
10/03/2014-21:57:57.231561  [**] [1:2210044:1] SURICATA STREAM Packet with invalid timestamp [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:29270 -&gt; x.x.x.x:80
10/03/2014-21:57:57.233436  [**] [1:2210033:1] SURICATA STREAM FIN1 invalid ack [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:80 -&gt; x.x.x.x:29270
10/03/2014-21:57:57.233436  [**] [1:2210045:1] SURICATA STREAM Packet with invalid ack [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:80 -&gt; y.y.y.y:29270
10/03/2014-21:57:57.237873  [**] [1:2210033:1] SURICATA STREAM FIN1 invalid ack [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:80 -&gt; y.y.y.y:29270
10/03/2014-21:57:57.237873  [**] [1:2210045:1] SURICATA STREAM Packet with invalid ack [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:80 -&gt; y.y.y.y:29270
10/03/2014-21:57:57.237894  [**] [1:2210032:1] SURICATA STREAM FIN1 FIN with wrong seq [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:80 -&gt; y.y.y.y:29270
10/03/2014-21:57:57.409695  [**] [1:2210044:1] SURICATA STREAM Packet with invalid timestamp [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:29270 -&gt; y.y.y.y:80
10/03/2014-21:57:57.409808  [**] [1:2210044:1] SURICATA STREAM Packet with invalid timestamp [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:29270 -&gt; y.y.y.y:80
10/03/2014-21:57:57.409843  [**] [1:2210044:1] SURICATA STREAM Packet with invalid timestamp [**] [Classification: (null)] [Priority: 3] {TCP} x.x.x.x:29270 -&gt; y.y.y.y:80
</pre>
<p>Now if you would like these settings to apply after a reboot you can add the following to <em>/etc/network/interfaces</em>.</p>
<pre>sudo nano /etc/network/interfaces</pre>
<p>Now add/change the following appropriate for your corresponding interface.</p>
<pre># Connected to TAP or SPAN port for traffic monitoring
auto eth1
iface eth1 inet manual
  up ifconfig $IFACE -arp up
  up ip link set $IFACE promisc on
  down ip link set $IFACE promisc off
  down ifconfig $IFACE down
  post-up for i in rx tx sg tso ufo gso gro lro; do ethtool -K $IFACE $i off; done
  post-up echo 1 &gt; /proc/sys/net/ipv6/conf/$IFACE/disable_ipv6
</pre>
<p>And if you want to modify your ring buffer change the following.<br />
From:</p>
<pre>post-up for i in rx tx sg tso ufo gso gro lro; do ethtool -K $IFACE $i off; done</pre>
<pre>To:</pre>
<pre>post-up ethtool -G $IFACE rx 4096; for i in rx tx sg tso ufo gso gro lro; do ethtool -K $IFACE $i off; done</pre>
<p>Hope this helps someone else out as well.</p>
<p>Enjoy!</p>
