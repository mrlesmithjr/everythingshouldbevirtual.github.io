---
layout: post
title: Collecting Netflow and Sending to Solarwinds NTA
date: 2014-02-10 07:00:45.000000000 -05:00
type: post
published: true
status: publish
categories:
- Solarwinds
tags:
- nbox
- nprobe
- solarwinds
- vds
meta:
  _edit_last: '11'
  snap_MYURL: ''
  snapEdIT: '1'
  snapSU: s:304:"a:1:{i:0;a:9:{s:4:"doSU";s:1:"1";s:7:"apSUCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:6:"4xpIvu";s:7:"postURL";s:50:"http://www.stumbleupon.com/content/4xpIvu/comments";s:5:"pDate";s:19:"2014-02-10
    12:01:10";}}";
  snapTW: 's:316:"a:1:{i:0;a:9:{s:4:"doTW";s:1:"1";s:10:"SNAPformat";s:63:"%TITLE%
    - %URL% #everythingshouldbevirtual @solarwinds #vsphere";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";b:0;s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"432846702903844864";s:5:"pDate";s:19:"2014-02-10
    12:01:10";}}";'
  bwps_enable_ssl: ''
  _s2mail: 'yes'
  snap_isAutoPosted: '1'
  snapFB: s:274:"a:1:{i:0;a:9:{s:4:"doFB";s:1:"1";s:8:"postType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";b:0;s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";b:0;s:11:"isPrePosted";s:1:"1";}}";
  snapLI: s:268:"a:1:{i:0;a:9:{s:4:"doLI";s:1:"1";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"SNAPformatT";s:1:" ";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";b:0;s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";b:0;s:11:"isPrePosted";s:1:"1";}}";
  _thumbnail_id: '2382'
  _wp_rp_related_posts_query_result_cache_expiration: '1509422414'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:4:"2670";s:5:"score";s:17:"66.15506365940038";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:4:"2458";s:5:"score";s:17:"66.15506365940038";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:4:"2538";s:5:"score";s:17:"65.15708132780526";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:3:"747";s:5:"score";s:18:"58.770675834611836";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"1695";s:5:"score";s:17:"56.26514989762109";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"1662";s:5:"score";s:18:"48.696770629784574";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:3:"503";s:5:"score";s:18:"45.391645951668345";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"1815";s:5:"score";s:16:"33.5398696539326";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:3:"345";s:5:"score";s:18:"26.626865200908856";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"2329";s:5:"score";s:16:"18.8552464096505";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:3:"620";s:5:"score";s:17:"18.32825830771483";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"1487";s:5:"score";s:18:"17.631644918548528";}}
  dsq_thread_id: '3346748911'
author:
  login: larry.e.smith.jr
  email: larry.e.smith.jr@gmail.com
  display_name: mrlesmithjr
  first_name: Larry
  last_name: Smith
---
<p>If you are interested in collecting, viewing and inspecting <a title="http://en.wikipedia.org/wiki/NetFlow" href="http://en.wikipedia.org/wiki/NetFlow" target="_blank">Netflow</a> data like I am, then you will be interested in this. Netflow gives you deep level inspection into your network traffic such as source and destination of traffic, protocols and types of service, plus much more. Why is this valuable information? Maybe you are interested in the different types of traffic that are floating around on your network or possibly you are getting reports of slow network connectivity by users. So how do we get this Netflow data? First off your network devices must support exporting Netflow data to begin with, sort of anyways! This goes for any network switches, firewalls and even vSphere. The second part of gathering Netflow data is that you must have a Netflow collector installed on your network, <a title="http://ntop.org" href="http://ntop.org" target="_blank">NTOP</a> is a good open-source Netflow collector but it loses all of it's data when rebooted; however, lately I have been doing some deep level testing with several of Solarwinds products (<a title="http://www.solarwinds.com/server-application-monitor-b.aspx" href="http://www.solarwinds.com/server-application-monitor-b.aspx" target="_blank">SAM</a>, <a title="http://www.solarwinds.com/network-performance-monitor.aspx" href="http://www.solarwinds.com/network-performance-monitor.aspx" target="_blank">NPM</a>, <a title="http://www.solarwinds.com/virtualization-manager.aspx" href="http://www.solarwinds.com/virtualization-manager.aspx" target="_blank">Virtualization Manager</a>, <a title="http://www.solarwinds.com/netflow-traffic-analyzer.aspx" href="http://www.solarwinds.com/netflow-traffic-analyzer.aspx" target="_blank">NTA</a> and <a title="http://www.solarwinds.com/storage-manager.aspx" href="http://www.solarwinds.com/storage-manager.aspx" target="_blank">Storage Manager</a>); in particular, Solarwinds NTA (Netflow Traffic Analyzer). This product provides an unbelievable level of detail and is visually pleasing as well. One other thing about this product is the integration between their other products which provides a seamless view into your environment. Instead of jumping between different products that you may use and not having any sense of correlation between different elements in your environment.</p>
<p>So assuming that you are running a physical and virtual environment like I am, setting all of this up can be somewhat of a challenge. In my lab I am running a Cisco 3750G 48TS switch stack, physical PFSense firewall and three vSphere 5.5 hosts running between 30-40 VMs at any given time. So with my setup the first challenge is that my Cisco switches do not support exporting Netflow, obviously your environment may be different. So in order for me to collect netflow data from my switches you can take a look <a title="http://everythingshouldbevirtual.com/vmware-vds-rspan-port-mirroring" href="http://everythingshouldbevirtual.com/vmware-vds-rspan-port-mirroring" target="_blank">here</a> on how to create a RSPAN port mirror and send that data to a vDS (vSphere Distributed Switch) port. The difference in this article compared to the link above will be that we will not be installing or using NTOP but instead on our VM we will be using <a title="http://www.ntop.org/products/nprobe/" href="http://www.ntop.org/products/nprobe/" target="_blank">nProbe</a> (created by the same people who create NTOP). nProbe will be acting as a Netflow proxy in our setup for each device that we will be collecting Netflow data from and then forwarding onto our Solarwinds NTA. nProbe is not a free product but so far it is well worth it. There are several linux open-source (<a title="http://sourceforge.net/projects/fprobe/" href="http://sourceforge.net/projects/fprobe/" target="_blank">fprobe</a>, <a title="http://sourceforge.net/projects/ipt-netflow/" href="http://sourceforge.net/projects/ipt-netflow/" target="_blank">ipt-netflow</a> and <a title="http://www.openbsd.org/cgi-bin/man.cgi?query=pflow&amp;sektion=4&amp;manpath=OpenBSD+Current" href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflow&amp;sektion=4&amp;manpath=OpenBSD+Current" target="_blank">pflow</a>) Netflow forwarders but I have not had good success yet using with Solarwinds but I will be doing some additional testing on those as well in the near future.</p>
<p>Installing nProbe is fairly straight forward but configuring it is a little bit tricky. I chose to install nbox as well to have a good web interface to configure nProbe but you can also run it from command line if you would like to as well. Seeing as I set mine up on Ubunutu 12.04 x64 I followed the process <a title="http://www.nmon.net/apt/" href="http://www.nmon.net/apt/">here</a> to add the apt repository to simplify the installation. However I did not install everything as the link above specified. Below are the commands that I ran.</p>
<pre>sudo bash
/bin/echo -e "deb http://www.nmon.net/apt x64/\ndeb http://www.nmon.net/apt all/" &gt; /etc/apt/sources.list.d/ntop.list
apt-get update
apt-get install pfring nbox nprobe</pre>
<p>Now you should have a working web ui for nbox and you can connect by using your browser of choice and connect to https://ip.or.dns.name.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/15-06-26.png"><img class="alignnone size-medium wp-image-2350" alt="15-06-26" src="{{ site.baseurl }}/assets/15-06-26-300x213.png" width="300" height="213" /></a></p>
<p>Click Log In (The default username/password is nbox/nbox.)</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/15-08-37.png"><img class="alignnone size-medium wp-image-2351" alt="15-08-37" src="{{ site.baseurl }}/assets/15-08-37-300x245.png" width="300" height="245" /></a></p>
<p>You will now be presented with the following UI.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/15-10-22.png"><img class="alignnone size-medium wp-image-2352" alt="15-10-22" src="{{ site.baseurl }}/assets/15-10-22-300x238.png" width="300" height="238" /></a></p>
<p>We will now enable<a title="http://www.ntop.org/products/pf_ring/" href="http://www.ntop.org/products/pf_ring/" target="_blank"> PF_Ring</a>.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/15-11-56.png"><img class="alignnone size-medium wp-image-2353" alt="15-11-56" src="{{ site.baseurl }}/assets/15-11-56-300x202.png" width="300" height="202" /></a></p>
<p>Set to enabled (We will reboot after we configure nProbe).</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/15-13-17.png"><img class="alignnone size-medium wp-image-2354" alt="15-13-17" src="{{ site.baseurl }}/assets/15-13-17-300x147.png" width="300" height="147" /></a></p>
<p>Now on to configuring nProbe.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/15-16-52.png"><img class="alignnone size-medium wp-image-2355" alt="15-16-52" src="{{ site.baseurl }}/assets/15-16-52-300x153.png" width="300" height="153" /></a></p>
<p>Do not turn the Proxy on at this point.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/15-18-07.png"><img class="alignnone size-medium wp-image-2356" alt="15-18-07" src="{{ site.baseurl }}/assets/15-18-07-300x233.png" width="300" height="233" /></a></p>
<p>We will be configuring as a Proxy so click on Proxy.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/15-19-26.png"><img class="alignnone size-medium wp-image-2357" alt="15-19-26" src="{{ site.baseurl }}/assets/15-19-26-300x230.png" width="300" height="230" /></a></p>
<p>Click Enable to enable automatic startup.<br />
Enter 2055 for the Listening Port. (This is what will be capturing from our other devices on the network)<br />
Enter your Solarwinds NTA address and port (default is 2055) for the collector(s) IP: x.x.x.x:2055</p>
<p>Now under Flow Export Format choose v5.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/15-27-20.png"><img class="alignnone size-medium wp-image-2358" alt="15-27-20" src="{{ site.baseurl }}/assets/15-27-20-300x46.png" width="300" height="46" /></a></p>
<p>Now click on Flow Export Policy and scroll down and change the Input SNMP Interface ID from "Auto" to "lo" and also change the Output SNMP Interface ID from "Auto" to "eth0". (These are very important!)</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/19-23-16.png"><img class="alignnone size-medium wp-image-2361" alt="19-23-16" src="{{ site.baseurl }}/assets/19-23-16-300x161.png" width="300" height="161" /></a> <a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/19-23-33.png"><img class="alignnone size-medium wp-image-2362" alt="19-23-33" src="{{ site.baseurl }}/assets/19-23-33-300x168.png" width="300" height="168" /></a></p>
<p>Now scroll to the bottom and click "Save Changes".</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/19-26-06.png"><img class="alignnone size-medium wp-image-2363" alt="19-26-06" src="{{ site.baseurl }}/assets/19-26-06-300x110.png" width="300" height="110" /></a></p>
<p>We are now done configuring nProbe and need to enable it and then reboot. So click on Status and click "On".</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/19-29-22.png"><img class="alignnone size-medium wp-image-2364" alt="19-29-22" src="{{ site.baseurl }}/assets/19-29-22-300x237.png" width="300" height="237" /></a></p>
<p>Now select the Admin dropdown and click "Reboot".</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/19-30-52.png"><img class="alignnone size-medium wp-image-2365" alt="19-30-52" src="{{ site.baseurl }}/assets/19-30-52-300x206.png" width="300" height="206" /></a></p>
<p>Now you can head over to your Solarwinds NTA and setup your netflow node.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/11-18-44.png"><img class="alignnone size-medium wp-image-2367" alt="11-18-44" src="{{ site.baseurl }}/assets/11-18-44-300x130.png" width="300" height="130" /></a> <a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/11-19-15.png"><img class="alignnone size-medium wp-image-2368" alt="11-19-15" src="{{ site.baseurl }}/assets/11-19-15-300x185.png" width="300" height="185" /></a> <a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/11-19-28.png"><img class="alignnone size-medium wp-image-2369" alt="11-19-28" src="{{ site.baseurl }}/assets/11-19-28-300x174.png" width="300" height="174" /></a></p>
<p>&nbsp;</p>
<p>And if you followed the link above about setting up RSPAN Port Mirroring you will likely start seeing some data flowing in.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/11-19-51.png"><img class="alignnone size-medium wp-image-2370" alt="11-19-51" src="{{ site.baseurl }}/assets/11-19-51-192x300.png" width="192" height="300" /></a></p>
<p>Now we will head over to our vCenter WebUI and configure netflow on our vDS port groups.</p>
<p>Go to the networking view, select your vDS dvSwitch and right-click and click Manage Distributed Port Groups..</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/11-39-41.png"><img class="alignnone size-medium wp-image-2372" alt="11-39-41" src="{{ site.baseurl }}/assets/11-39-41-259x300.png" width="259" height="300" /></a><br />
Select Monitoring and then click Next..<br />
<a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/11-40-24.png"><img class="alignnone size-medium wp-image-2373" alt="11-40-24" src="{{ site.baseurl }}/assets/11-40-24-300x175.png" width="300" height="175" /></a><br />
Now select the port groups that you want to collect netflow on and then click Next..<br />
<a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/11-41-13.png"><img class="alignnone size-medium wp-image-2374" alt="11-41-13" src="{{ site.baseurl }}/assets/11-41-13-300x176.png" width="300" height="176" /></a><br />
Select the drop-down and choose enabled..<br />
<a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/11-41-24.png"><img class="alignnone size-medium wp-image-2375" alt="11-41-24" src="{{ site.baseurl }}/assets/11-41-24-300x176.png" width="300" height="176" /></a><br />
Click Next..<br />
<a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/11-41-33.png"><img class="alignnone size-medium wp-image-2376" alt="11-41-33" src="{{ site.baseurl }}/assets/11-41-33-300x176.png" width="300" height="176" /></a><br />
Click Finish..<br />
<a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/11-41-44.png"><img class="alignnone size-medium wp-image-2377" alt="11-41-44" src="{{ site.baseurl }}/assets/11-41-44-300x176.png" width="300" height="176" /></a><br />
Now click on the manage tab within your vDS dvSwitch and select Netflow..<br />
<a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/11-42-49.png"><img class="alignnone size-medium wp-image-2378" alt="11-42-49" src="{{ site.baseurl }}/assets/11-42-49-300x80.png" width="300" height="80" /></a><br />
Click edit..<br />
<a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/11-42-59.png"><img class="alignnone size-medium wp-image-2379" alt="11-42-59" src="{{ site.baseurl }}/assets/11-42-59-300x75.png" width="300" height="75" /></a><br />
Enter the IP of your nBox server that we just setup above and leave the default port 2055. Enter an unused IP on your network preferably on your management subnet for the Switch IP address (This is the source your nBox server will see).<br />
<a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/11-43-45.png"><img class="alignnone size-medium wp-image-2380" alt="11-43-45" src="{{ site.baseurl }}/assets/11-43-45-300x293.png" width="300" height="293" /></a><br />
Complete..<br />
<a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/11-43-58.png"><img class="alignnone size-medium wp-image-2381" alt="11-43-58" src="{{ site.baseurl }}/assets/11-43-58-300x106.png" width="300" height="106" /></a></p>
<p>Now your configuration should be complete for gathering netflow from your Cisco switches and your vSphere vDS setup. Now nProbe will be forwarding all netflow data over to your Solarwinds NTA and after a bit of time you should now start seeing some nice graphs and data of traffic on your network.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/12-02-35.png"><img class="alignnone size-medium wp-image-2382" alt="12-02-35" src="{{ site.baseurl }}/assets/12-02-35-300x218.png" width="300" height="218" /></a> <a href="http://everythingshouldbevirtual.com/wp-content/uploads/2014/02/12-02-56.png"><img class="alignnone size-medium wp-image-2383" alt="12-02-56" src="{{ site.baseurl }}/assets/12-02-56-300x171.png" width="300" height="171" /></a></p>
<p>Now you can also add other devices on your network that export Netflow, just point them to your nProbe server and let nProbe do it's job!</p>
<p>That's it...Happy Netflow'n...</p>
<p>Enjoy!</p>
