---
layout: post
title: Hey, I can DevOPS my Network too! – Define Nodes (Part 2)
date: 2015-09-07 21:25:20.000000000 -04:00
type: post
published: true
status: publish
categories:
- Ansible
- Automation
- Provisioning
- Vagrant
- Virtualization
tags:
- Ansible
- quagga
- vagrant
meta:
  _edit_last: '7644'
  _snap_forceSURL: '2'
  snap_MYURL: ''
  snapEdIT: '1'
  snapFB: s:280:"a:1:{i:0;a:9:{s:4:"doFB";s:1:"1";s:8:"postType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";}}";
  _wp_rp_related_posts_query_result_cache_expiration: '1510956737'
  _s2mail: 'yes'
  wp_github_commits_page_fields: a:3:{s:15:"gc_widget_title";s:0:"";s:11:"github_user";s:0:"";s:11:"github_repo";s:0:"";}
  _yoast_wpseo_focuskw: Hey, I can DevOPS my Network too! – Define Nodes (Part 2)
  _yoast_wpseo_metadesc: Hey, I can DevOPS my Network too! – Define Nodes (Part 2)
  _yoast_wpseo_linkdex: '71'
  snapTW: 's:336:"a:1:{i:0;a:9:{s:4:"doTW";s:1:"1";s:10:"SNAPformat";s:80:"%TITLE%
    - %URL% #everythingshouldbevirtual #DevOPS #ansible #automation #vagrant";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"641059750705106945";s:5:"pDate";s:19:"2015-09-08
    01:25:29";}}";'
  snap_isAutoPosted: '1'
  snapDL: s:242:"a:1:{i:0;a:7:{s:4:"doDL";s:1:"1";s:11:"SNAPformatT";s:7:"%TITLE%";s:10:"SNAPformat";s:9:"%EXCERPT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:32:"3550e92c1227a4fa2b84d551ba1672c9";s:5:"pDate";s:19:"2015-09-08
    01:25:21";}}";
  snapLI: s:520:"a:1:{i:0;a:13:{s:4:"doLI";s:1:"1";s:8:"postType";s:1:"A";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"SNAPformatT";s:1:" ";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:19:"6046825418600824832";s:7:"postURL";s:125:"https://www.linkedin.com/updates?discuss=&amp;scope=138895851&amp;stype=M&amp;topic=6046825418600824832&amp;type=U&amp;a=dUgE";s:5:"pDate";s:19:"2015-09-08
    01:25:24";}}";
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:4:"4915";s:5:"score";s:17:"172.9034288110952";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:4:"4944";s:5:"score";s:18:"166.23901979074483";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:4:"4934";s:5:"score";s:18:"166.23901979074483";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:4:"4886";s:5:"score";s:18:"166.23901979074483";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"4879";s:5:"score";s:18:"166.23901979074483";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"4824";s:5:"score";s:17:"121.0243549023333";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:4:"6225";s:5:"score";s:18:"118.97599855269257";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"5734";s:5:"score";s:18:"117.23420035074841";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"4803";s:5:"score";s:17:"116.6186885599833";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"4962";s:5:"score";s:18:"109.60249820653675";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:4:"5777";s:5:"score";s:17:"91.81487812342989";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"6033";s:5:"score";s:17:"70.32797583383824";}}
  snapSU: s:304:"a:1:{i:0;a:9:{s:4:"doSU";s:1:"1";s:7:"apSUCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:6:"31053d";s:7:"postURL";s:50:"http://www.stumbleupon.com/content/31053d/comments";s:5:"pDate";s:19:"2015-09-08
    01:25:29";}}";
  _wp_rp_image: '4885'
author:
  login: mrlesmithjr
  email: mrlesmithjr@gmail.com
  display_name: Larry Smith Jr.
  first_name: ''
  last_name: ''
---
<p style="text-align: center;"><strong>Hey, I can DevOPS my Network too! – Define Nodes (Part 2)</strong></p>
<p style="text-align: left;">In the <a href="http://everythingshouldbevirtual.com/hey-i-can-devops-my-network-too-prep-work-part-1">previous post</a> we prepped our environment in order to get everything ready to begin building out our environment. Which means we are now ready to finalize our node definitions to spin up our environment with Vagrant. So to begin with if you look at the drawing below, which was also shown in the intro post, and compare the drawing to our <em>nodes.yml</em> file which is in the root of the downloaded repo you will notice that router5 (r5) is missing.</p>
<p style="text-align: left;">
<p style="text-align: left;"><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2015/09/ossrouting-bgp-drawing-New-Page.png"><img class="alignnone size-medium wp-image-4883" src="{{ site.baseurl }}/assets/ossrouting-bgp-drawing-New-Page-300x232.png" alt="ossrouting-bgp-drawing - New Page" width="300" height="232" /></a></p>
<p style="text-align: left;">Below is the original <em>nodes.yml</em></p>
<pre>---
- name: r1
  box: ubuntu/trusty64
  mem: 512
  cpus: 1
  ansible_ssh_host_ip: 192.168.250.101  #HostOnly interface
  interfaces:  #Internal only interfaces
    - ip: 192.168.12.11
      auto_config: "True"
      network_name: 01-to-02
      method: static
      type: private_network
    - ip: 192.168.14.11
      auto_config: "True"
      network_name: 01-to-04
      method: static
      type: private_network
    - ip: 192.168.31.11
      auto_config: "True"
      network_name: 03-to-01
      method: static
      type: private_network
    - ip: 1.1.1.10
      auto_config: "True"
      network_name: 1-1-1
      method: static
      type: private_network
- name: r2
  box: ubuntu/trusty64
  mem: 512
  cpus: 1
  ansible_ssh_host_ip: 192.168.250.102  #HostOnly interface
  interfaces:  #Internal only interfaces
    - ip: 192.168.23.12
      auto_config: "True"
      network_name: 02-to-03
      method: static
      type: private_network
    - ip: 192.168.12.12
      auto_config: "True"
      network_name: 01-to-02
      method: static
      type: private_network
    - ip: 2.2.2.10
      auto_config: "True"
      network_name: 2-2-2
      method: static
      type: private_network
- name: r3
  box: ubuntu/trusty64
  mem: 512
  cpus: 1
  ansible_ssh_host_ip: 192.168.250.103  #HostOnly interface
  interfaces:  #Internal only interfaces
    - ip: 192.168.31.13
      auto_config: "True"
      network_name: 03-to-01
      method: static
      type: private_network
    - ip: 192.168.23.13
      auto_config: "True"
      network_name: 02-to-03
      method: static
      type: private_network
    - ip: 3.3.3.10
      auto_config: "True"
      network_name: 3-3-3
      method: static
      type: private_network
- name: r4
  box: ubuntu/trusty64
  mem: 512
  cpus: 1
  ansible_ssh_host_ip: 192.168.250.104  #HostOnly interface
  interfaces:  #Internal only interfaces
    - ip: 192.168.14.14
      auto_config: "True"
      network_name: 01-to-04
      method: static
      type: private_network
    - ip: 192.168.31.14
      auto_config: "True"
      network_name: 03-to-01
      method: static
      type: private_network
    - ip: 192.168.41.14
      auto_config: "True"
      network_name: utopia
      method: static
      type: private_network
    - ip: 4.4.4.10
      auto_config: "True"
      network_name: 4-4-4
      method: static
      type: private_network
</pre>
<p style="text-align: left;">So let's first add router5 (r5) to our <em>nodes.yml</em> file.</p>
<p style="text-align: left;">Open up <em>nodes.yml</em> with your editor of choice and add the following to the end of the file.</p>
<pre>- name: r5
  box: ubuntu/trusty64
  mem: 512
  cpus: 1
  ansible_ssh_host_ip: 192.168.250.105  #HostOnly interface
  interfaces:  #Internal only interfaces
    - ip: 192.168.15.15
      auto_config: "True"      
      network_name: 01-to-05
      method: static
      type: private_network
    - ip: 192.168.51.15
      auto_config: "True"
      network_name: utopia
      method: static
      type: private_network
    - ip: 5.5.5.10
      auto_config: "True"
      network_name: 5-5-5
      method: static
      type: private_network
</pre>
<p>If you also notice, router1 (r1) is missing the interface to connect to the newly added router5 (r5) as well. So we will need to go ahead and add that interface to router1 (r1) which is shown below in bold.</p>
<pre>- name: r1
  box: ubuntu/trusty64
  mem: 512
  cpus: 1
  ansible_ssh_host_ip: 192.168.250.101  #HostOnly interface
  interfaces:  #Internal only interfaces
    - ip: 192.168.12.11
      auto_config: "True"
      network_name: 01-to-02
      method: static
      type: private_network
    - ip: 192.168.14.11
      auto_config: "True"
      network_name: 01-to-04
      method: static
      type: private_network
<strong>    - ip: 192.168.15.11
      auto_config: "True"
      network_name: 01-to-05
      method: static
      type: private_network</strong>
    - ip: 192.168.31.11
      auto_config: "True"
      network_name: 03-to-01
      method: static
      type: private_network
    - ip: 1.1.1.10
      auto_config: "True"
      network_name: 1-1-1
      method: static
      type: private_network</pre>
<p>So now the whole <em>nodes.yml</em> file should look like below.</p>
<pre>---
- name: r1
  box: ubuntu/trusty64
  mem: 512
  cpus: 1
  ansible_ssh_host_ip: 192.168.250.101  #HostOnly interface
  interfaces:  #Internal only interfaces
    - ip: 192.168.12.11
      auto_config: "True"
      network_name: 01-to-02
      method: static
      type: private_network
    - ip: 192.168.14.11
      auto_config: "True"
      network_name: 01-to-04
      method: static
      type: private_network
    - ip: 192.168.15.11
      auto_config: "True"
      network_name: 01-to-05
      method: static
      type: private_network
    - ip: 192.168.31.11
      auto_config: "True"
      network_name: 03-to-01
      method: static
      type: private_network
    - ip: 1.1.1.10
      auto_config: "True"
      network_name: 1-1-1
      method: static
      type: private_network
- name: r2
  box: ubuntu/trusty64
  mem: 512
  cpus: 1
  ansible_ssh_host_ip: 192.168.250.102  #HostOnly interface
  interfaces:  #Internal only interfaces
    - ip: 192.168.23.12
      auto_config: "True"
      network_name: 02-to-03
      method: static
      type: private_network
    - ip: 192.168.12.12
      auto_config: "True"
      network_name: 01-to-02
      method: static
      type: private_network
    - ip: 2.2.2.10
      auto_config: "True"
      network_name: 2-2-2
      method: static
      type: private_network
- name: r3
  box: ubuntu/trusty64
  mem: 512
  cpus: 1
  ansible_ssh_host_ip: 192.168.250.103  #HostOnly interface
  interfaces:  #Internal only interfaces
    - ip: 192.168.31.13
      auto_config: "True"
      network_name: 03-to-01
      method: static
      type: private_network
    - ip: 192.168.23.13
      auto_config: "True"
      network_name: 02-to-03
      method: static
      type: private_network
    - ip: 3.3.3.10
      auto_config: "True"
      network_name: 3-3-3
      method: static
      type: private_network
- name: r4
  box: ubuntu/trusty64
  mem: 512
  cpus: 1
  ansible_ssh_host_ip: 192.168.250.104  #HostOnly interface
  interfaces:  #Internal only interfaces
    - ip: 192.168.14.14
      auto_config: "True"
      network_name: 01-to-04
      method: static
      type: private_network
    - ip: 192.168.31.14
      auto_config: "True"
      network_name: 03-to-01
      method: static
      type: private_network
    - ip: 192.168.41.14
      auto_config: "True"
      network_name: utopia
      method: static
      type: private_network
    - ip: 4.4.4.10
      auto_config: "True"
      network_name: 4-4-4
      method: static
      type: private_network
- name: r5
  box: ubuntu/trusty64
  mem: 512
  cpus: 1
  ansible_ssh_host_ip: 192.168.250.105  #HostOnly interface
  interfaces:  #Internal only interfaces
    - ip: 192.168.15.15
      auto_config: "True"
      network_name: 01-to-05
      method: static
      type: private_network
    - ip: 192.168.51.15
      auto_config: "True"
      network_name: utopia
      method: static
      type: private_network
    - ip: 5.5.5.10
      auto_config: "True"
      network_name: 5-5-5
      method: static
      type: private_network
</pre>
<p>At this point you are probably wondering what all of these settings are for in <em>nodes.yml</em>, correct? So let's go over what they are for.</p>
<ul>
<li>name: defines the name of the node that Vagrant will define as the hostname</li>
<li>box: defines the Vagrant Box that will be used as the OS for the node</li>
<li>mem: defines the amount of memory to allocate to the node</li>
<li>cpus: defines the number of vCPUS to allocate to the node</li>
<li>ansible_ssh_host_ip: defines the interface/IP that will be defined as eth1 and used for all Ansible related tasks</li>
<li>interfaces:
<ul>
<li>ip: defines the IP address for each additional interface to create</li>
<li>auto_config: defines if Vagrant should automatically configure the interface with the defined IP address. If set to False you can configure /etc/network/interfaces manually outside of Vagrant.</li>
<li>network_name: defines the internal network name that VirtualBox will place the interface on. Node interfaces need to reside on the same network_name in order to communicate internally to VirtualBox</li>
<li>method: defines if the interface should be static or dhcp</li>
<li>type: defines if interface should be NAT, Bridged, Internal ("private_network") or Host-Only...more info <a href="https://www.virtualbox.org/manual/ch06.html" target="_blank">here</a>. We are using private_network which is internal only to the nodes. Not accessible from our HostOS.</li>
</ul>
</li>
</ul>
<p>Now let's go ahead and commit our changed code to GitHub.<br />
Check the status of our local git repo.</p>
<pre>git status
........
On branch dev
Changes not staged for commit:
  (use "git add ..." to update what will be committed)
  (use "git checkout -- ..." to discard changes in working directory)

	modified:   nodes.yml

no changes added to commit (use "git add" and/or "git commit -a")
</pre>
<p>The above shows us that nodes.yml has been modified and we should commit the changes.</p>
<pre>git commit -a
</pre>
<p>Now type in a description of whatever you want...I am using "updated nodes.yml in preparation of Vagrant deployment" and save the file.</p>
<pre>[dev a06b879] updated nodes.yml in preparation of Vagrant deployment
 1 file changed, 26 insertions(+)
</pre>
<p>Now let's push our changes to GitHub into our dev branch.</p>
<pre>git push --set-upstream origin dev
.........
Counting objects: 3, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (3/3), done.
Writing objects: 100% (3/3), 413 bytes | 0 bytes/s, done.
Total 3 (delta 2), reused 0 (delta 0)
To https://github.com/everythingshouldbevirtual/vagrant-ansible-routing-template.git
   caf5002..a06b879  dev -&gt; dev
Branch dev set up to track remote branch dev from origin.
</pre>
<p>The other important file here at this time is our <em>Vagrantfile</em>. This is the file that Vagrant will use to spin up the nodes that we have defined in our <em>nodes.yml</em> file. There should not be any changes required at this time in this file. However if you do decide to make changes, make sure to commit those changes and push up to your GitHub repo. Below is what our <em>Vagrantfile</em> looks like.</p>
<pre># -*- mode: ruby -*-
# vi: set ft=ruby :

# Ensure yaml module is loaded
require 'yaml'

# Read yaml node definitions to create **Update nodes.yml to reflect any changes
nodes = YAML.load_file('nodes.yml')

Vagrant.configure(2) do |config|
#  config.ssh.insert_key = false
#  config.vm.provision :shell, path: "bootstrap.sh"

  nodes.each do |nodes|
    config.vm.define nodes["name"] do |node|
      node.vm.hostname = nodes["name"]
      node.vm.box = nodes["box"]
#      node.vm.provision :shell, path: "bootstrap_ansible.sh"
      if nodes["ansible_ssh_host_ip"] != "None"
        node.vm.network "private_network", ip: nodes["ansible_ssh_host_ip"]
      end
      ints = nodes["interfaces"]
      ints.each do |int|
        if int["method"] == "static" and int["type"] == "private_network" and int["network_name"] != "None" and int["auto_config"] == "True"
          node.vm.network "private_network", ip: int["ip"], virtualbox__intnet: int["network_name"]
        end
        if int["method"] == "static" and int["type"] == "private_network" and int["network_name"] != "None" and int["auto_config"] == "False"
          node.vm.network "private_network", ip: int["ip"], virtualbox__intnet: int["network_name"], auto_config: false
        end
        if int["method"] == "static" and int["type"] == "private_network" and int["network_name"] == "None" and int["auto_config"] == "True"
          node.vm.network "private_network", ip: int["ip"]
        end
        if int["method"] == "static" and int["type"] == "private_network" and int["network_name"] == "None" and int["auto_config"] == "False"
          node.vm.network "private_network", ip: int["ip"], auto_config: false
        end
        if int["method"] == "dhcp" and int["type"] == "private_network"
          node.vm.network "private_network", type: "dhcp"
        end
      end
      node.vm.synced_folder ".", "/vagrant"
      node.vm.provider "virtualbox" do |v|
        v.memory = nodes["mem"]
        v.cpus = nodes["cpus"]
      end
    end
  end
  config.vm.provision :ansible do |ansible|
    ansible.playbook = "bootstrap.yml"
  end
#  if Vagrant.has_plugin?("vagrant-cachier")
#    config.cache.scope = :box
#  end
end
</pre>
<p>So this concludes our node definitions which we will be using here on out for this series.</p>
<p>Up next...<a href="http://everythingshouldbevirtual.com/hey-i-can-devops-my-network-too-vagrant-up-part-3">Vagrant UP</a>...</p>
