---
layout: post
title: Creating vSphere VM's using Ansible
date: 2015-03-25 16:42:00.000000000 -04:00
type: post
published: true
status: publish
categories:
- Ansible
- Automation
tags:
- Ansible
- Vsphere
meta:
  _edit_last: '7644'
  _snap_forceSURL: '2'
  snap_MYURL: ''
  snapEdIT: '1'
  snapDL: s:242:"a:1:{i:0;a:7:{s:4:"doDL";s:1:"1";s:11:"SNAPformatT";s:7:"%TITLE%";s:10:"SNAPformat";s:9:"%EXCERPT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:32:"bd19599c55da7e22286c30c9404d57dd";s:5:"pDate";s:19:"2015-03-25
    20:42:00";}}";
  snapTW: 's:324:"a:1:{i:0;a:9:{s:4:"doTW";s:1:"1";s:10:"SNAPformat";s:68:"%TITLE%
    - %URL% #everythingshouldbevirtual #vSphere #DevOPS #Ansible";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"580832057225433088";s:5:"pDate";s:19:"2015-03-25
    20:42:08";}}";'
  _s2mail: 'yes'
  _yoast_wpseo_focuskw: Creating vSphere VM's using Ansible
  _yoast_wpseo_metadesc: Creating vSphere VM's using Ansible
  _yoast_wpseo_linkdex: '86'
  snap_isAutoPosted: '1'
  snapFB: s:280:"a:1:{i:0;a:9:{s:4:"doFB";s:1:"1";s:8:"postType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";}}";
  snapSU: s:304:"a:1:{i:0;a:9:{s:4:"doSU";s:1:"1";s:7:"apSUCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:6:"2aPSrf";s:7:"postURL";s:50:"http://www.stumbleupon.com/content/2aPSrf/comments";s:5:"pDate";s:19:"2015-03-25
    20:42:08";}}";
  _yoast_wpseo_focuskw_text_input: Creating vSphere VM's using Ansible
  _wp_rp_related_posts_query_result_cache_expiration: '1509998840'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:4:"4725";s:5:"score";s:17:"61.16240747726121";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:4:"5734";s:5:"score";s:17:"59.58549275653267";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:4:"4621";s:5:"score";s:18:"58.239603810047825";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:4:"4391";s:5:"score";s:17:"57.23434609650212";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"4420";s:5:"score";s:18:"55.329029344782185";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"4915";s:5:"score";s:17:"55.31243173920474";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:4:"4803";s:5:"score";s:17:"55.31243173920474";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"5798";s:5:"score";s:18:"55.247385355793625";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"7702";s:5:"score";s:17:"54.08072072668814";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"4386";s:5:"score";s:17:"52.92108373618227";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:4:"4962";s:5:"score";s:17:"50.56993707615171";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"4708";s:5:"score";s:17:"50.56993707615171";}}
  wp_github_commits_page_fields: a:3:{s:15:"gc_widget_title";s:0:"";s:11:"github_user";s:0:"";s:11:"github_repo";s:0:"";}
  snapLI: s:298:"a:1:{i:0;a:10:{s:4:"doLI";s:1:"1";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"SNAPformatT";s:1:" ";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"postType";s:1:"A";}}";
  _wp_rp_image: '4375'
author:
  login: larry.e.smith.jr
  email: larry.e.smith.jr@gmail.com
  display_name: mrlesmithjr
  first_name: Larry
  last_name: Smith
---
<h4>Creating vSphere VM's using Ansible</h4>
<p>I am putting this out here in case anyone else may be interested in spinning up some VM's using Ansible. I am doing this with Ansible 1.8.4 and connecting to vCenter 6.0 GA. I will be adding to this post as I add more functionality. Currently with Ansible 1.8.4 you cannot spin up VM's using templates but that is added in 1.9 which is currently only available from GitHub in the dev branch. Not what I want to use for this right now as I like to use products that are release versions for stability and consistency. :) What I will be doing in this post is spinning up 8 VM's ( 3 CentOS DB and 5 Ubuntu64 Web). Once they are spun up you will need to install the OS on them (for now).</p>
<p>We first need to create an inventory list of the servers along with some variables to be passed to our Ansible playbook which will create the VM's for us. You could easily run this from Jenkins if you want a webUI driven way to do this as well ( more on this later ).</p>
<p>Let's create our inventory list which in this example I will be calling create_vms_hosts.</p>
<pre>nano create_vms_hosts</pre>
<p>Now copy and paste the following or create your own</p>
<pre>[web-vms]
ans-web[01:05] disk='10' datastore='SSD-Pool_ELKStack_dev (NAS01)' network='vSS-OpenStack_Default' memory='256' cpucount='1' osid='ubuntu64Guest'

[db-vms]

ans-db[01:03] disk='20' datastore='SSD-Pool_ELKStack_dev (NAS01)' network='vSS-OpenStack_Default' memory='1024' cpucount='2' osid='rhel6_64Guest'</pre>
<p>What we are specifying here is the group names (web-vms and db-vms) to specify different variables for each group of servers to build. I will breakdown each variable below to put some meaning to them.<br />
ans-web[01:05] and ans-db[01:03] ---- These are the actual VM names that we will be creating. Ansible has the ability to use regex type values to represent a group of items...in this case VM names...So Ansible will be creating ans-web01 - answeb05 and ans-db01 - ans-db03 for us.</p>
<p>disk= --- is the size in GB to create for each VM<br />
datastore= --- name of the datastore to create the VMs on<br />
network= --- name of network (portgroup) to place the VMs on<br />
memory= --- the amount of memory in MB to allocate to the VMs<br />
cpucount= --- the number of vCPU's to allocate to the VMs<br />
osid= --- the OS Identifier to specify for the OS type.... reference <a title="https://www.vmware.com/support/developer/vc-sdk/visdk41pubs/ApiReference/vim.vm.GuestOsDescriptor.GuestOsIdentifier.html" href="https://www.vmware.com/support/developer/vc-sdk/visdk41pubs/ApiReference/vim.vm.GuestOsDescriptor.GuestOsIdentifier.html" target="_blank">this</a> guide for OSID's</p>
<p>Now we need to create the actual ansible playbook to run to create the VMs for us. In this case I will be calling it create_vms.yml</p>
<pre>nano create_vms.yml</pre>
<p>Now copy and paste the below and modify to suit your requirements.</p>
<pre>---
- hosts: all
  gather_facts: false
  connection: local
  user: remote
  sudo: true

  vars_prompt:
    - name: "vcenter_hostname"
      prompt: "Enter vcenter hostname"
      private: no
      default: "vcsa"
    - name: "vcenter_user"
      prompt: "Enter vcenter username"
      private: no
    - name: "vcenter_pass"
      prompt: "Enter vcenter password"
      private: yes

  vars:
    datacenter: 'everythingshouldbevirtual'
    esxi_host: 'esxi01.everythingshouldbevirtual.local'
    notes: 'Created by Ansible'

  tasks:
    - vsphere_guest:
        vcenter_hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_user }}"
        password: "{{ vcenter_pass }}"
        guest: "{{ inventory_hostname }}"
        state: present
        vm_extra_config:
          notes: "{{ notes }}"
        vm_disk:
          disk1:
            size_gb: "{{ disk }}"
            type: thin
            datastore: "{{ datastore }}"
        vm_nic:
          nic1:
            type: vmxnet3
            network: "{{ network }}"
            network_type: standard
        vm_hardware:
          memory_mb: "{{ memory }}"
          num_cpus: "{{ cpucount }}"
          osid: "{{ osid }}"
          scsi: paravirtual
        esxi:
          datacenter: "{{ datacenter }}"
          hostname: "{{ esxi_host }}"
</pre>
<p>This method will prompt for the vCenter hostname to connect to, username and password to connect to vCenter. You will want to modify the section under vars: to meet your specific requirements and naming of datacenter and esxi_host. The esxi_host is just a placeholder to initially create your VMs.</p>
<p>So with this all setup you will need to do one more thing before running this playbook and that is installing the python module for vSphere.</p>
<pre>sudo pip install pysphere</pre>
<p>Once this is installed you are now ready to run your playbook.</p>
<pre> ansible-playbook -i create_vms_hosts create_vms.yml</pre>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2015/03/Screen-Shot-2015-03-25-at-4.36.53-PM.png"><img class="alignnone size-medium wp-image-4368" src="{{ site.baseurl }}/assets/Screen-Shot-2015-03-25-at-4.36.53-PM-300x59.png" alt="Screen Shot 2015-03-25 at 4.36.53 PM" width="300" height="59" /></a><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2015/03/Screen-Shot-2015-03-25-at-4.37.28-PM.png"><img class="alignnone size-medium wp-image-4369" src="{{ site.baseurl }}/assets/Screen-Shot-2015-03-25-at-4.37.28-PM-300x178.png" alt="Screen Shot 2015-03-25 at 4.37.28 PM" width="300" height="178" /></a><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2015/03/Screen-Shot-2015-03-25-at-4.37.36-PM.png"><img class="alignnone size-medium wp-image-4370" src="{{ site.baseurl }}/assets/Screen-Shot-2015-03-25-at-4.37.36-PM-300x218.png" alt="Screen Shot 2015-03-25 at 4.37.36 PM" width="300" height="218" /></a></p>
<p>And there you have it...You have now successfully created some VMs using Ansible :)</p>
<p style="text-align: center;"><em><strong>Updated!!! 01/13/2015</strong></em></p>
<p>Here is a newer updated playbook to create VMs.</p>
<p>https://gist.github.com/mrlesmithjr/975dfefe3367345d6ca8</p>
<p>Enjoy!</p>
