---
layout: post
title: Vagrant - Multi-NIC Definitions via YAML
date: 2015-08-27 22:42:13.000000000 -04:00
type: post
published: true
status: publish
categories:
- Provisioning
- Vagrant
tags:
- vagrant
meta:
  _edit_last: '7644'
  _snap_forceSURL: '2'
  snap_MYURL: ''
  snapEdIT: '1'
  snapFB: s:280:"a:1:{i:0;a:9:{s:4:"doFB";s:1:"1";s:8:"postType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";}}";
  _s2mail: 'yes'
  wp_github_commits_page_fields: a:3:{s:15:"gc_widget_title";s:0:"";s:11:"github_user";s:0:"";s:11:"github_repo";s:0:"";}
  _yoast_wpseo_focuskw: Vagrant - Multi-NIC Definitions via YAML
  _yoast_wpseo_metadesc: Vagrant - Multi-NIC Definitions via YAML
  _yoast_wpseo_linkdex: '75'
  snap_isAutoPosted: '1'
  snapDL: s:242:"a:1:{i:0;a:7:{s:4:"doDL";s:1:"1";s:11:"SNAPformatT";s:7:"%TITLE%";s:10:"SNAPformat";s:9:"%EXCERPT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:32:"15c06a69e73d31289920f89a9cc5ac00";s:5:"pDate";s:19:"2015-08-28
    02:42:14";}}";
  snapLI: s:520:"a:1:{i:0;a:13:{s:4:"doLI";s:1:"1";s:8:"postType";s:1:"A";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"SNAPformatT";s:1:" ";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:19:"6042858501007503360";s:7:"postURL";s:125:"https://www.linkedin.com/updates?discuss=&amp;scope=138895851&amp;stype=M&amp;topic=6042858501007503360&amp;type=U&amp;a=AIxO";s:5:"pDate";s:19:"2015-08-28
    02:42:17";}}";
  snapSU: s:304:"a:1:{i:0;a:9:{s:4:"doSU";s:1:"1";s:7:"apSUCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:6:"1MGOGo";s:7:"postURL";s:50:"http://www.stumbleupon.com/content/1MGOGo/comments";s:5:"pDate";s:19:"2015-08-28
    02:42:24";}}";
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:4:"4902";s:5:"score";s:17:"121.0243549023333";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:4:"6033";s:5:"score";s:17:"84.99641167065522";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:4:"4915";s:5:"score";s:17:"84.35950420841814";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:4:"4803";s:5:"score";s:17:"82.66490848765673";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"6225";s:5:"score";s:17:"77.99036718578375";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"5777";s:5:"score";s:16:"76.6600877031723";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:4:"4944";s:5:"score";s:17:"76.00049946730633";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"4886";s:5:"score";s:17:"68.43212019946981";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"4962";s:5:"score";s:16:"67.6188845080328";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"4934";s:5:"score";s:17:"67.43413786787468";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:4:"4879";s:5:"score";s:17:"64.02464168284587";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"5734";s:5:"score";s:17:"61.09377856358199";}}
  _wp_rp_related_posts_query_result_cache_expiration: '1511600130'
  snapTW: 's:327:"a:1:{i:0;a:9:{s:4:"doTW";s:1:"1";s:10:"SNAPformat";s:71:"%TITLE%
    - %URL% #everythingshouldbevirtual #vagrant #DevOps #automation";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"637092840674201600";s:5:"pDate";s:19:"2015-08-28
    02:42:24";}}";'
  _wp_rp_image: empty
author:
  login: mrlesmithjr
  email: mrlesmithjr@gmail.com
  display_name: Larry Smith Jr.
  first_name: ''
  last_name: ''
---
<p style="text-align: center;"><strong>Vagrant - Multi-NIC Definitions via YAML</strong></p>
<p style="text-align: left;">I am currently working on a little routing project to use as a learning toolÂ for others to easily consume by using Vagrant and Ansible (Inspired by <a href="http://keepingitclassless.net/2015/06/open-source-routing-practical/">this</a> post by <a href="https://twitter.com/Mierdin">Matt Oswalt</a> with added functionality) and came across a hard to find solution, so I figured I would share this. I am using a nodes.yml file to define the nodes to spin up using Vagrant and had a need to define a different number of interfaces per node. Now I know this is pretty easy when defining everything in your Vagrantfile but I want this to be a little more dynamic by only needing to make changes to a yaml file which is loaded via Vagrant when spinning up.</p>
<p style="text-align: left;"><strong><em>nodes.yml</em></strong></p>
<pre>---
- name: r1
  box: ubuntu/trusty64
  mem: 512
  cpus: 1
  priv_ip_1: 192.168.250.101  #HostOnly interface
  priv_ips:  #Internal only interfaces
    - ip: 192.168.12.11
      desc: 01-to-02
    - ip: 192.168.14.11
      desc: 01-to-04
    - ip: 192.168.31.11
      desc: 03-to-01
    - ip: 1.1.1.10
      desc: 'Network to Advertise'
- name: r2
  box: ubuntu/trusty64
  mem: 512
  cpus: 1
  priv_ip_1: 192.168.250.102  #HostOnly interface
  priv_ips:  #Internal only interfaces
    - ip: 192.168.23.12
      desc: 02-to-03
    - ip: 192.168.12.12
      desc: 01-to-02
    - ip: 2.2.2.10
      desc: 'Network to Advertise'
- name: r3
  box: ubuntu/trusty64
  mem: 512
  cpus: 1
  priv_ip_1: 192.168.250.103  #HostOnly interface
  priv_ips:  #Internal only interfaces
    - ip: 192.168.31.13
      desc: 03-to-01
    - ip: 192.168.23.13
      desc: 02-to-03
    - ip: 3.3.3.10
      desc: 'Network to Advertise'
- name: r4
  box: ubuntu/trusty64
  mem: 512
  cpus: 1
  priv_ip_1: 192.168.250.104  #HostOnly interface
  priv_ips:  #Internal only interfaces
    - ip: 192.168.14.14
      desc: 01-to-04
    - ip: 192.168.31.14
      desc: 03-to-01
    - ip: 192.168.41.14
      desc: utopia
    - ip: 4.4.4.10
      desc: 'Network to Advertise'
</pre>
<p>As you can see above the <em>priv_ip_1</em> is the same on each node which creates a HostOnly interface, however; the <em>priv_ips</em> definition is where I am defining multiple different internal links and some routers will have more than others depending on your topology.<br />
Below is the corresponding Vagrantfile to spin up these nodes.</p>
<p><em><strong>Vagrantfile</strong></em></p>
<pre># -*- mode: ruby -*-
# vi: set ft=ruby :

# Ensure yaml module is loaded
require 'yaml'

# Read yaml node definitions to create **Update nodes.yml to reflect any changes
nodes = YAML.load_file('nodes.yml')

Vagrant.configure(2) do |config|
#  config.ssh.insert_key = false
#  config.vm.provision :shell, path: "bootstrap.sh"

  nodes.each do |nodes|
    config.vm.define nodes["name"] do |node|
      node.vm.hostname = nodes["name"]
      node.vm.box = nodes["box"]
#      node.vm.provision :shell, path: "bootstrap_ansible.sh"
      node.vm.network "private_network", ip: nodes["priv_ip_1"]
<strong>      ints = nodes["priv_ips"]
      ints.each do |int|
        node.vm.network "private_network", ip: int["ip"], virtualbox__intnet: int["desc"]
      end</strong>
      node.vm.synced_folder ".", "/vagrant"
      node.vm.provider "virtualbox" do |v|
        v.memory = nodes["mem"]
        v.cpus = nodes["cpus"]
      end
    end
  end
  config.vm.provision :ansible do |ansible|
    ansible.playbook = "bootstrap.yml"
  end
#  if Vagrant.has_plugin?("vagrant-cachier")
#    config.cache.scope = :box
#  end
end
</pre>
<p>The highlighted section above is the magic behind what I needed to do. Hopefully this will help others out as well if searching for such.</p>
<blockquote><p>****Update ****</p></blockquote>
<p>After doing a demo for some of my internal team members some additional ideas came from all of this. I have changed up the nodes.yml and Vagrantfile to get a little more granular and used different variables to make things a little clearer. So I am adding to this post to show the additional ways of doing this.</p>
<p><em><strong>nodes.yml</strong></em></p>
<pre>---
# Keep in mind....Vagrant will always create an initial interface as a NAT interface..Any definitions below are for adding additional interfaces.
# for network_name define a var other than remaining blank to define an internal only network. Otherwise leave blank for a host-only network.
# for DHCP leave ip and network_name vars blank
# for Static define ip var
# type should generally be private_network..Other option(s) are: public_network
- name: node-1
  box: ubuntu/trusty64
  mem: 512
  cpus: 2
  ansible_ssh_host_ip: 192.168.202.33 #always create for Ansible provisioning within nodes
  interfaces:  #Define additional interface settings
    - ip: 192.168.12.11
      auto_config: "True"
      network_name: 01-to-02
      method: static
      type: private_network
    - ip: 192.168.14.11
      auto_config: "True"
      network_name:
      method: static
      type: private_network
    - ip: 192.168.15.11
      auto_config: "False"
      network_name: 01-to-05
      method: static
      type: private_network
    - ip:
      auto_config: "True"
      network_name:
      method: dhcp
      type: private_network
</pre>
<p><em><strong>Vagrantfile</strong></em></p>
<pre># -*- mode: ruby -*-
# vi: set ft=ruby :

# Ensure yaml module is loaded
require 'yaml'

# Read yaml node definitions to create **Update nodes.yml to reflect any changes
nodes = YAML.load_file('nodes.yml')

Vagrant.configure(2) do |config|
#  config.ssh.insert_key = false
#  config.vm.provision :shell, path: "bootstrap.sh"

  nodes.each do |nodes|
    config.vm.define nodes["name"] do |node|
      node.vm.hostname = nodes["name"]
      node.vm.box = nodes["box"]
#      node.vm.provision :shell, path: "bootstrap_ansible.sh"
      if nodes["ansible_ssh_host_ip"] != "None"
        node.vm.network "private_network", ip: nodes["ansible_ssh_host_ip"]
      end
<strong>      ints = nodes["interfaces"]
      ints.each do |int|
        if int["method"] == "static" and int["type"] == "private_network" and int["network_name"] != "None" and int["auto_config"] == "True"
          node.vm.network "private_network", ip: int["ip"], virtualbox__intnet: int["network_name"]
        end
        if int["method"] == "static" and int["type"] == "private_network" and int["network_name"] != "None" and int["auto_config"] == "False"
          node.vm.network "private_network", ip: int["ip"], virtualbox__intnet: int["network_name"], auto_config: false
        end
        if int["method"] == "static" and int["type"] == "private_network" and int["network_name"] == "None" and int["auto_config"] == "True"
          node.vm.network "private_network", ip: int["ip"]
        end
        if int["method"] == "static" and int["type"] == "private_network" and int["network_name"] == "None" and int["auto_config"] == "False"
          node.vm.network "private_network", ip: int["ip"], auto_config: false
        end
        if int["method"] == "dhcp" and int["type"] == "private_network"
          node.vm.network "private_network", type: "dhcp"
        end
      end</strong>
      node.vm.synced_folder ".", "/vagrant"
      node.vm.provider "virtualbox" do |v|
        v.memory = nodes["mem"]
        v.cpus = nodes["cpus"]
      end
    end
  end
#  config.vm.provision :ansible do |ansible|
#    ansible.playbook = "bootstrap.yml"
#  end
#  if Vagrant.has_plugin?("vagrant-cachier")
#    config.cache.scope = :box
#  end
end
</pre>
<p>Enjoy!</p>
