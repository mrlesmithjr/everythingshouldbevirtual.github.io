---
layout: post
title: Ansible - Discover and Backup PowerDNS Zones/Records
date: 2015-10-10 16:54:34.000000000 -04:00
type: post
published: true
status: publish
categories:
- Ansible
- Automation
tags:
- Ansible
- powerdns
meta:
  _s2mail: 'yes'
  wp_github_commits_page_fields: a:3:{s:15:"gc_widget_title";s:0:"";s:11:"github_user";s:0:"";s:11:"github_repo";s:0:"";}
  snap_MYURL: ''
  _yoast_wpseo_linkdex: '74'
  _edit_last: '7644'
  _snap_forceSURL: '2'
  snapEdIT: '1'
  snapFB: s:280:"a:1:{i:0;a:9:{s:4:"doFB";s:1:"1";s:8:"postType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";}}";
  snapLI: s:271:"a:1:{i:0;a:9:{s:4:"doLI";s:1:"1";s:8:"postType";s:1:"A";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"SNAPformatT";s:1:" ";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";}}";
  _yoast_wpseo_focuskw: Ansible - Discover and Backup PowerDNS Zones/Records
  _yoast_wpseo_metadesc: Ansible - Discover and Backup PowerDNS Zones/Records
  snap_isAutoPosted: '1'
  snapDL: s:242:"a:1:{i:0;a:7:{s:4:"doDL";s:1:"1";s:11:"SNAPformatT";s:7:"%TITLE%";s:10:"SNAPformat";s:9:"%EXCERPT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:32:"0d398da27c72511b9acf7d7fb3f1db8c";s:5:"pDate";s:19:"2015-10-10
    20:54:43";}}";
  snapSU: s:304:"a:1:{i:0;a:9:{s:4:"doSU";s:1:"1";s:7:"apSUCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:6:"7TMjsd";s:7:"postURL";s:50:"http://www.stumbleupon.com/content/7TMjsd/comments";s:5:"pDate";s:19:"2015-10-10
    20:54:52";}}";
  _wp_rp_related_posts_query_result_cache_expiration: '1509907692'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:4:"6367";s:5:"score";s:17:"77.12616018842574";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:4:"4619";s:5:"score";s:17:"65.78060702454493";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:4:"4648";s:5:"score";s:18:"59.736507860815195";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:4:"4695";s:5:"score";s:18:"58.326544584401304";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"7702";s:5:"score";s:17:"57.90392639706688";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"4708";s:5:"score";s:17:"56.77329877904468";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:4:"4431";s:5:"score";s:17:"56.65204953532091";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"4934";s:5:"score";s:17:"56.29097466588493";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"4391";s:5:"score";s:17:"56.29097466588493";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"4713";s:5:"score";s:18:"54.032206770650276";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:4:"4386";s:5:"score";s:17:"52.88147848085614";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"6657";s:5:"score";s:17:"51.88951831630902";}}
  snapTW: 's:337:"a:1:{i:0;a:9:{s:4:"doTW";s:1:"1";s:10:"SNAPformat";s:81:"%TITLE%
    - %URL% #everythingshouldbevirtual #ansible #powerdns #devops #automation";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"652950447880192001";s:5:"pDate";s:19:"2015-10-10
    20:54:52";}}";'
  _wp_rp_image: empty
author:
  login: mrlesmithjr
  email: mrlesmithjr@gmail.com
  display_name: Larry Smith Jr.
  first_name: ''
  last_name: ''
---
<p style="text-align: center;"><strong>Ansible - Discover and Backup PowerDNS Zones/Records</strong></p>
<p style="text-align: left;">While working on a solution that requires <a href="https://www.powerdns.com/" target="_blank">PowerDNS</a>, I have come to a point in which I would like to include backup and recovery options for this solution. So I figured I would share these options and possibly help out others. I will keep this post short as there really is not anything to it. Another post will be forthcoming which will cover recovering from a disaster. Again, we will be leveraging Ansible to provide all of this</p>
<p style="text-align: left;">There are actually two Ansible playbooks that are required to be ran but I will wrap this up in a shell script for simplicity. I have created these playbooks to run locally from where they are executed and leverage the <a href="https://doc.powerdns.com/md/httpapi/README/" target="_blank">PowerDNS API</a>.</p>
<p style="text-align: left;">The first playbook connects to the PowerDNS API and discovers all zones created on the server.</p>
<pre>---
- hosts: localhost
  connection: local
  sudo: false
  vars:
    - pdns_api_key: changeme
    - pdns_api_web_url: 127.0.0.1
    - pdns_webserver_port: 8081
    - zones_dir: pdns_zone_backups
  tasks:
    - name: checking for zones_dir
      stat: path={{ zones_dir }}
      register: zones_dir_check

    - name: creating zones_dir if not exist
      file: path={{ zones_dir }} state=directory
      when: not zones_dir_check.stat.exists

    - name: gathering zones
      shell: "curl -H 'X-API-Key: {{ pdns_api_key }}' http://{{ pdns_api_web_url }}:{{ pdns_webserver_port }}/servers/localhost/zones | jq . &gt; {{ zones_dir }}/pdns_zones_query.yml"

    - name: parsing zone names
      shell: "cat {{ zones_dir }}/pdns_zones_query.yml | grep name &gt; {{ zones_dir }}/pdns_zones_query_names.yml"

    - name: cleaning up zone names
      replace: dest={{ zones_dir }}/pdns_zones_query_names.yml regexp="^    \"name\"{{ ':' }} \"" replace="  - "

    - name: cleaning up zones names
      replace: dest={{ zones_dir }}/pdns_zones_query_names.yml regexp="," replace=""

    - name: cleaning up zones names
      replace: dest={{ zones_dir }}/pdns_zones_query_names.yml regexp="\"" replace=""

    - name: making file yaml with vars
      lineinfile: dest={{ zones_dir }}/pdns_zones_query_names.yml line={{ item }} insertafter=BOF
      with_items:
        - "pdns_zones_query_names:"
        - "---"
</pre>
<p>The above will create a folder pdns_zone_backups with two files initially (pdns_zones_query.yml and pdns_zones_query_names.yml). Examples are below.<br />
<strong><em>pdns_zones_query.yml</em></strong></p>
<pre>[
  {
    "last_check": 0,
    "notified_serial": 0,
    "id": "=5Fmsdcs.vagrant.local.",
    "url": "/servers/localhost/zones/=5Fmsdcs.vagrant.local.",
    "name": "_msdcs.vagrant.local",
    "kind": "Native",
    "dnssec": false,
    "account": "",
    "masters": [],
    "serial": 2015101001
  },
  {
    "last_check": 0,
    "notified_serial": 0,
    "id": "=5Fsites.vagrant.local.",
    "url": "/servers/localhost/zones/=5Fsites.vagrant.local.",
    "name": "_sites.vagrant.local",
    "kind": "Native",
    "dnssec": false,
    "account": "",
    "masters": [],
    "serial": 2015101001
  },
  {
    "last_check": 0,
    "notified_serial": 0,
    "id": "=5Ftcp.vagrant.local.",
    "url": "/servers/localhost/zones/=5Ftcp.vagrant.local.",
    "name": "_tcp.vagrant.local",
    "kind": "Native",
    "dnssec": false,
    "account": "",
    "masters": [],
    "serial": 2015101001
  },
  {
    "last_check": 0,
    "notified_serial": 0,
    "id": "=5Fudp.vagrant.local.",
    "url": "/servers/localhost/zones/=5Fudp.vagrant.local.",
    "name": "_udp.vagrant.local",
    "kind": "Native",
    "dnssec": false,
    "account": "",
    "masters": [],
    "serial": 2015101001
  },
  {
    "last_check": 0,
    "notified_serial": 0,
    "id": "vagrant.local.",
    "url": "/servers/localhost/zones/vagrant.local.",
    "name": "vagrant.local",
    "kind": "Native",
    "dnssec": false,
    "account": "",
    "masters": [],
    "serial": 2015101001
  },
  {
    "last_check": 0,
    "notified_serial": 0,
    "id": "0.0.10.in-addr.arpa.",
    "url": "/servers/localhost/zones/0.0.10.in-addr.arpa.",
    "name": "0.0.10.in-addr.arpa",
    "kind": "Native",
    "dnssec": false,
    "account": "",
    "masters": [],
    "serial": 2015101001
  },
  {
    "last_check": 0,
    "notified_serial": 0,
    "id": "2.0.10.in-addr.arpa.",
    "url": "/servers/localhost/zones/2.0.10.in-addr.arpa.",
    "name": "2.0.10.in-addr.arpa",
    "kind": "Native",
    "dnssec": false,
    "account": "",
    "masters": [],
    "serial": 2015101001
  },
  {
    "last_check": 0,
    "notified_serial": 0,
    "id": "101.0.10.in-addr.arpa.",
    "url": "/servers/localhost/zones/101.0.10.in-addr.arpa.",
    "name": "101.0.10.in-addr.arpa",
    "kind": "Native",
    "dnssec": false,
    "account": "",
    "masters": [],
    "serial": 2015101001
  },
  {
    "last_check": 0,
    "notified_serial": 0,
    "id": "106.0.10.in-addr.arpa.",
    "url": "/servers/localhost/zones/106.0.10.in-addr.arpa.",
    "name": "106.0.10.in-addr.arpa",
    "kind": "Native",
    "dnssec": false,
    "account": "",
    "masters": [],
    "serial": 2015101001
  },
  {
    "last_check": 0,
    "notified_serial": 0,
    "id": "107.0.10.in-addr.arpa.",
    "url": "/servers/localhost/zones/107.0.10.in-addr.arpa.",
    "name": "107.0.10.in-addr.arpa",
    "kind": "Native",
    "dnssec": false,
    "account": "",
    "masters": [],
    "serial": 2015101001
  },
  {
    "last_check": 0,
    "notified_serial": 0,
    "id": "110.0.10.in-addr.arpa.",
    "url": "/servers/localhost/zones/110.0.10.in-addr.arpa.",
    "name": "110.0.10.in-addr.arpa",
    "kind": "Native",
    "dnssec": false,
    "account": "",
    "masters": [],
    "serial": 2015101001
  },
  {
    "last_check": 0,
    "notified_serial": 0,
    "id": "125.0.10.in-addr.arpa.",
    "url": "/servers/localhost/zones/125.0.10.in-addr.arpa.",
    "name": "125.0.10.in-addr.arpa",
    "kind": "Native",
    "dnssec": false,
    "account": "",
    "masters": [],
    "serial": 2015101001
  },
  {
    "last_check": 0,
    "notified_serial": 0,
    "id": "10.10.10.in-addr.arpa.",
    "url": "/servers/localhost/zones/10.10.10.in-addr.arpa.",
    "name": "10.10.10.in-addr.arpa",
    "kind": "Native",
    "dnssec": false,
    "account": "",
    "masters": [],
    "serial": 2015101001
  },
  {
    "last_check": 0,
    "notified_serial": 0,
    "id": "24.16.172.in-addr.arpa.",
    "url": "/servers/localhost/zones/24.16.172.in-addr.arpa.",
    "name": "24.16.172.in-addr.arpa",
    "kind": "Native",
    "dnssec": false,
    "account": "",
    "masters": [],
    "serial": 2015101001
  },
  {
    "last_check": 0,
    "notified_serial": 0,
    "id": "1.168.192.in-addr.arpa.",
    "url": "/servers/localhost/zones/1.168.192.in-addr.arpa.",
    "name": "1.168.192.in-addr.arpa",
    "kind": "Native",
    "dnssec": false,
    "account": "",
    "masters": [],
    "serial": 2015101001
  },
  {
    "last_check": 0,
    "notified_serial": 0,
    "id": "70.168.192.in-addr.arpa.",
    "url": "/servers/localhost/zones/70.168.192.in-addr.arpa.",
    "name": "70.168.192.in-addr.arpa",
    "kind": "Native",
    "dnssec": false,
    "account": "",
    "masters": [],
    "serial": 2015101001
  },
  {
    "last_check": 0,
    "notified_serial": 0,
    "id": "200.168.192.in-addr.arpa.",
    "url": "/servers/localhost/zones/200.168.192.in-addr.arpa.",
    "name": "200.168.192.in-addr.arpa",
    "kind": "Native",
    "dnssec": false,
    "account": "",
    "masters": [],
    "serial": 2015101001
  }
]
</pre>
<p>From the above above information after running through Ansible we end up with a usable list to use as a variable for our next Ansible playbook. Example below.</p>
<p><em><strong>pdns_query_zones_names.yml</strong></em></p>
<pre>---
pdns_zones_query_names:
  - _msdcs.vagrant.local
  - _sites.vagrant.local
  - _tcp.vagrant.local
  - _udp.vagrant.local
  - vagrant.local
  - 0.0.10.in-addr.arpa
  - 2.0.10.in-addr.arpa
  - 101.0.10.in-addr.arpa
  - 106.0.10.in-addr.arpa
  - 107.0.10.in-addr.arpa
  - 110.0.10.in-addr.arpa
  - 125.0.10.in-addr.arpa
  - 10.10.10.in-addr.arpa
  - 24.16.172.in-addr.arpa
  - 1.168.192.in-addr.arpa
  - 70.168.192.in-addr.arpa
  - 200.168.192.in-addr.arpa
</pre>
<p>Now we are ready to use the above variable list for our next Ansible playbook which will connect back to the PowerDNS API, query all records for each zone and back them up. Our next playbook looks like below.</p>
<pre>---
- hosts: localhost
  connection: local
  sudo: false
  vars:
    - pdns_api_key: changeme
    - pdns_api_web_url: 127.0.0.1
    - pdns_webserver_port: 8081
    - zones_dir: pdns_zone_backups
  vars_files:
    - "{{ zones_dir }}/pdns_zones_query_names.yml"
  tasks:
    - name: creating zone folders
      file: path={{ zones_dir }}/{{ item }} state=directory
      with_items: pdns_zones_query_names

    - name: pulling records for zones
      shell: "curl -H 'X-API-Key: {{ pdns_api_key }}' http://{{ pdns_api_web_url }}:{{ pdns_webserver_port }}/servers/localhost/zones/{{ item }} | jq . &gt; {{ zones_dir }}/{{ item }}/{{ item }}.yml"
      with_items: pdns_zones_query_names
</pre>
<p>And once the above runs we will now have a folder structure that looks like below, which includes all of our zones created as folders and then all of our records created as a file for each zone.</p>
<pre>|-- pdns_zone_backups
|   |-- 0.0.10.in-addr.arpa
|   |   `-- 0.0.10.in-addr.arpa.yml
|   |-- 10.10.10.in-addr.arpa
|   |   `-- 10.10.10.in-addr.arpa.yml
|   |-- 101.0.10.in-addr.arpa
|   |   `-- 101.0.10.in-addr.arpa.yml
|   |-- 106.0.10.in-addr.arpa
|   |   `-- 106.0.10.in-addr.arpa.yml
|   |-- 107.0.10.in-addr.arpa
|   |   `-- 107.0.10.in-addr.arpa.yml
|   |-- 110.0.10.in-addr.arpa
|   |   `-- 110.0.10.in-addr.arpa.yml
|   |-- 1.168.192.in-addr.arpa
|   |   `-- 1.168.192.in-addr.arpa.yml
|   |-- 125.0.10.in-addr.arpa
|   |   `-- 125.0.10.in-addr.arpa.yml
|   |-- 200.168.192.in-addr.arpa
|   |   `-- 200.168.192.in-addr.arpa.yml
|   |-- 2.0.10.in-addr.arpa
|   |   `-- 2.0.10.in-addr.arpa.yml
|   |-- 24.16.172.in-addr.arpa
|   |   `-- 24.16.172.in-addr.arpa.yml
|   |-- 70.168.192.in-addr.arpa
|   |   `-- 70.168.192.in-addr.arpa.yml
|   |-- _msdcs.vagrant.local
|   |   `-- _msdcs.vagrant.local.yml
|   |-- pdns_zones_query_names.yml
|   |-- pdns_zones_query.yml
|   |-- _sites.vagrant.local
|   |   `-- _sites.vagrant.local.yml
|   |-- _tcp.vagrant.local
|   |   `-- _tcp.vagrant.local.yml
|   |-- _udp.vagrant.local
|   |   `-- _udp.vagrant.local.yml
|   `-- vagrant.local
|       `-- vagrant.local.yml
</pre>
<p>And if we take a look at our <em>vagrant.local/vagrant.local.yml</em> file for example.</p>
<pre>{
  "comments": [],
  "records": [
    {
      "content": "192.168.70.241",
      "disabled": false,
      "ttl": 3600,
      "type": "A",
      "name": "dns.vagrant.local"
    },
    {
      "content": "10.0.101.60",
      "disabled": false,
      "ttl": 3600,
      "type": "A",
      "name": "logstash.vagrant.local"
    },
    {
      "content": "dns.vagrant.local",
      "disabled": false,
      "ttl": 3600,
      "type": "CNAME",
      "name": "ntp1.vagrant.local"
    },
    {
      "content": "ns1.vagrant.local",
      "disabled": false,
      "ttl": 3600,
      "type": "NS",
      "name": "vagrant.local"
    },
    {
      "content": "ns2.vagrant.local",
      "disabled": false,
      "ttl": 3600,
      "type": "NS",
      "name": "vagrant.local"
    },
    {
      "content": "node-1.vagrant.local hostmaster.vagrant.local 2015101001 10800 3600 604800 3600",
      "disabled": false,
      "ttl": 3600,
      "type": "SOA",
      "name": "vagrant.local"
    },
    {
      "content": "10.0.101.40",
      "disabled": false,
      "ttl": 3600,
      "type": "A",
      "name": "vcsa.vagrant.local"
    }
  ],
  "soa_edit": "",
  "soa_edit_api": "",
  "last_check": 0,
  "notified_serial": 0,
  "id": "vagrant.local.",
  "url": "/servers/localhost/zones/vagrant.local.",
  "name": "vagrant.local",
  "kind": "Native",
  "dnssec": false,
  "account": "",
  "masters": [],
  "serial": 2015101001
}
</pre>
<p>As you can see from everything above it is actually quite simple to accomplish our backups of zones/records from our PowerDNS server(s). Now these tasks could be scheduled to run as a cron job, Jenkins job or any other method. We can also incorporate these backups into our version control utilizing Git. Again, all of these tasks we would want to automate (more on this in a later post).</p>
<p>Looking for an Ansible playbook to install PowerDNS? Go <a href="https://galaxy.ansible.com/list#/roles/4687" target="_blank">here</a>.</p>
<p>Up next will be how we can restore our zones/records from these backups.</p>
<p>Enjoy!</p>
