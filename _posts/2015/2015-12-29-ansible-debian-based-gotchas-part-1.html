---
layout: post
title: Ansible - Debian Based Gotchas - Part-1
date: 2015-12-29 21:20:18.000000000 -05:00
type: post
published: true
status: publish
categories:
- Ansible
- Automation
- Debian
- Linux
- Ubuntu
tags:
- Ansible
- debian
- ubuntu
meta:
  _wp_rp_image: empty
  _edit_last: '7644'
  _oembed_5f53b6023613cad526b661891d0bb16c: "{{unknown}}"
  _snap_forceSURL: '2'
  snap_MYURL: ''
  snapEdIT: '1'
  snapFB: s:280:"a:1:{i:0;a:9:{s:4:"doFB";s:1:"1";s:8:"postType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";}}";
  snap_isAutoPosted: '1'
  snapDL: s:242:"a:1:{i:0;a:7:{s:4:"doDL";s:1:"1";s:11:"SNAPformatT";s:7:"%TITLE%";s:10:"SNAPformat";s:9:"%EXCERPT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:32:"3c54fab1a85495ff5c3d64cb93911793";s:5:"pDate";s:19:"2015-12-30
    02:20:19";}}";
  _s2mail: 'yes'
  wp_github_commits_page_fields: a:3:{s:15:"gc_widget_title";s:0:"";s:11:"github_user";s:0:"";s:11:"github_repo";s:0:"";}
  _yoast_wpseo_focuskw_text_input: Ansible - Debian Based Gotchas
  _yoast_wpseo_focuskw: Ansible - Debian Based Gotchas
  _yoast_wpseo_linkdex: '69'
  snapSU: s:304:"a:1:{i:0;a:9:{s:4:"doSU";s:1:"1";s:7:"apSUCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:6:"73wL8j";s:7:"postURL";s:50:"http://www.stumbleupon.com/content/73wL8j/comments";s:5:"pDate";s:19:"2015-12-30
    02:20:31";}}";
  _wp_rp_related_posts_query_result_cache_expiration: '1511894091'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:4:"7208";s:5:"score";s:18:"148.14219866347585";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:3:"699";s:5:"score";s:18:"119.24837023854909";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:4:"1815";s:5:"score";s:17:"87.92867266106826";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:4:"4695";s:5:"score";s:17:"69.69783051905691";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"2254";s:5:"score";s:17:"68.06909519552937";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"7243";s:5:"score";s:16:"65.4244409849317";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:4:"2646";s:5:"score";s:17:"63.98017154996175";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"3249";s:5:"score";s:17:"63.71310876484216";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"2626";s:5:"score";s:17:"63.71310876484216";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"2586";s:5:"score";s:17:"63.71310876484216";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:3:"729";s:5:"score";s:17:"62.71931013704314";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"4725";s:5:"score";s:17:"60.42396782759849";}}
  snapLI: s:271:"a:1:{i:0;a:9:{s:4:"doLI";s:1:"1";s:8:"postType";s:1:"A";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"SNAPformatT";s:1:" ";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";}}";
  snapTW: 's:343:"a:1:{i:0;a:9:{s:4:"doTW";s:1:"1";s:10:"SNAPformat";s:87:"%TITLE%
    - %URL% #everythingshouldbevirtual #automation #ansible #debian #ubuntu #DevOPs";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"682023428665118720";s:5:"pDate";s:19:"2015-12-30
    02:20:31";}}";'
author:
  login: mrlesmithjr
  email: mrlesmithjr@gmail.com
  display_name: Larry Smith Jr.
  first_name: ''
  last_name: ''
---
<blockquote>
<p style="text-align: center;"><strong>Ansible - Debian Based Gotchas - Part-1</strong></p>
</blockquote>
<p style="text-align: left;">As I am currently running through some Docker setups between Debian Jessie and Ubuntu Trusty using Ansible I ran into a few gotchas. Now I would have assumed that everything SHOULD be identical but not so much. With this being said, I figured I would begin to start putting some context around some gotchas that I run into from time to time. And hopefully this will help out others as well.</p>
<blockquote><p><strong>Docker</strong></p>
<hr />
<p>&nbsp;</p></blockquote>
<p>When using the following task which is part of this Ansible role for Docker. ( <a href="https://github.com/mrlesmithjr/ansible-docker" target="_blank">https://github.com/mrlesmithjr/ansible-docker</a> )<br />
<a href="https://raw.githubusercontent.com/mrlesmithjr/ansible-docker/master/tasks/debian.yml" target="_blank">https://raw.githubusercontent.com/mrlesmithjr/ansible-docker/master/tasks/debian.yml</a><br />
First thing I found was that for some reason when installing python-pip using APT it caused issues with Debian Jessie. It would throw and error when executing PIP commands. This does not happen on Ubuntu Trusty. So to get around this I had to add the following bit of logic to the Ansible task(s). Notice the when: ansible_distribution == "". We use this Ansible fact that is gathered to determine if we are running Debian or Ubuntu, do not confuse this with ansible_os_family == "Debian" as both Debian and Ubuntu will report this.</p>
<p>Ubuntu:</p>
<pre>when: ansible_distribution == "Ubuntu"
</pre>
<p>Debian:</p>
<pre>when: ansible_distribution == "Debian"
</pre>
<p>Below is the code that is part of the task mentioned above.</p>
<pre>- name: uninstall python-pip (If installed) - Debian
  apt:
    name: python-pip
    state: absent
  <strong>when: ansible_distribution == "Debian"</strong>

- name: debian | installing python packages
  apt:
    name: "{{ item }}"
    state: present
  with_items:
    - python-pip
  <strong>when: ansible_distribution == "Ubuntu"</strong>

- name: debian | installing python packages
  easy_install:
    name: "{{ item }}"
#    state: present
  with_items:
    - pip
  <strong>when: ansible_distribution == "Debian"
</strong></pre>
<p>Now we could change both to use easy_install: as our module to use from an Ansible perspective but...</p>
<p>Another little cool fact that can be used when adding the Docker APT repositories for Debian and Ubuntu is to use the following Ansible facts gathered:</p>
<pre>ansible_distribution
ansible_distribution_release
</pre>
<p>And we can use these as the following defined var in: (adding <strong>| lower</strong> will ensure that the ansible_distribution will be ubuntu/debian instead of Ubuntu/Debian so that it does not cause issues with adding the APT repositories)</p>
<p><strong><em>defaults/main.yml</em></strong></p>
<pre>docker_ubuntu_repo_info:  #defines docker ubuntu repo info for installing from
  - id: 58118E89F3A912897C070ADBF76221572C52609D
    keyserver: hkp://p80.pool.sks-keyservers.net:80
    repo: "deb https://apt.dockerproject.org/repo {{ <strong>ansible_distribution</strong> | lower }}-{{ <strong>ansible_distribution_release</strong> }} main"
</pre>
<p><strong>tasks/debian.yml</strong></p>
<pre>- name: debian | adding docker repo
  apt_repository:
    repo: "{{ item.repo }}"
    state: present
  with_items: docker_ubuntu_repo_info
</pre>
<p>Using these variables will yield the following based on OS.</p>
<p>Ubuntu:</p>
<pre>{{ ansible_distribution }} will be Ubuntu
{{ ansible_distribution_release }} will be trusty
</pre>
<p>Debian:</p>
<pre>{{ ansible_distribution }} will be Debian
{{ ansible_distribution_release }} will be jessie
</pre>
<blockquote><p><strong>UFW</strong></p>
<hr />
<p>&nbsp;</p></blockquote>
<p>When I began to configure the UFW (Uncomplicated Firewall) for some firewall rules to be used with Docker I ran into an issue on Debian Jessie stating that an invalid syntax error occurred when defining the routed default policy. Again, this works just fine on Ubuntu but not so much on Debian Jessie. After attempting a few different approaches to using the ufw Ansible module I finally pulled up the man page on UFW for Debian Jessie and Ubuntu. Well there is the issue right there. For some reason on Debian Jessie the UFW settings do not allow defining the default routed policy whereas on Ubuntu it does. Go figure. ( <a href="https://github.com/mrlesmithjr/ansible-ufw" target="_blank">https://github.com/mrlesmithjr/ansible-ufw</a> )</p>
<p>So how do we get around this one? It ended up being fairly simple but then again...Why do I need to do this?</p>
<p>Below is the bit of code that allows us to get around this (for now). Again we will use the ansible_distribution fact to determine if we are running Ubuntu or Debian when our policy direction is set to routed.<br />
<strong>defaults/main.yml</strong></p>
<pre>ufw_policies:  #defines default policy for incoming, outgoing and routed (forwarded) traffic...allow, deny or reject
  - direction: incoming
    policy: deny
  - direction: outgoing
    policy: allow
  - direction: routed
    policy: deny
</pre>
<p><strong>tasks/configure_firewall.yml</strong></p>
<pre>- name: configure_firewall | setting default UFW policies (incoming, outgoing)
  ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  with_items: ufw_policies
  when: item.direction != "routed"

- name: configure_firewall | setting default UFW policies (routed)
  ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  with_items: ufw_policies
  when: item.direction == "routed" and ansible_distribution != "Debian"
</pre>
<p>And that is all for now. I will be returning to this post and updating from time to time as I find additional gotchas.</p>
<p>Enjoy!</p>
