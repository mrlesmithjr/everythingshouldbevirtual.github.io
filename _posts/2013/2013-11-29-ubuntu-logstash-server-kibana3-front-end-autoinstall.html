---
layout: post
title: Ubuntu Logstash Server with Kibana3 Front End Autoinstall
date: 2013-11-29 18:41:09.000000000 -05:00
type: post
published: true
status: publish
categories:
- Logstash
- Monitoring
tags:
- esxi
- logstash
- Vsphere
meta:
  _edit_last: '11'
  _yoast_wpseo_focuskw: Ubuntu Logstash
  _yoast_wpseo_linkdex: '71'
  _s2mail: 'yes'
  snap_isAutoPosted: '1'
  _thumbnail_id: '2701'
  snap_MYURL: ''
  snapEdIT: '1'
  snapSU: s:259:"a:1:{i:0;a:9:{s:4:"doSU";s:1:"1";s:7:"apSUCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:6:"1CyuVF";s:7:"postURL";s:6:"1CyuVF";s:5:"pDate";s:19:"2013-11-29
    23:41:20";}}";
  bwps_enable_ssl: ''
  snapFB: s:416:"a:1:{i:0;a:13:{s:4:"doFB";s:1:"1";s:8:"PostType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:31:"389547404477041_505882482843532";s:5:"pDate";s:19:"2013-11-29
    23:41:13";s:8:"postType";s:1:"A";}}";
  snapLI: s:274:"a:1:{i:0;a:9:{s:4:"doLI";s:1:"1";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"SNAPformatT";s:1:" ";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";}}";
  snapTW: 's:332:"a:1:{i:0;a:9:{s:4:"doTW";s:1:"1";s:10:"SNAPformat";s:76:"%TITLE%
    - %URL% #everythingshouldbevirtual #logstash #VMware #Windows #Linux";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"478618455504322560";s:5:"pDate";s:19:"2014-06-16
    19:21:46";}}";'
  snapDL: s:102:"a:1:{i:0;a:3:{s:4:"doDL";s:1:"1";s:11:"SNAPformatT";s:7:"%TITLE%";s:10:"SNAPformat";s:9:"%EXCERPT%";}}";
  _wp_rp_related_posts_query_result_cache_expiration: '1511672156'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:4:"1819";s:5:"score";s:17:"74.23641133885253";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:4:"1494";s:5:"score";s:17:"71.15211962861949";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:4:"4695";s:5:"score";s:17:"69.78338029079367";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:4:"2985";s:5:"score";s:17:"68.78539795919855";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"3341";s:5:"score";s:17:"67.15007643430823";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"2854";s:5:"score";s:17:"64.36206743559964";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:4:"3353";s:5:"score";s:17:"62.44602679720083";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"3313";s:5:"score";s:16:"62.0425475125156";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"3302";s:5:"score";s:16:"60.7678246104127";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"4466";s:5:"score";s:16:"58.0965233542325";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:4:"3793";s:5:"score";s:16:"58.0965233542325";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"4447";s:5:"score";s:17:"57.09854102263739";}}
  dsq_thread_id: ''
  dsq_needs_sync: '1'
author:
  login: larry.e.smith.jr
  email: larry.e.smith.jr@gmail.com
  display_name: mrlesmithjr
  first_name: Larry
  last_name: Smith
---
<p>I have been using Graylog2 and VMware Log Insight for some time now and wanted to try out Logstash finally. So the first thing that I wanted to do was create an automated script to do most of the install and configuration to get everything running. I figured that as I am going through this I would share with everyone and start building on this script more based on feedback. I created a <a title="http://graylog2.org" href="http://graylog2.org" target="_blank">Graylog2</a> script (located <a title="http://everythingshouldbevirtual.com/ubuntu-12-04-graylog2-installation" href="http://everythingshouldbevirtual.com/ubuntu-12-04-graylog2-installation" target="_blank">here</a>) that has proven to be of great help to the community and figured I might be able to do the same with the <a title="http://logstash.net" href="http://logstash.net" target="_blank">Logstash</a> community, but even if it didn't I would learn a great deal about Logstash in the meantime. There is a great community around Logstash so getting support should be very easy. As well as, I am just starting to learn Logstash now so this should be a lot of fun. Which also means that there will be a good amount of change around this post.</p>
<p>First off I will be keeping this script updated and available on Github located <a title="https://github.com/mrlesmithjr/Logstash_Kibana3" href="https://github.com/mrlesmithjr/Logstash_Kibana3" target="_blank">here</a>. This will be the only location that I will be keeping up with it.</p>
<p>I would recommend using a clean install of Ubuntu 12.04 or 14.04 to install onto. However; if you decide to install on an existing server I am not responsible for anything that may get broken. :)</p>
<p>So here is how we get started and get everything up and running. Open up a terminal session on your server that you will be installing to and run the following commands.</p>
<p>For Logstash 1.3.x version: <strong>(OUTDATED!!)</strong></p>
<pre><del>sudo apt-get update
sudo apt-get -y install git
cd ~
git clone https://github.com/mrlesmithjr/Logstash_Kibana3
chmod +x ./Logstash_Kibana3/install_logstash_kibana_ubuntu.sh
sudo ./Logstash_Kibana3/install_logstash_kibana_ubuntu.sh</del></pre>
<p>For Logstash 1.4.x version: <strong>(CURRENT)</strong></p>
<pre>sudo apt-get update
sudo apt-get -y install git
cd ~
git clone https://github.com/mrlesmithjr/Logstash_Kibana3
chmod +x ./Logstash_Kibana3/install_logstash_1.4_kibana_ubuntu.sh
sudo ./Logstash_Kibana3/install_logstash_1.4_kibana_ubuntu.sh</pre>
<p>You will be prompted during the script to enter your domain name, <del>vSphere naming convention</del> and <a title="https://www.pfsense.org/" href="https://www.pfsense.org/" target="_blank">PFSense </a>Firewall hostname. These will be used to configure logstash filtering for your <del>ESXi hosts</del> and PFSense Firewall. If you do not monitor any <del>vSphere hosts</del> or use PFSense just enter some random info into these. These are purely just collecting info to pass into a filtering rule for Logstash.</p>
<p>Once complete open your browser of choice and connect to http://logstashservername/kibana or http://ipaddress/kibana.</p>
<p>You will see the following screen once connected. Seeing as we are setting up Logstash with Kibana go ahead and select the link on the left.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/11/19-31-11.png"><img class="alignnone size-medium wp-image-2246" src="{{ site.baseurl }}/assets/19-31-11-300x109.png" alt="19-31-11" width="300" height="109" /></a><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/11/Screen-Shot-2013-11-29-at-6.38.39-PM.png"><img class="alignnone size-medium wp-image-2243" src="{{ site.baseurl }}/assets/Screen-Shot-2013-11-29-at-6.38.39-PM-300x91.png" alt="Screen Shot 2013-11-29 at 6.38.39 PM" width="300" height="91" /></a></p>
<p>Now here is a screenshot of some actual ESXi logging. Notice the tag called VMware, that is created by the filtering rule that we created with the installer which, is based off of the naming convention we passed to the installer.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/11/Logstash_VMware_Dashboard.png"><img class="alignnone size-medium wp-image-2702" src="{{ site.baseurl }}/assets/Logstash_VMware_Dashboard-300x171.png" alt="Logstash_VMware_Dashboard" width="300" height="171" /></a></p>
<p>&nbsp;</p>
<p>You can grab my VMware dashboard from <a title="https://gist.github.com/mrlesmithjr/8f8ff8e2e8e6f43cb701" href="https://gist.github.com/mrlesmithjr/8f8ff8e2e8e6f43cb701" target="_blank">here</a>.</p>
<p>Here is another screenshot of logging graphs by adding different search criteria items.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/11/10-22-26.png"><img class="alignnone size-medium wp-image-2251" src="{{ site.baseurl }}/assets/10-22-26-300x117.png" alt="10-22-26" width="300" height="117" /></a></p>
<p>So what we have done with this script is installed <del>Apache2</del>, Nginx, Elasticsearch, Logstash and Kibana3. <del>Logstash has been configured to listen on UDP/514 (PFsense, SYSLOG and VMware), TCP/514 (recommended), UDP/514 (syslog devices that cannot be sent to TCP/514) TCP/3515 (Windows Event Logs) and TCP/3525 (Windows IIS Logging).</del></p>
<p>Now setup your network devices to start sending their syslogs to the HAProxy VIP and if your device supports sending via TCP, use it. Reference the port list below on setting up some of the devices that are pre-configured during the setup.</p>
<hr />
<p>&nbsp;</p>
<p><strong>Port List</strong><br />
TCP/514 Syslog (Devices supporting TCP)<br />
UDP/514 Syslog (Devices that do not support TCP)<br />
TCP/1514 VMware ESXi<br />
TCP/1515 VMware vCenter (Windows install or appliance) (For Windows install use NXLog from below in device setup) (For appliance reference device setup below)<br />
TCP/3515 Windows Eventlog (Use NXLog from below in device setup)<br />
TCP/3525 Windows IIS Logs (Use NXLog from below in device setup)</p>
<p>Below is a decent /etc/logstash/logstash.conf file that I am using and will be updating periodically. Some of these settings will be included in the install script but not all of them. You will need to change the naming for ESXi and PFSense for your environment. (Or just use the auto-install script).</p>
<p>https://gist.github.com/mrlesmithjr/43b4e97bf16a7423bbd2</p>
<p>For Windows Event Log's I highly recommend using NXLog for Windows. I am including a fuctional nxlog.conf file for you to use as well with the above logstash.conf configuration.</p>
<p>https://gist.github.com/mrlesmithjr/cf212836b9ce162373ed</p>
<p>Here is a screenshot of the Windows Logging if you want use the dashboard view for Windows from <a title="https://gist.github.com/mrlesmithjr/42db96d077f4d1035186" href="https://gist.github.com/mrlesmithjr/42db96d077f4d1035186" target="_blank">here</a>.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/11/Logstash_Windows_Dashboard.png"><img class="alignnone size-medium wp-image-2701" src="{{ site.baseurl }}/assets/Logstash_Windows_Dashboard-300x171.png" alt="Logstash_Windows_Dashboard" width="300" height="171" /></a></p>
<p style="text-align: center;"><strong> (OLD)</strong></p>
<p><del>If you want to purge and expire old logs have a look <a title="https://github.com/logstash/expire-logs" href="https://github.com/logstash/expire-logs" target="_blank">here</a>. Jordan Sissel (creator of Logstash) has provided a python script to do this.</del></p>
<p><del>Here is how you setup the script. Open a terminal on your Logstash server and execute the following.</del></p>
<pre><del>cd ~
sudo apt-get install python-pip
sudo apt-get install git
git clone https://github.com/logstash/expire-logs
cd expire-logs
sudo pip install -r requirements.txt</del></pre>
<p><del>Now that you have this setup read the examples on the github link on different scenarios.</del></p>
<p><del>After you purge your logs using the above method you will need to restart elasticsearch.</del></p>
<pre><del>sudo service elasticsearch restart</del></pre>
<p>That should be it.</p>
<p>Enjoy!</p>
<p>All comments and feedback are very much welcomed and encouraged.</p>
<p>Interested in a highly available setup? Go <a title="Highly Available ELK (Elasticsearch, Logstash and Kibana) Setup" href="http://everythingshouldbevirtual.com/highly-available-elk-elasticsearch-logstash-kibana-setup">here </a>and checkout the Highly Available ELK (Elasticsearch, Logstash and Kibana) setup.</p>
