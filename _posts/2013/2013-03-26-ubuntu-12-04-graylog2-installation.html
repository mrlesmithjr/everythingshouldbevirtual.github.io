---
layout: post
title: Ubuntu 12.04 Graylog2 Installation
date: 2013-03-26 17:20:35.000000000 -04:00
type: post
published: true
status: publish
categories:
- Graylog2
- Monitoring
- Ubuntu
tags:
- esxi
- graylog
- nxlog
- syslog
- ubuntu
- ubuntu 12.04
- VMware
- Vsphere
meta:
  _edit_last: '11'
  _s2mail: 'yes'
  _wpas_done_all: '1'
  snap_isAutoPosted: '1'
  bwps_enable_ssl: ''
  snap_MYURL: ''
  snapEdIT: '1'
  snapFB: s:416:"a:1:{i:0;a:13:{s:4:"doFB";s:1:"1";s:8:"PostType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:31:"389547404477041_397711500327298";s:5:"pDate";s:19:"2013-03-26
    21:20:37";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:8:"postType";s:1:"A";}}";
  snapLI: s:486:"a:1:{i:0;a:12:{s:4:"doLI";s:1:"1";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"SNAPformatT";s:6:"&nbsp;";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:124:"http://www.linkedin.com/updates?discuss=&amp;scope=138895851&amp;stype=M&amp;topic=5722426681994534913&amp;type=U&amp;a=UsyE";s:5:"pDate";s:19:"2013-03-26
    21:20:38";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";}}";
  snapSU: s:232:"a:1:{i:0;a:8:{s:4:"doSU";s:1:"1";s:7:"apSUCat";s:2:"IT";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:6:"9ZJ0Iq";s:5:"pDate";s:19:"2013-03-26
    21:20:45";s:4:"nsfw";s:1:"0";}}";
  snapTW: 's:323:"a:1:{i:0;a:9:{s:4:"doTW";s:1:"1";s:10:"SNAPformat";s:67:"%TITLE%
    - %URL% #everythingshouldbevirtual #ubuntu #vsphere #vmware";s:8:"attchImg";s:1:"0";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"316661023056740352";s:5:"pDate";s:19:"2013-03-26
    21:20:46";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";}}";'
  snapDL: s:102:"a:1:{i:0;a:3:{s:4:"doDL";s:1:"1";s:11:"SNAPformatT";s:7:"%TITLE%";s:10:"SNAPformat";s:9:"%EXCERPT%";}}";
  _wp_rp_related_posts_query_result_cache_expiration: '1511665250'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:3:"699";s:5:"score";s:17:"174.6715758720881";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:4:"1815";s:5:"score";s:17:"158.1077370780476";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:3:"118";s:5:"score";s:17:"91.65216200981655";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:3:"729";s:5:"score";s:16:"90.4202462621682";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"3249";s:5:"score";s:17:"88.62773174993458";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"2626";s:5:"score";s:17:"88.62773174993458";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:3:"687";s:5:"score";s:17:"87.33578793604404";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"2586";s:5:"score";s:16:"84.2344917764076";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"3826";s:5:"score";s:16:"82.9310629439506";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"2254";s:5:"score";s:17:"81.41449716969854";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:4:"4115";s:5:"score";s:17:"75.43244510185829";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"2646";s:5:"score";s:17:"75.11536465938065";}}
  _wp_rp_image: '3465'
  dsq_thread_id: ''
author:
  login: larry.e.smith.jr
  email: larry.e.smith.jr@gmail.com
  display_name: mrlesmithjr
  first_name: Larry
  last_name: Smith
---
<p>I recently wanted to check out <a title="http://graylog2.org/home" href="http://graylog2.org/home" target="_blank">Graylog2 </a>for gathering syslog messages because I have heard good things about it. Well the issue was that I was not able to find any good articles on how to accomplish this. I did find some installation scripts that looked promising, but they would not work correctly for whatever reason. So I took pieces of some scripts and other sources to compile what should be a completely accurate setup for now. I will be updating this post as time goes on. For the most part you can copy the text below and use it as a shell script. I created and tested this script using a fresh install of Ubuntu 12.04 x64. There is also a working Debian 6.0 install script that is available from github which is method 1 below. Method 1 is the preferred method as it will always be the most current. Using this setup will configure rsyslog to listen on udp/514 and reformat correctly and then pass on to Graylog2 listening on udp/10514. This works great for ESXi 5 and other Linux rsyslog clients. For Windows read the bottom of this post for Windows Event Logging. Let's go. Choose one of the methods below.</p>
<p><strong>Update *** This script will be maintained in GitHub Repository for future releases. <a title="https://github.com/mrlesmithjr/graylog2" href="https://github.com/mrlesmithjr/graylog2" target="_blank">https://github.com/mrlesmithjr/graylog2</a> **Update** Ubuntu 12.10 support added to github. Method 1 below will work for Ubuntu 12.04/12.10/13.04/14.04.</strong></p>
<p><strong>*** Update 07/10/2013. I have added the latest version 0.12.0 of graylog2 to the script on github. Please let me know if you run into issues. For Ubuntu only now that is.</strong></p>
<p><strong>*** Update 10/12/2013. The issue around installing Ruby on Ubuntu 12.04 has now been resolved. The ubuntu script from GitHub below has the updates included.</strong></p>
<p><strong>*** Update 10/18/2013. Sudo has been removed from within the script so now you can execute the script using sudo and never be prompted again during the install.</strong></p>
<p><strong><em>**UPDATE 12/11/2013** Preview script added to github</em></strong></p>
<p><em><strong>**UPDATE 01/16/2014** Preview script updated to include 0.20.0-rc.1</strong></em></p>
<p><strong>**UPDATE 02/20/2014** The release of 0.20.0 is now available. The preferred script to use is further down under v0.20.0 Release.<br />
</strong></p>
<p><strong>**UPDATE 02/24/2014** Updated to v0.20.1</strong></p>
<p><strong>**UPDATE 06/01/2014** Updated to v0.20.2</strong></p>
<p><strong>**UPDATE 06/18/2014 ** Updated to v0.20.3</strong></p>
<p><strong>**UPDATE 04/27/2014** Ubuntu 14.04 VMware Virtual Appliance Available <a title="Ubuntu 14.04 Graylog2 Virtual Appliance" href="http://everythingshouldbevirtual.com/ubuntu-14-04-graylog2-virtual-appliance">here</a>.</strong></p>
<p><strong>**UPDATE 04/29/2014** CentOS install script now available for v0.20.1</strong></p>
<p style="text-align: center;"><strong><em><del>The following is not for the Preview/RC version or v0.20.1 but for deprecated v0.12.0 (Not recommended any longer as it is no longer maintained but available for archival reasons)</del><br />
</em></strong></p>
<p><del>Open a terminal</del></p>
<pre><del>sudo apt-get -y install git
cd ~
git clone https://github.com/mrlesmithjr/graylog2/
chmod +x ./graylog2/install_graylog2_ubuntu.sh</del></pre>
<p><del>To change your ip address of the server you are installing on you will need to edit the script or let the script auto detect your IP for you. The default is auto detect. If you use the default of auto detect skip editing the file and continue on. Edit the file</del></p>
<pre><del>nano ./graylog2/install_graylog2_ubuntu.sh</del></pre>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/03/00-05-02.png"><img class="alignnone size-medium wp-image-1536" src="{{ site.baseurl }}/assets/00-05-02-300x61.png" alt="00-05-02" width="300" height="61" /></a></p>
<p><del>Save the file with ctrl^x. Now enter the following to start running the script.</del><strong><br />
</strong></p>
<pre><del>cd ~
sudo ./graylog2/install_graylog2_ubuntu.sh</del></pre>
<p style="text-align: left;"><del>The following is for the Preview and rc.1 version ONLY (Use method above if you want to use the stable current version) - <em>As of 02/02/2014 the above is outdated so use the method 1 below.</em></del></p>
<p style="text-align: center;"><strong>Method 1 **Preferred** All updates will be in Github</strong></p>
<p style="text-align: center;"><em><strong>The following is for v0.20.x Releases<br />
</strong></em></p>
<p style="text-align: left;"><em>Ubuntu Install:</em></p>
<pre>sudo apt-get -y install git
cd ~
git clone https://github.com/mrlesmithjr/graylog2/
chmod +x ./graylog2/install_graylog2_20_ubuntu.sh
sudo ./graylog2/install_graylog2_20_ubuntu.sh</pre>
<p>&nbsp;</p>
<p><em>CentOS Install:</em></p>
<pre>sudo yum install git
cd ~
git clone https://github.com/mrlesmithjr/graylog2/
chmod +x ./graylog2/install_graylog2_20_centos.sh
sudo ./graylog2/install_graylog2_20_centos.sh</pre>
<p>&nbsp;</p>
<p style="text-align: left;">If you are running v0.20.1+ on Ubuntu and used the auto install script method from above you can upgrade to the latest Graylog2 versions by doing the following.</p>
<pre>cd ~
cd graylog2
git pull https://github.com/mrlesmithjr/graylog2
chmod +x Upgrade_Scripts/upgrade_to_latest_graylog2_20_ubuntu.sh
cd ~
sudo ./graylog2/Upgrade_Scripts/upgrade_to_latest_graylog2_20_ubuntu.sh</pre>
<p>After this completes you should be up and running with the latest Graylog2 version.</p>
<p>&nbsp;</p>
<p style="text-align: center;"><strong>Graylog2 Virtual Appliance</strong></p>
<p style="text-align: left;">Graylog2 virtual appliance available running on Ubuntu 14.04LTS. Head over <a title="Ubuntu 14.04 Graylog2 Virtual Appliance" href="http://everythingshouldbevirtual.com/ubuntu-14-04-graylog2-virtual-appliance">here </a>and get your prebuilt virtual appliance.</p>
<p style="text-align: center;"><strong>Troubleshooting issues</strong></p>
<p style="text-align: left;">If you start getting scrolling java type errors after installing one or more critical services are not running. You can either reboot or try the following.</p>
<pre>sudo service graylog2-web-interface stop
sudo service mongodb status
sudo service elasticsearch status
sudo service graylog2 status</pre>
<p>If any of the above do not return as running and a PID then you will need to start the service not running by running the following.</p>
<pre>sudo service servicename start</pre>
<p>You can also run the following and the ports should show the services running. (Reference screenshot below command window)</p>
<pre>sudo netstat -ltnp</pre>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/03/Screenshot-from-2014-02-21-145017.png"><img class="alignnone size-medium wp-image-2453" src="{{ site.baseurl }}/assets/Screenshot-from-2014-02-21-145017-300x78.png" alt="Screenshot from 2014-02-21 14:50:17" width="300" height="78" /></a></p>
<p>&nbsp;</p>
<p style="text-align: center;"><strong>Logging into the new WebUI after installation.</strong></p>
<p style="text-align: left;">Open your browser of choice and connect to http://ip.or.nameofgraylog2server:9000</p>
<p style="text-align: left;">Login with username <strong><em>admin</em></strong> and password is <strong><em>password123 (Or password chosen during install script)</em></strong></p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/03/16-14-48.png"><img class="alignnone size-medium wp-image-2263" src="{{ site.baseurl }}/assets/16-14-48-300x189.png" alt="16-14-48" width="300" height="189" /></a></p>
<p>Click on system</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/03/16-06-32.png"><img class="alignnone size-medium wp-image-2264" src="{{ site.baseurl }}/assets/16-06-32-300x92.png" alt="16-06-32" width="300" height="92" /></a></p>
<p>Click on nodes</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/03/16-06-45.png"><img class="alignnone size-medium wp-image-2265" src="{{ site.baseurl }}/assets/16-06-45-300x133.png" alt="16-06-45" width="300" height="133" /></a></p>
<p>Select action and then manage inputs</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/03/16-06-57.png"><img class="alignnone size-medium wp-image-2266" src="{{ site.baseurl }}/assets/16-06-57-300x138.png" alt="16-06-57" width="300" height="138" /></a></p>
<p>Select Syslog UDP from dropdown</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/03/16-07-16.png"><img class="alignnone size-medium wp-image-2267" src="{{ site.baseurl }}/assets/16-07-16-300x113.png" alt="16-07-16" width="300" height="113" /></a></p>
<p>Give it a name of <strong><em>syslog redirect</em></strong> and port 10514 and then click launch and close. (Rsyslog is listening on UDP/514 and forwarding to Graylog2 which is listening on UDP/10514)</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/03/16-07-52.png"><img class="alignnone size-medium wp-image-2268" src="{{ site.baseurl }}/assets/16-07-52-300x282.png" alt="16-07-52" width="300" height="282" /></a></p>
<p>You should now see your new input created and accepting traffic.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/03/16-08-34.png"><img class="alignnone size-medium wp-image-2269" src="{{ site.baseurl }}/assets/16-08-34-300x155.png" alt="16-08-34" width="300" height="155" /></a></p>
<p><strong>****** If you would like to uninstall the Preview/RC/Release version I have created an uninstall script to do this. Please use at your own risk as I am not responsible for anything that may happen by using this incorrectly. ******</strong></p>
<p>To uninstall do the following..</p>
<pre>cd ~
mv graylog2 graylog2.old
git clone https://github.com/mrlesmithjr/graylog2
chmod +x ./graylog2/uninstall_graylog2_preview_ubuntu.sh
sudo ./graylog2/uninstall_graylog2_preview_ubuntu.sh</pre>
<p>Now you can go back and start over if you would like to.</p>
<p><strong>Want to upgrade from Preview/RC v0.20.0 versions to Final v0.20.0 release? I have a script for that now too. It should preserve all previous syslog messages but I highly recommend taking a snapshot if you are using a VM (Hopefully you are! :) ). **NOT FOR v0.12.0 to v0.20.x releases!!!***<br />
</strong></p>
<p>The following will take care of the upgrade for you.</p>
<pre>cd ~
mv graylog2 graylog2.old
git clone https://github.com/mrlesmithjr/graylog2/
chmod +x ./graylog2/upgrade_to_graylog2_20_ubuntu.sh
sudo ./graylog2/upgrade_to_graylog2_20_ubuntu.sh</pre>
<p style="text-align: center;"> <strong>Debian Installer</strong></p>
<p>Within the github repository there is also a script to automate a Debian 6.0 Graylog2 installation. If you are installing on Debian 6.0 run the following instead.</p>
<pre>chmod +x ./graylog2/install_graylog2_debian.sh
cd ~
sudo ./graylog2/install_graylog2_debian.sh</pre>
<p style="text-align: center;"><strong>Method 2  <strong>**Note this may be outdated**</strong></strong></p>
<p>You can download the script, upload and then extract it to your Ubuntu server from the link below. <a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/03/install_graylog2.tar.gz">install_graylog2.tar.gz</a> If you downloaded the file you will now need to run the following in the console.</p>
<pre>tar zxvf install_graylog2.tar.gz
chmod +x install_graylog2.sh
nano install_graylog2.sh</pre>
<p>Change x.x.x.x to whatever your ip address is of the server you are installing on or let the script auto detect your IP for you. The default is auto detect. <a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/03/00-05-02.png"><img class="alignnone size-medium wp-image-1536" src="{{ site.baseurl }}/assets/00-05-02-300x61.png" alt="00-05-02" width="300" height="61" /></a></p>
<p>Save the file with ctrl^x. Now run the following to start running the script. You will be prompted for your sudo password once the script starts.</p>
<pre>./install_graylog2.sh</pre>
<p>&nbsp;</p>
<p style="text-align: center;"><strong>Method 3  <strong>**Note this may be outdated**</strong></strong></p>
<p>Or you can use the following method from a terminal session on your Ubuntu server. **Change Servername and ServerAlias to the IP Address of your server in install_graylog2.sh using nano as below.</p>
<pre>cd ~
wget --user-agent "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:11.0) Gecko/20100101 Firefox/11.0" http://everythingshouldbevirtual.com/wp-content/uploads/2013/03/install_graylog2.tar.gz
tar zxvf install_graylog2.tar.gz
chmod +x install_graylog2.sh
nano install_graylog2.sh</pre>
<p>Change x.x.x.x to whatever your ip address is of the server you are installing on or let the script auto detect your IP for you. The default is to auto detect. <a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/03/14-26-35.png"><img class="alignnone size-medium wp-image-1521" src="{{ site.baseurl }}/assets/14-26-35-300x55.png" alt="14-26-35" width="300" height="55" /></a></p>
<p style="text-align: center;"><strong>Method 4  <strong>**Note this may be outdated**</strong></strong></p>
<p>Or you can create your own install script as below.</p>
<pre>cd ~
#! /bin/bash
#Provided by @mrlesmithjr
#EveryThingShouldBeVirtual.com
#
#
# Ubuntu Install Script
#
# Setup logging
# Logs stderr and stdout to separate files.
exec 2&gt; &gt;(tee "./graylog2/install_graylog2.err")
exec &gt; &gt;(tee "./graylog2/install_graylog2.log")
#
# Checking if running as root (10/16/2013 - No longer an issue - Should be ran as root or with sudo)
# Do not run as root
# if [[ $EUID -eq 0 ]];then
# echo "$(tput setaf 1)DO NOT RUN AS ROOT or use SUDO"
# echo "Now exiting...Hit Return"
# echo "$(tput setaf 3)Run script as normal non-root user and without sudo$(tput sgr0)"
# exit 1
# fi

# Apache Settings
# change x.x.x.x to whatever your ip address is of the server you are installing on or let the script auto detect your IP
# which is the default
# SERVERNAME="x.x.x.x"
# SERVERALIAS="x.x.x.x"
#
#
echo "Detecting IP Address"
IPADDY="$(ifconfig | grep -A 1 'eth0' | tail -1 | cut -d ':' -f 2 | cut -d ' ' -f 1)"
echo "Detected IP Address is $IPADDY"

SERVERNAME=$IPADDY
SERVERALIAS=$IPADDY

# Disable CD Sources in /etc/apt/sources.list
echo "Disabling CD Sources and Updating Apt Packages and Installing Pre-Reqs"
sed -i -e 's|deb cdrom:|# deb cdrom:|' /etc/apt/sources.list
apt-get -qq update

# Install Pre-Reqs
apt-get -y install git curl apache2 libcurl4-openssl-dev apache2-prefork-dev libapr1-dev libcurl4-openssl-dev apache2-prefork-dev libapr1-dev build-essential openssl libreadline6 libreadline6-dev curl git-core zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt-dev autoconf libc6-dev ncurses-dev automake libtool bison subversion pkg-config python-software-properties software-properties-common

# Install Oracle Java 7
echo "Installing Oracle Java 7"
add-apt-repository -y ppa:webupd8team/java
apt-get -qq update
echo oracle-java7-installer shared/accepted-oracle-license-v1-1 select true | /usr/bin/debconf-set-selections
apt-get -y install oracle-java7-installer

echo "Downloading Elasticsearch"
chown -R $USER:$USER /opt
cd /opt
git clone https://github.com/elasticsearch/elasticsearch-servicewrapper.git

# Download Elasticsearch, Graylog2-Server and Graylog2-Web-Interface
echo "Downloading Elastic Search, Graylog2-Server and Graylog2-Web-Interface to /opt"
wget https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-0.20.6.tar.gz
wget https://github.com/Graylog2/graylog2-server/releases/download/0.12.0/graylog2-server-0.12.0.tar.gz
wget https://github.com/Graylog2/graylog2-web-interface/releases/download/0.12.0/graylog2-web-interface-0.12.0.tar.gz

# Extract files
echo "Extracting Elasticsearch, Graylog2-Server and Graylog2-Web-Interface to /opt"
for f in *.tar.gz
do
tar zxf "$f"
done

# Create Symbolic Links
echo "Creating SymLinks for elasticsearch and graylog2-server"
ln -s elasticsearch-0.20.6/ elasticsearch
ln -s graylog2-server-0.12.0/ graylog2-server

# Install elasticsearch
echo "Installing elasticsearch"
mv *servicewrapper*/service elasticsearch/bin/
rm -Rf *servicewrapper*
/opt/elasticsearch/bin/service/elasticsearch install
ln -s `readlink -f elasticsearch/bin/service/elasticsearch` /usr/bin/elasticsearch_ctl
sed -i -e 's|# cluster.name: elasticsearch|cluster.name: graylog2|' /opt/elasticsearch/config/elasticsearch.yml
/etc/init.d/elasticsearch start

# Test elasticsearch
# curl -XGET 'http://localhost:9200/_cluster/health?pretty=true'

# Install mongodb
echo "Installing MongoDB"
apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 7F0CEB10
echo "deb http://downloads-distro.mongodb.org/repo/ubuntu-upstart dist 10gen" | tee /etc/apt/sources.list.d/10gen.list
apt-get -qq update
apt-get -y install mongodb-10gen

# Install graylog2-server
echo "Installing graylog2-server"
cd graylog2-server-0.12.0/
cp /opt/graylog2-server/elasticsearch.yml{.example,}
ln -s /opt/graylog2-server/elasticsearch.yml /etc/graylog2-elasticsearch.yml
cp /opt/graylog2-server/graylog2.conf{.example,}
ln -s /opt/graylog2-server/graylog2.conf /etc/graylog2.conf
sed -i -e 's|mongodb_useauth = true|mongodb_useauth = false|' /opt/graylog2-server/graylog2.conf

# Create graylog2-server startup script
echo "Creating /etc/init.d/graylog2-server startup script"
(
cat &lt;&lt;'EOF' #!/bin/sh # # graylog2-server: graylog2 message collector # # chkconfig: - 98 02 # description: This daemon listens for syslog and GELF messages and stores them in mongodb # CMD=$1 NOHUP=`which nohup` JAVA_CMD=/usr/bin/java GRAYLOG2_SERVER_HOME=/opt/graylog2-server start() {  echo "Starting graylog2-server ..." $NOHUP $JAVA_CMD -jar $GRAYLOG2_SERVER_HOME/graylog2-server.jar &gt; /var/log/graylog2.log 2&gt;&amp;1 &amp;
}

stop() {
PID=`cat /tmp/graylog2.pid`
echo "Stopping graylog2-server ($PID) ..."
kill $PID
}

restart() {
echo "Restarting graylog2-server ..."
stop
start
}

case "$CMD" in
start)
start
;;
stop)
stop
;;
restart)
restart
;;
*)
echo "Usage $0 {start|stop|restart}"
RETVAL=1
esac
EOF
) | tee /etc/init.d/graylog2-server

# Make graylog2-server executable
chmod +x /etc/init.d/graylog2-server

# Start graylog2-server on bootup
echo "Making graylog2-server startup on boot"
update-rc.d graylog2-server defaults

# Install graylog2 web interface
echo "Installing graylog2-web-interface"
cd /opt/
ln -s graylog2-web-interface-0.12.0 graylog2-web-interface

# Install Ruby
echo "Installing Ruby"
apt-get -y install libgdbm-dev libffi-dev ruby1.9.3

# Install Ruby Gems
echo "Installing Ruby Gems"
cd /opt/graylog2-web-interface
gem install bundler --no-ri --no-rdoc
bundle install

# Set MongoDB Settings
echo "Configuring MongoDB"
echo "
production:
 host: localhost
 port: 27017
 username: grayloguser
 password: password123
 database: graylog2" | tee /opt/graylog2-web-interface/config/mongoid.yml

# Create MongoDB Users and Set Passwords
echo Creating MongoDB Users and Passwords
mongo admin --eval "db.addUser('admin', 'password123')"
mongo admin --eval "db.auth('admin', 'password123')"
mongo graylog2 --eval "db.addUser('grayloguser', 'password123')"
mongo graylog2 --eval "db.auth('grayloguser', 'password123')"

# Test Install
# cd /opt/graylog2-web-interface
# RAILS_ENV=production script/rails server

# Install Apache-passenger
echo Installing Apache-Passenger Modules
gem install passenger
/var/lib/gems/1.9.1/gems/passenger-4.0.20/bin/passenger-install-apache2-module --auto

# Add passenger modules for Apache2
echo "Adding Apache Passenger modules to /etc/apache2/httpd.conf"
echo "LoadModule passenger_module /var/lib/gems/1.9.1/gems/passenger-4.0.20/buildout/apache2/mod_passenger.so" | tee -a /etc/apache2/mods-available/passenger.load
echo "PassengerRoot /var/lib/gems/1.9.1/gems/passenger-4.0.20" | tee -a /etc/apache2/mods-available/passenger.conf
echo "PassengerRuby /usr/bin/ruby1.9.1" | tee -a /etc/apache2/mods-available/passenger.conf

# Enable passenger modules
a2enmod passenger

# Restart Apache2
echo "Restarting Apache2"
service apache2 restart
# If apache fails and complains about unable to load mod_passenger.so check and verify that your passengerroot version matches

# Configure Apache virtualhost
echo "Configuring Apache VirtualHost"
echo "
ServerName ${SERVERNAME}
ServerAlias ${SERVERALIAS}
DocumentRoot /opt/graylog2-web-interface/public

#Allow from all
Options -MultiViews

ErrorLog /var/log/apache2/error.log
LogLevel warn
CustomLog /var/log/apache2/access.log combined" | tee /etc/apache2/sites-available/graylog2

# Enable virtualhost
echo "Enabling Apache VirtualHost Settings"
a2dissite 000-default
a2ensite graylog2
service apache2 reload

# Restart apache
echo "Restarting Apache2"
service apache2 restart

# Now we need to modify some things to get rsyslog to forward to graylog. this is useful for ESXi syslog format to be correct.
echo "Updating graylog2.conf, rsyslog.conf"
sed -i -e 's|syslog_listen_port = 514|syslog_listen_port = 10514|' /etc/graylog2.conf
sed -i -e 's|mongodb_password = 123|mongodb_password = password123|' /etc/graylog2.conf
sed -i -e 's|#$ModLoad immark|$ModLoad immark|' /etc/rsyslog.conf
sed -i -e 's|#$ModLoad imudp|$ModLoad imudp|' /etc/rsyslog.conf
sed -i -e 's|#$UDPServerRun 514|$UDPServerRun 514|' /etc/rsyslog.conf
sed -i -e 's|#$ModLoad imtcp|$ModLoad imtcp|' /etc/rsyslog.conf
sed -i -e 's|#$InputTCPServerRun 514|$InputTCPServerRun 514|' /etc/rsyslog.conf
sed -i -e 's|*.*;auth,authpriv.none|#*.*;auth,authpriv.none|' /etc/rsyslog.d/50-default.conf
# echo '$template GRAYLOG2,"&lt;%PRI%&gt;1 %timegenerated:::date-rfc3339% %HOSTNAME% %syslogtag% - %APP-NAME%: %msg:::drop-last-lf%\n"' | tee /etc/rsyslog.d/32-graylog2.conf
echo '$template GRAYLOG2,"&lt;%PRI%&gt;1 %timegenerated:::date-rfc3339% %FROMHOST% %syslogtag% - %APP-NAME%: %msg:::drop-last-lf%\n"' | tee /etc/rsyslog.d/32-graylog2.conf
echo '$ActionForwardDefaultTemplate GRAYLOG2' | tee -a  /etc/rsyslog.d/32-graylog2.conf
echo '$PreserveFQDN on' | tee -a  /etc/rsyslog.d/32-graylog2.conf
#echo '*.err;*.crit;*.alert;*.emerg;cron.*;auth,authpriv.* @localhost:10514' | tee -a  /etc/rsyslog.d/32-graylog2.conf
# Log syslog levels info and above
echo '*.info @localhost:10514' | tee -a  /etc/rsyslog.d/32-graylog2.conf

#Fixing issue with secret_token in /opt/graylog2-web-interface/config/initializers/secret_token.rb
sed -i -e "s|Graylog2WebInterface::Application.config.secret_token = 'CHANGE ME'|Graylog2WebInterface::Application.config.secret_token = 'b356d1af93673e37d6e21399d033d77c15354849fdde6d83fa0dca19608aa71f2fcd9d1f2784fb95e9400d8eeaf6dd9584d8d35b8f0b5c231369a70aac5e5777'|" /opt/graylog2-web-interface/config/initializers/secret_token.rb

# Restart All Services
echo "Restarting All Services Required for Graylog2 to work"
service elasticsearch restart
service mongodb restart
service graylog2-server restart
service rsyslog restart
service apache2 restart

# All Done
echo "Installation has completed!!"
echo "Browse to IP address of this Graylog2 Server Used for Installation"
echo "IP Address detected from system is $IPADDY"
echo "Browse to http://$IPADDY"
echo "You Entered $SERVERNAME During Install"
echo "Browse to http://$SERVERNAME If Different"
echo "EveryThingShouldBeVirtual.com"
echo "@mrlesmithjr"</pre>
<pre>chmod +x install_graylog2.sh
./install_graylog2.sh</pre>
<p>Once the script completes connect to the ip/hostname of your Graylog2 server with your favorite browser and create your first login account. Or if you have installed on Ubuntu Desktop 12.04 you can just open firefox and type in http://localhost. You will then be prompted to create your first user.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/03/15-31-43.png"><img class="alignnone size-medium wp-image-1526" src="{{ site.baseurl }}/assets/15-31-43-300x50.png" alt="15-31-43" width="300" height="50" /></a></p>
<p>Once you have created a user account you can then login and you will have a great looking Graylog2 web ui like below.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/03/13-01-30.png"><img class="alignnone size-medium wp-image-1519" src="{{ site.baseurl }}/assets/13-01-30-300x94.png" alt="13-01-30" width="300" height="94" /></a></p>
<p>If you get a ruby error page like screenshot below when connecting to the web interface that says unable to authorize grayloguser in mongo graylog2 db do the following in code box below. On a few occasions the script is failing to create the mongo db and users. I have only had this issue when doing an apt-get upgrade prior to running this script.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2013/03/12-55-10.png"><img class="alignnone size-medium wp-image-1517" src="{{ site.baseurl }}/assets/12-55-10-300x250.png" alt="12-55-10" width="300" height="250" /></a></p>
<pre>mongo admin --eval "db.addUser('admin', 'password123')"
mongo admin --eval "db.auth('admin', 'password123')"
mongo graylog2 --eval "db.addUser('grayloguser', 'password123')"
mongo graylog2 --eval "db.auth('grayloguser', 'password123')"
sudo service elasticsearch restart
sudo service mongodb restart
sudo service graylog2-server restart
sudo service rsyslog restart
sudo service apache2 restart</pre>
<p>For Windows logging to get sent to Graylog2 check out <a title="http://nxlog.org/" href="http://nxlog.org/" target="_blank">NXLog</a>. It supports the GELF format as well. Below is an example nxlog.conf file for Windows to be sent to Graylog2 in Gelf format.</p>
<pre>&lt;Extension gelf&gt;
    Module      xm_gelf
&lt;/Extension&gt;

&lt;Input in&gt;
    # Use 'im_mseventlog' for Windows XP and 2003
    Module      im_msvistalog
&lt;/Input&gt;

&lt;Output out&gt;
    Module      om_udp
    Host        192.168.1.1
    Port        12201
    OutputType  GELF
&lt;/Output&gt;

&lt;Route r&gt;
    Path        in =&gt; out
&lt;/Route&gt;</pre>
<p>Another thing that I have found is that the graylog2-server by default listens on IPv6 for UDP/TCP. I was having issues with sending logs to the udp/10514 port directly. The following code added to /etc/init.d/graylog2-server will force it to run on IPv4 ports.</p>
<pre>-Djava.net.preferIPv4Stack=<wbr />true</pre>
<p>Add the code above to the section under echo "Starting  graylog2-server ..." It should look like the below.</p>
<pre>$NOHUP $JAVA_CMD -Djava.net.preferIPv4Stack=true -jar $GRAYLOG2_SERVER_HOME/graylog2-server.jar &gt; /var/log/graylog2.log 2&gt;&amp;1 &amp;</pre>
<p>Restart graylog2-server service to take affect.</p>
<pre>sudo /etc/init.d/graylog2-server restart</pre>
<p>Using Graylog2 (version 0.11.0) I am seeing high CPU usage all the time. Apparently this is a known thing and will be fixed in a future release by setting processor_wait_strategy = blocking. The default is currently processor_wait_strategy = sleeping. Run the following to make this change.</p>
<pre>sudo sed -i -e 's|processor_wait_strategy = sleeping|processor_wait_strategy = blocking|' /etc/graylog2.conf
sudo /etc/init.d/graylog2-server restart</pre>
<p>To set the TTL (Time To Live) for Graylog2 messages within Elasticsearch to keep from filling up all of the disk space. Run the following.</p>
<pre>curl -XPUT 'http://localhost:9200/graylog2/'
curl -XPUT "http://localhost:9200/graylog2/message/_mapping" -d'{"message": {"_ttl" : { "enabled" : true, "default" : "30d" }}}'</pre>
<p>The first line builds the index and the second line sets the TTL to 30 days.<br />
To clear all of your messages and hosts from graylog2 do the following.</p>
<pre>cd /opt/elasticsearch/data/graylog2
sudo rm -rf *
mongo
use graylog2
db.message_counts.remove()
db.hosts.remove()
exit
sudo /etc/init.d/elasticsearch restart</pre>
<p>I just had an issue with my graylog2 server and it was a java process taking about 90-100 percent CPU even after a reboot. It was caused by almost all of the disk space used where the mongodb grew too large for my system. Now you can add more space or just clear the db using the process above which is what I did. All good now.</p>
<p>Enjoy!</p>
