---
layout: post
title: Nexentastor/ESXi5/3750G/LACP/VDS/NFS/iSCSI - Part 2
date: 2012-12-05 21:30:00.000000000 -05:00
type: post
published: true
status: publish
categories:
- Cisco
- Networking
- Nexenta
- Virtualization
- VMware
- vSphere 5.1
tags:
- ESXI5
- iSCSI
- LACP
- NAS
- nexenta
- Nexentastor
- NFS
- Vsphere
meta:
  _edit_last: '11'
  snapEdIT: '1'
  snapFB: s:276:"a:1:{i:0;a:8:{s:13:"SNAPincludeFB";s:1:"1";s:8:"PostType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:31:"490878107607759_539202302775339";s:4:"doFB";i:0;}}";
  snapLI: s:203:"a:1:{i:0;a:6:{s:13:"SNAPincludeLI";s:1:"1";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"doLI";i:0;}}";
  snapTW: 's:267:"a:1:{i:0;a:8:{s:13:"SNAPincludeTW";s:1:"1";s:10:"SNAPformat";s:32:"%TITLE%
    - %URL% #nexenta #vmware";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:8:"attchImg";s:1:"0";s:4:"doTW";i:0;s:4:"pgID";s:18:"298547326006472704";s:5:"pDate";s:19:"2013-02-04
    21:43:24";}}";'
  _s2mail: 'yes'
  _wpas_done_all: '1'
  snap_isAutoPosted: '1'
  snapSU: s:146:"a:1:{i:0;a:5:{s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:7:"apSUCat";s:2:"IT";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:4:"doSU";i:0;}}";
  _yoast_wpseo_linkdex: '58'
  _yoast_wpseo_focuskw: Nexenta LACP NFS iSCSI
  _yoast_wpseo_title: Nexentastor/ESXi5/3750G/LACP/VDS/NFS/iSCSI - Part 2 - Everything
    Should Be Virtual
  _wp_rp_related_posts_query_result_cache_expiration: '1509589462'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:2:"41";s:5:"score";s:17:"294.5528533519046";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:3:"913";s:5:"score";s:17:"181.7288996683546";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:4:"3826";s:5:"score";s:18:"149.12156736571322";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:2:"98";s:5:"score";s:18:"128.42579142629785";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"1196";s:5:"score";s:17:"118.0508596452595";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"1016";s:5:"score";s:18:"103.20679052350997";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:3:"471";s:5:"score";s:17:"97.27384271768202";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:3:"747";s:5:"score";s:17:"91.69709437293885";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"1444";s:5:"score";s:17:"87.59042209616365";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"1695";s:5:"score";s:16:"86.5938280562236";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:4:"1399";s:5:"score";s:17:"81.73043424232634";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"1890";s:5:"score";s:17:"81.13476535457266";}}
  _wp_rp_image: '3761'
  dsq_thread_id: ''
author:
  login: larry.e.smith.jr
  email: larry.e.smith.jr@gmail.com
  display_name: mrlesmithjr
  first_name: Larry
  last_name: Smith
---
<p>This article is a continuation of Part 1 that we did a while back.  I would highly suggest checking out that article as well prior to going through this article.  You can read Part 1 <a href="http://everythingshouldbevirtual.com/nexentastoresxi53750glacpvdsnfsiscsi-part-1/" target="_blank">here</a>.</p>
<h1>MPIO Round Robin Policy</h1>
<p>The default round robin policy for each iSCSI LUN presented is set to 1000 IOPS, which means that for every 1000 IOPS the round robin policy will switch NIC paths.  We are going to change the IOPS to 1.  Then it will switch paths every 1 IOP.  Therefore utilizing our paths more effectively.</p>
<p>The first thing we need to do is get the list of devices that we need to make this change to by executing the command below. On your ESXi console via SSH run the following command.</p>
<pre><strong># esxcli storage nmp device list | grep naa | grep NEXENTA </strong>
   Device Display Name: NEXENTA iSCSI Disk (naa.600144f03eb7cd0000004ffd9d940001) 
   Device Display Name: NEXENTA iSCSI Disk (naa.600144f03eb7cd000000500d85a40003) 
   Device Display Name: NEXENTA iSCSI Disk (naa.600144f03eb7cd000000501319fa0001) 
   Device Display Name: NEXENTA iSCSI Disk (naa.600144f03eb7cd000000500b500a0002) 
   Device Display Name: NEXENTA iSCSI Disk (naa.600144f03eb7cd0000005058b14b0001)</pre>
<p>As you can see we have 5 Nexenta devices that we need to modify the policy for here.  The device names that we need to change are within parenthesis starting with <em><strong>naa</strong></em>.</p>
<p>Run the following command and you will notice that the IOOperation Limit is 1000 and the Limit Type is Default</p>
<pre><strong># esxcli storage nmp psp roundrobin deviceconfig get -d naa.600144f03eb7cd000000500d85a40003<em> </em></strong><span class="Apple-style-span" style="font-family: Times; white-space: normal;">   Byte Limit: 10485760  </span>   Device: naa.600144f03eb7cd000000500d85a40003
   IOOperation Limit: 1000
   Limit Type: Default
   Use Active Unoptimized Paths: false</pre>
<p>Now to change the IOPS policy execute the following for each device name.  Also make sure that for each datastore or LUN using the vSphere client that Round-Robin is selected for the Load Balancing policy.</p>
<pre><em>#<strong>esxcli storage nmp psp roundrobin deviceconfig set -d naa.600144f03eb7cd0000004ffd9d940001 --iops 1 --type iops</strong></em></pre>
<p>&nbsp;</p>
<p>Now do this same thing for each additional device you listed from above by replacing the naa.____ device name.  Also remember to do this on each host that uses these same iSCSI devices.</p>
<p>Once you are done we need to make sure that all of the devices have been changed.  Run the following command to verify quickly.</p>
<pre><strong># </strong><code><strong>esxcli storage nmp device list | grep policy</strong></code>
   Path Selection Policy Device Config: {policy=iops,iops=1,bytes=10485760,useANO=0;lastPathIndex=0: NumIOsPending=0,numBytesPending=0}
   Path Selection Policy Device Config: {<strong>policy=rr</strong>,<strong>iops=1000</strong>,bytes=10485760,useANO=0;lastPathIndex=0: NumIOsPending=0,numBytesPending=0}
   Path Selection Policy Device Config: {policy=iops,iops=1,bytes=10485760,useANO=0;lastPathIndex=0: NumIOsPending=0,numBytesPending=0}
   Path Selection Policy Device Config: {policy=iops,iops=1,bytes=10485760,useANO=0;lastPathIndex=0: NumIOsPending=0,numBytesPending=0}
   Path Selection Policy Device Config: {policy=iops,iops=1,bytes=10485760,useANO=0;lastPathIndex=0: NumIOsPending=0,numBytesPending=0}</pre>
<p>As you can see from above highlighted policy and iops values we missed one of our devices.  So you will need to go back and make sure to change that device to the new values using the commands from above.  Also if you run the same command to list our policies that are set you will notice that the lastPathIndex= will change which means that our paths are definitely changing.</p>
<p>Remember your device names will be different than the examples above.</p>
<p>When configuring a folder share to export for NFS as a VMware datastore configure the following settings for the folder as in the screenshot.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2012/12/15-52-13.png"><img class="alignnone size-medium wp-image-1199" alt="15-52-13" src="{{ site.baseurl }}/assets/15-52-13-296x300.png" width="296" height="300" /></a></p>
<p>You can reference <a href="http://info.nexenta.com/rs/nexenta/images/5000-nxs-v0.0-000002-A_nxstor_vmware_best_practices.pdf" target="_blank">this </a>doc for more information on Nexenta's recommended best practices.</p>
<p>You can also reference the VMware best practices guide for NFS datastores <a title="http://www.vmware.com/files/pdf/techpaper/VMware-NFS-Best-Practices-WP-EN-New.pdf" href="http://www.vmware.com/files/pdf/techpaper/VMware-NFS-Best-Practices-WP-EN-New.pdf" target="_blank">here</a>.</p>
<p>&nbsp;</p>
