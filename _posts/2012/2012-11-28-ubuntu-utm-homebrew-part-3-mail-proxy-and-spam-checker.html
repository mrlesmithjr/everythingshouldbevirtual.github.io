---
layout: post
title: Ubuntu UTM Homebrew - Part 3 - Mail Proxy and Spam Checker
date: 2012-11-28 08:28:57.000000000 -05:00
type: post
published: true
status: publish
categories:
- Linux
- Security
- Ubuntu
- UTM
tags:
- clamav
- iptables
- p3scan
- spamassassin
- ubuntu
- ubuntu 12.04
- UTM
meta:
  _edit_last: '11'
  fb_social_plugin_settings_box_subscribe: default
  fb_social_plugin_settings_box_recommendations_bar: default
  _s2mail: 'yes'
  _jd_tweet_this: 'yes'
  snapEdIT: '1'
  snapFB: s:280:"a:1:{i:0;a:8:{s:13:"SNAPincludeFB";s:1:"1";s:8:"PostType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:31:"490878107607759_535474889814747";s:4:"doFB";s:1:"1";}}";
  snapLI: s:239:"a:1:{i:0;a:7:{s:13:"SNAPincludeLI";s:1:"1";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"doLI";s:1:"1";s:11:"SNAPformatT";s:6:"&nbsp;";}}";
  snapTW: 's:186:"a:1:{i:0;a:6:{s:13:"SNAPincludeTW";s:1:"1";s:10:"SNAPformat";s:23:"%TITLE%
    - %URL% #ubuntu";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"doTW";s:1:"1";s:8:"attchImg";s:1:"0";}}";'
  _wpas_done_all: '1'
  snap_isAutoPosted: '1'
  _yoast_wpseo_linkdex: '77'
  _yoast_wpseo_focuskw: Ubuntu
  snapSU: s:100:"a:1:{i:0;a:3:{s:4:"doSU";s:1:"1";s:7:"apSUCat";s:2:"IT";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";}}";
  _wp_rp_related_posts_query_result_cache_expiration: '1509855502'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:3:"687";s:5:"score";s:17:"212.4956101536288";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:3:"668";s:5:"score";s:18:"211.72800899316005";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:3:"729";s:5:"score";s:17:"161.2379672541191";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:3:"878";s:5:"score";s:18:"129.38057239055087";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"1566";s:5:"score";s:17:"91.71773936415096";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"1494";s:5:"score";s:17:"87.33578793604404";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:4:"2586";s:5:"score";s:17:"69.52967369544045";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"2254";s:5:"score";s:17:"65.60115512038305";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"3249";s:5:"score";s:17:"62.86218063478901";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"2646";s:5:"score";s:17:"62.22835721285298";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:4:"3214";s:5:"score";s:17:"59.78569812930529";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"7243";s:5:"score";s:18:"59.557055956672784";}}
  _wp_rp_image: '3673'
  dsq_thread_id: '3351503712'
author:
  login: larry.e.smith.jr
  email: larry.e.smith.jr@gmail.com
  display_name: mrlesmithjr
  first_name: Larry
  last_name: Smith
---
<p>In this guide we will be setting up a mail proxy and spam checker that will run transparently.  This will be running on our Ubuntu UTM server that we have been building and you can check out <a title="http://everythingshouldbevirtual.com/ubuntu-utm-homebrew" href="http://everythingshouldbevirtual.com/ubuntu-utm-homebrew">Part 1</a> and <a title="http://everythingshouldbevirtual.com/ubuntu-utm-homebrew-network-graphing" href="http://everythingshouldbevirtual.com/ubuntu-utm-homebrew-network-graphing">Part 2</a> as well.</p>
<p>We will be using <a href="http://www.exim.org/" target="_blank">EXIM4</a> (Using google as a smarthost), <a href="http://p3scan.sourceforge.net/" target="_blank">P3SCAN</a>, <a href="http://spamassassin.apache.org/" target="_blank">SpamAssassin</a> and <a href="http://www.clamav.net/" target="_blank">clamav</a> (already installed from part 1 of the UTM setup).</p>
<p>So let’s get started.</p>
<p>Install the packages we need for this all to work</p>
<pre>sudo apt-get install exim4 sa-exim spamassassin</pre>
<p>Now we need to configure exim to use Google as a smarthost</p>
<pre>sudo dpkg-reconfigure exim4-config</pre>
<p>Choose "Mail sent by smarthost...<br />
Set system mail name to whatever fits for you<br />
On the screen for "IP address or host name of outgoing smarthost" enter</p>
<pre>smtp.gmail.com::587</pre>
<p>(two colons)<br />
Now we need to configure exim with the username/password to use for relaying to work through google</p>
<pre>sudo nano /etc/exim4/passwd.client</pre>
<p>add these lines to the end of the file</p>
<pre>smtp.gmail.com:youremail@gmail.com:PaSsWoRd
gmail-smtp.l.google.com:youremail@gmail.com:PaSsWoRd
*.google.com:youremail@gmail.com:PaSsWoRd</pre>
<p>Now we need to configure the iptables rules for the redirect to work as traffic passes through our bridged utm server and flows through p3scan.  This will be accomplished by adding the following rules.</p>
<pre>sudo iptables -t nat -A PREROUTING -i br0 -p tcp -m tcp --dport 25 -j REDIRECT --to-port 8110
sudo iptables -t nat -A PREROUTING -i br0 -p tcp -m tcp --dport 110 -j REDIRECT --to-port 8110
sudo iptables -t nat -A PREROUTING -i br0 -p tcp -m tcp --dport 143 -j REDIRECT --to-port 8110</pre>
<p>Now we should have a working mail proxy and spam checker as email flows start passing through the UTM.  This will only work with smtp (tcp/25), pop3 (tcp/110) and imap (tcp/143).  This setup will not work with any web based email.  You can verify that email is getting redirected through the proxy using the following command.</p>
<pre>sudo iptables -L -v -n -t nat</pre>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2012/11/image.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="image" alt="image" src="{{ site.baseurl }}/assets/image_thumb.png" width="910" height="234" border="0" /></a></p>
<p>And there you go. If you have any questions please let me know.</p>
