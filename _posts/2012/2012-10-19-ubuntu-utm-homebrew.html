---
layout: post
title: Ubuntu UTM Homebrew - Part 1 - Web Filtering
date: 2012-10-19 10:06:49.000000000 -04:00
type: post
published: true
status: publish
categories:
- Linux
- Security
- Ubuntu
- UTM
- Virtualization
- VMware
tags:
- 127.0.0.1
- apple
- clamav
- dansguardian
- ebtables
- havp
- iptables
- itunes
- squid
- transparent proxy
- UTM
- VMware
meta:
  _edit_last: '11'
  fb_social_plugin_settings_box_subscribe: default
  fb_social_plugin_settings_box_recommendations_bar: default
  _s2mail: 'yes'
  _jd_tweet_this: 'yes'
  al2fb_facebook_link_id: '1329619822_3806155795635'
  al2fb_facebook_link_time: '2012-10-19T14:06:52+00:00'
  al2fb_facebook_link_picture: post=http://everythingshouldbevirtual.com/wp-content/uploads/2012/10/09-23-40-222x300.png
  _wp_jd_wp: http://wp.me/p2C5rM-aM
  _wp_jd_target: http://wp.me/p2C5rM-aM
  _jd_wp_twitter: 'a:6:{i:0;s:75:"#ElRetardoLand New post: Ubuntu UTM Homebrew http://wp.me/p2C5rM-aM
    #VMware";i:1;s:78:"#ElRetardoLand Post Edited: Ubuntu UTM Homebrew http://wp.me/p2C5rM-aM
    #VMware";i:2;s:80:"#ElRetardoLand Ubuntu UTM Homebrew http://wp.me/p2C5rM-aM #ubuntu
    #itunes #apple";i:3;s:89:"#ElRetardoLand Ubuntu UTM Homebrew - Part 1 http://wp.me/p2C5rM-aM
    #ubuntu #itunes #apple";i:4;s:105:"#ElRetardoLand Ubuntu UTM Homebrew - Part 1
    - Web Filtering http://wp.me/p2C5rM-aM #ubuntu #itunes #apple";i:5;s:105:"#ElRetardoLand
    Ubuntu UTM Homebrew - Part 1 - Web Filtering http://wp.me/p2C5rM-aM #ubuntu #itunes
    #apple";}'
  _jd_twitter: "#title# #url# #ubuntu #itunes #apple"
  _wpt_failed: 'a:5:{s:6:"author";s:0:"";s:8:"sentence";s:105:"#ElRetardoLand Ubuntu
    UTM Homebrew - Part 1 - Web Filtering http://wp.me/p2C5rM-aM #ubuntu #itunes #apple";s:5:"error";s:71:"This
    tweet is identical to another Tweet recently sent to this account.";s:4:"code";s:3:"403";s:9:"timestamp";s:10:"1352163187";}'
  snapEdIT: '1'
  snapFB: s:147:"a:1:{i:0;a:4:{s:8:"PostType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:4:"doFB";i:0;}}";
  snapLI: s:156:"a:1:{i:0;a:4:{s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:4:"doLI";i:0;s:11:"SNAPformatT";s:6:"&nbsp;";}}";
  snapSU: s:96:"a:1:{i:0;a:3:{s:7:"apSUCat";s:2:"IT";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:4:"doSU";i:0;}}";
  snapTW: s:95:"a:1:{i:0;a:3:{s:10:"SNAPformat";s:15:"%TITLE% - %URL%";s:8:"attchImg";s:1:"0";s:4:"doTW";i:0;}}";
  _wp_rp_related_posts_query_result_cache_expiration: '1512028301'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:3:"699";s:5:"score";s:18:"424.18093961040796";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:3:"687";s:5:"score";s:18:"136.65574364569267";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:3:"729";s:5:"score";s:18:"102.88006655699454";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:3:"878";s:5:"score";s:17:"92.87537637492039";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"1402";s:5:"score";s:17:"74.96554890079786";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"3214";s:5:"score";s:18:"57.106349856153884";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:4:"1566";s:5:"score";s:17:"53.93911484070922";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"1662";s:5:"score";s:17:"46.08464434773563";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"2854";s:5:"score";s:17:"44.66437440899173";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"2586";s:5:"score";s:17:"44.52080724460522";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:3:"939";s:5:"score";s:18:"43.579118410667476";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"1695";s:5:"score";s:18:"42.501125409176296";}}
  dsq_thread_id: '3346749556'
  dsq_needs_sync: '1'
  _wp_rp_image: '4006'
author:
  login: larry.e.smith.jr
  email: larry.e.smith.jr@gmail.com
  display_name: mrlesmithjr
  first_name: Larry
  last_name: Smith
---
<p>I wrote <a title="http://everythingshouldbevirtual.com/super-router-pfsense-untangle/" href="http://everythingshouldbevirtual.com/super-router-pfsense-untangle/" target="_blank">this</a> guide the a few days ago and this solution worked great. But what if you want to have more control of your threat management and build your own. So that is what we are going to do here. We are going to build an inline filtering solution using Ubuntu using ESXi.</p>
<p>**Note I am using PFSense as my firewall. So it is configured with the first NIC connected to the WAN (RED), and the second NIC is connected to the "Crossover" network and configured with IP 192.168.1.1. (Reference Picture below)***</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2012/10/09-23-40.png"><img class="alignnone size-medium wp-image-669" title="09-23-40" alt="" src="{{ site.baseurl }}/assets/09-23-40-222x300.png" width="222" height="300" /></a></p>
<p>So here we go.</p>
<p>Build a fresh new Ubuntu 12.04 LTS server.</p>
<p>Configure your first NIC to connect to your vSwitch without any physical NICS. In my setup this network is called "Crossover". (Reference picture above)</p>
<p>Configure your second NIC to connect to your vSwitch that is used for your LAN network. In my setup this network is called "Green". (Reference picture above)</p>
<p>Make your /etc/network/interfaces look like this</p>
<pre>sudo nano /etc/network/interfaces

auto lo
iface lo inet loopback
#bridge network
iface eth0 inet manual
iface eth1 inet manual

auto br0
iface br0 inet static
address 192.168.1.2
netmask 255.255.255.0
gateway 192.168.1.1
dns-nameservers 192.168.1.1
bridge_ports eth0 eth1</pre>
<p>Had to add these lines too. Was getting a consistent timeout pinging firewall every couple of seconds.</p>
<pre>bridge_fd 0

bridge_stp off ***This is the default but added it as a placeholder***

bridge_maxage 0

bridge_ageing 0

bridge_maxwait 0

#IPTables rules
pre-up iptables-restore &lt; /etc/iptables.rules post-down iptables-save &gt; /etc/iptables.rules

#EBTables rules
pre-up ebtables -t broute -A BROUTING -p IPv4 --ip-protocol 6 --ip-destination-port 80 -j redirect --redirect-target ACCEPT</pre>
<p>Now run this command</p>
<pre>sudoÂ iptables -t nat -A PREROUTING -i br0 -p tcp --dport 80 -j REDIRECT --to-port 8080</pre>
<p>Run this command to save the IPTables rules.</p>
<pre>sudo iptables-save &gt; /etc/iptables.rules</pre>
<p>Now edit /etc/sysctl.conf</p>
<pre>sudo nano /etc/sysctl.conf</pre>
<p>and uncomment the following</p>
<pre>net.ipv4.ip_forward=1
net.ipv6.conf.all.forwarding=1</pre>
<p>Now reboot your server and you should be able to communicate out to the internet now.</p>
<p>Open a command prompt and ping your firewall and the server we are building here. You should see request timed out while the UTM server is rebooting for both the firewall and UTM. Then you will start getting a response from the UTM and then the firewall as it builds the bridge. You will see a few drops after the intial ping reply and then all should be good.</p>
<p>Now run</p>
<pre>sudo apt-get update &amp;&amp; sudo apt-get upgrade</pre>
<p>Once that finishes run</p>
<pre>sudo apt-get install squid3 ebtables bridge-utils dansguardian havp clamav clamav-freshclam</pre>
<p>Now we need to make squid, dansguardian and havp all work together.</p>
<pre>sudo nano /etc/dansguardian/dansguardian.conf</pre>
<p>and make the following changes</p>
<p>comment out the line that says UNCONFIGURED by placing a # in front of the line.</p>
<pre># the port that DansGuardian listens to.
filterport = 8080

# the ip of the proxy (default is the loopback - i.e. this server)
proxyip = 127.0.0.1

# the port DansGuardian connects to proxy on
proxyport = 8090</pre>
<p>Now run</p>
<pre>sudo nano /etc/squid3/squid.conf</pre>
<p>change</p>
<pre>acl localnet src 192.168.1.0/24</pre>
<p>(or whatever subnet your LAN is)</p>
<p>and change</p>
<pre>http_port 3128</pre>
<p>to</p>
<pre>http_port 3128 transparent</pre>
<p>Now run</p>
<pre>sudo nano /etc/havp/havp.config</pre>
<p>and add the following</p>
<pre>PARENTPROXY 127.0.0.1
PARENTPORT 3128
PORT 8090
ENABLECLAMLIB true
CLAMDBDIR /var/lib/clamav</pre>
<p>Now reboot your new Ubuntu UTM and you should now be utilizing the UTM for normal http usage. Try to go to playboy.com or some other adult website and you should see the following.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2012/10/10-00-51.png"><img class="alignnone size-medium wp-image-671" title="10-00-51" alt="" src="{{ site.baseurl }}/assets/10-00-51-300x236.png" width="300" height="236" /></a></p>
<p>Go to <a title="http://www.eicar.org/download/eicar.com.txt" href="http://www.eicar.org/download/eicar.com.txt" target="_blank">this</a> link and you should see the following.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2012/10/10-02-18.png"><img class="alignnone size-medium wp-image-672" title="10-02-18" alt="" src="{{ site.baseurl }}/assets/10-02-18-300x234.png" width="300" height="234" /></a></p>
<p>Once that is verified that it is working. You are good to go. There are many other tweaks and such that you can do with Dansguardian, but I am not going into that here in this guide. But I would recommend looking up how to use the blacklists from <a title="http://www.shallalist.de/" href="http://www.shallalist.de/" target="_blank">Shallalist</a>.</p>
<p>&nbsp;</p>
<p>Enjoy!</p>
<p>&nbsp;</p>
<p>****UPDATE**** Thanks to Apple and their bullshit you will need to add the following to your squid.conf file to get iTunes working. iTunes apparently has a major issue working through a proxy correctly.</p>
<p>Because we are only redirecting normal http traffic this regexp is the only one required. So add both lines to /etc/squid3/squid.conf and restart squid.</p>
<pre>acl Apple url_regex ^https?://([A-Za-z0-9.-]*\.)?apple\.com/

cache deny Apple</pre>
<p>While you are in squid.conf you might want to go ahead and add the following as well.</p>
<pre>acl Adobe url_regex ^https?://([A-Za-z0-9.-]*\.)?adobe\.com/
acl Windows_Update url_regex ^https?://([A-Za-z0-9.-]*\.)?windowsupdate\.com/
acl Microsoft url_regex ^https?://([A-Za-z0-9.-]*\.)?microsoft\.com/
acl YouTube url_regex ^http://[A-Za-z0-9.]+\.youtube\.com/videoplayback
acl GoogleVideo url_regex ^http://[A-Za-z0-9.]+\.googlevideo\.com/videoplayback
acl OVI url_regex ^https?://[A-Za-z0-9.-]*\.ovi\.com

cache deny Apple
cache deny Adobe
cache deny Windows_Update
cache deny Microsoft
cache deny YouTube
cache deny GoogleVideo
cache deny OVI</pre>
<p>**Update**</p>
<p>If you want to monitor your squid logs and get the real IP of the client request do the following. I am using Sarg to squid reporting.</p>
<pre>sudo nano /etc/dansguardian/dansguardian.conf</pre>
<p>change line</p>
<pre>forwardedfor = on</pre>
<p>(make sure it is on)</p>
<pre>sudo nano /etc/squid3/squid.conf</pre>
<p>change line</p>
<pre>forwarded_for on</pre>
<p>(make sure it is set to on)</p>
<pre>sudo nano /etc/havp/havp.config</pre>
<p>change line</p>
<pre>FORWARDED_IP true</pre>
<p>(default is false)</p>
<p>change line</p>
<pre>X_FORWARDED_FOR true</pre>
<p>(default is false)</p>
<pre>sudo /etc/init.d/squid3 restart &amp;&amp; /etc/init.d/dansguardian restart &amp;&amp; /etc/init.d/havp stop &amp;&amp; /etc/init.d/havp start</pre>
<p>Now your squid logs will show the correct client IP addresses instead of 127.0.0.1</p>
<p>Remember the flow is Dansguardian, HAVP and then Squid</p>
<p>&nbsp;</p>
<p>Part 2 is <a title="http://everythingshouldbevirtual.com/ubuntu-utm-homebrew-network-graphing" href="http://everythingshouldbevirtual.com/ubuntu-utm-homebrew-network-graphing">here</a></p>
<p>Part 3 is <a title="http://everythingshouldbevirtual.com/ubuntu-utm-homebrew-part-3-mail-proxy-and-spam-checker" href="http://everythingshouldbevirtual.com/ubuntu-utm-homebrew-part-3-mail-proxy-and-spam-checker">here</a></p>
<p>&nbsp;</p>
