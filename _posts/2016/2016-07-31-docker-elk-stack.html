---
layout: post
title: Docker - Ansible - ELK Stack
date: 2016-07-31 19:54:07.000000000 -04:00
type: post
published: true
status: publish
categories:
- Ansible
- Docker
tags:
- Ansible
- Docker
meta:
  _s2mail: 'yes'
  _yoast_wpseo_primary_category: '444'
  _yoast_wpseo_content_score: '30'
  wp_github_commits_page_fields: a:3:{s:15:"gc_widget_title";s:0:"";s:11:"github_user";s:0:"";s:11:"github_repo";s:0:"";}
  catchbox-sidebarlayout: default
  snap_MYURL: ''
  _yoast_wpseo_focuskw_text_input: Docker - Ansible - ELK Stack
  _yoast_wpseo_focuskw: Docker - Ansible - ELK Stack
  _snap_forceSURL: '2'
  _edit_last: '7644'
  snapEdIT: '1'
  snapDL: s:162:"a:1:{i:0;a:6:{s:2:"do";s:1:"1";s:10:"msgTFormat";s:7:"%TITLE%";s:9:"msgFormat";s:9:"%EXCERPT%";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:4:"doDL";s:1:"1";}}";
  snapTW: 's:329:"a:1:{i:0;a:10:{s:2:"do";s:1:"1";s:10:"SNAPformat";s:55:"%TITLE%
    - %URL% #Docker #Ansible #ELK #ELKStack #DevOPS";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:4:"doTW";s:1:"1";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"759900029725270016";s:5:"pDate";s:19:"2016-07-31
    23:54:20";}}";'
  _yoast_wpseo_linkdex: '72'
  snap_isAutoPosted: '1'
  snapFB: s:298:"a:1:{i:0;a:10:{s:2:"do";s:1:"1";s:8:"postType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:4:"doFB";s:1:"1";s:11:"isPrePosted";s:1:"1";}}";
  snapLI: s:290:"a:1:{i:0;a:10:{s:2:"do";s:1:"1";s:8:"postType";s:1:"A";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:12:"liMsgFormatT";s:1:" ";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:4:"doLI";s:1:"1";s:11:"isPrePosted";s:1:"1";}}";
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:4:"7064";s:5:"score";s:18:"100.83452876650523";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:4:"6883";s:5:"score";s:17:"96.42705024988132";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:4:"6912";s:5:"score";s:17:"65.03934590282933";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:4:"4695";s:5:"score";s:17:"54.25463573593379";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"5057";s:5:"score";s:17:"51.88951831630902";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"4803";s:5:"score";s:17:"45.48077603897839";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:4:"4411";s:5:"score";s:18:"43.567491984241386";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"6225";s:5:"score";s:16:"42.5458407367224";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"5798";s:5:"score";s:16:"42.5458407367224";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"4968";s:5:"score";s:17:"41.46160955187925";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:4:"5498";s:5:"score";s:18:"40.098289873387245";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"4915";s:5:"score";s:18:"40.098289873387245";}}
  _wp_rp_image: empty
  snapSU: s:337:"a:1:{i:0;a:11:{s:2:"do";s:1:"1";s:9:"msgFormat";s:16:"%TITLE% - %TEXT%";s:5:"suCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:4:"doSU";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:6:"1tryk1";s:7:"postURL";s:50:"http://www.stumbleupon.com/content/1tryk1/comments";s:5:"pDate";s:19:"2016-07-31
    23:54:19";}}";
  _wp_rp_related_posts_query_result_cache_expiration: '1511772774'
author:
  login: mrlesmithjr
  email: mrlesmithjr@gmail.com
  display_name: Larry Smith Jr.
  first_name: ''
  last_name: ''
---
<p style="text-align: center;"><strong>Docker - Ansible - ELK Stack</strong></p>
<hr />
<p style="text-align: left;">In this post we will be going over setting up a quick and easy way to standup ELK Stack using Docker containers for each of our components required. Keep in mind that this will just cover the basics and not going into depth on advanced GROK filtering and etc. But you can definitely add that functionality if the desire is there. Now I have chosen a different method of creating and maintaining my Docker containers by using Ansible to do most of the configurations vs. using a ton of bash. The downside is that the containers are a little larger is size due to the overhead of Ansible being installed. I can deal with that though for the flexibility. Also I am keeping an eye the <a href="https://www.ansible.com/ansible-container">ansible-container</a> solution as well as it seems it is more along the lines of how I choose to maintain my containers. I also published another <a href="http://everythingshouldbevirtual.com/docker-building-containers-using-ansible">post</a> earlier this year around the idea of using Ansible to provision containers but was actually leveraging some of the Ansible roles that I had already created. I have chosen to not do this going forward (at least for now).</p>
<p style="text-align: left;">I would like to touch briefly on each component providing the <em><strong>Dockerfile</strong></em> and <em><strong>playbook.yml</strong></em>Â used. For each component I have also included the link to the corresponding GitHub repository for reference and more detail.</p>
<p><a href="https://github.com/mrlesmithjr/docker-ansible-elasticsearch"><strong>Elasticsearch</strong></a></p>
<hr />
<blockquote><p>Dockerfile</p></blockquote>
<pre>FROM ubuntu:14.04

MAINTAINER Larry Smith Jr. &lt;mrlesmithjr@gmail.com&gt;

# Update apt-cache
RUN apt-get update

# Install Ansible
RUN apt-get -y install git software-properties-common &amp;&amp; \
    apt-add-repository ppa:ansible/ansible &amp;&amp; \
    apt-get update &amp;&amp; \
    apt-get -y install ansible

# Copy Ansible Playbook
COPY playbook.yml /playbook.yml

# Run Ansible playbook
RUN ansible-playbook -i "localhost," -c local /playbook.yml

# Cleanup
RUN apt-get -y clean &amp;&amp; \
    apt-get -y autoremove &amp;&amp; \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

ENV PATH /usr/share/elasticsearch/bin:$PATH

WORKDIR /usr/share/elasticsearch

# Setup entrypoint Ansible Playbook
COPY docker-entrypoint.yml /docker-entrypoint.yml

# Setup entrypoint script
COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh
RUN ln -s usr/local/bin/docker-entrypoint.sh /entrypoint.sh

ENTRYPOINT ["docker-entrypoint.sh"]

COPY config /usr/share/elasticsearch/config

# Setup volume
VOLUME /usr/share/elasticsearch/data

# Expose port(s)
EXPOSE 9200 9300

# Container start-up
CMD ["elasticsearch"]
</pre>
<blockquote><p>playbook.yml</p></blockquote>
<pre>---
- hosts: localhost
  connection: local
  become: true
  vars:
    - gosu_ver: 1.9
  tasks:
    - name: Installing apt-transport-https
      apt:
        name: "apt-transport-https"
        state: "present"

    - name: Installing ca-certificates
      apt:
        name: "ca-certificates"
        state: "latest"

    - name: Installing dumb-init
      apt:
        deb: "https://github.com/Yelp/dumb-init/releases/download/v1.0.2/dumb-init_1.0.2_amd64.deb"

    - name: Installing gosu
      get_url:
        url: "https://github.com/tianon/gosu/releases/download/{{ gosu_ver }}/gosu-amd64"
        dest: "/usr/local/bin/gosu"
        mode: 0755

    - name: Installing JRE
      apt:
        name: "default-jre-headless"
        state: "present"

    - name: Adding Elasticsearch Repo Key
      apt_key:
        url: "https://packages.elastic.co/GPG-KEY-elasticsearch"
        state: "present"

    - name: Adding Elasticsearch Repo
      apt_repository:
        repo: "deb https://packages.elastic.co/elasticsearch/2.x/debian stable main"

    - name: Installing Elasticsearch
      apt:
        name: "elasticsearch"
        state: "present"
        install_recommends: no

    - name: Ensuring Elasticsearch Folders Exist
      file:
        path: "/usr/share/elasticsearch/{{ item }}"
        state: "directory"
        owner: "elasticsearch"
        group: "elasticsearch"
      with_items:
        - 'data'
        - 'logs'
        - 'config'
        - 'config/scripts'
</pre>
<p><a href="https://github.com/mrlesmithjr/docker-ansible-logstash"><strong>Logstash</strong></a></p>
<hr />
<blockquote><p>Dockerfile</p></blockquote>
<pre>FROM ubuntu:14.04

MAINTAINER Larry Smith Jr. &lt;mrlesmithjr@gmail.com&gt;

# Update apt-cache
RUN apt-get update

# Install Ansible
RUN apt-get -y install git software-properties-common &amp;&amp; \
    apt-add-repository ppa:ansible/ansible &amp;&amp; \
    apt-get update &amp;&amp; \
    apt-get -y install ansible

# Copy Ansible Playbook
COPY playbook.yml /playbook.yml

# Run Ansible playbook
RUN ansible-playbook -i "localhost," -c local /playbook.yml

# Cleanup
RUN apt-get -y clean &amp;&amp; \
    apt-get -y autoremove &amp;&amp; \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

ENV PATH /opt/logstash/bin:$PATH

# necessary for 5.0+ (overriden via "--path.settings", ignored by &lt; 5.0)
ENV LS_SETTINGS_DIR /etc/logstash
# comment out some troublesome configuration parameters
#   path.log: logs should go to stdout
#   path.config: No config files found: /etc/logstash/conf.d/*
RUN set -ex \
	&amp;&amp; if [ -f "$LS_SETTINGS_DIR/logstash.yml" ]; then \
		sed -ri 's!^(path.log|path.config):!#&amp;!g' "$LS_SETTINGS_DIR/logstash.yml"; \
	fi

# Setup entrypoint Ansible Playbook
COPY docker-entrypoint.yml /docker-entrypoint.yml

# Setup entrypoint script
COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh
RUN ln -s usr/local/bin/docker-entrypoint.sh /entrypoint.sh

ENTRYPOINT ["docker-entrypoint.sh"]

COPY config/ /etc/logstash/conf.d

# Setup volume
VOLUME /etc/logstash/conf.d

# Expose Port(s)
EXPOSE 514 514/udp 5044 10514 10514/udp

# Container start-up
CMD ["logstash", "agent", "-f", "/etc/logstash/conf.d/"]
</pre>
<blockquote><p>playbook.yml</p></blockquote>
<pre>---
- hosts: localhost
  connection: local
  become: true
  vars:
    - gosu_ver: '1.9'
    - logstash_ver: '2.3'
  tasks:
    - name: Installing apt-transport-https
      apt:
        name: "apt-transport-https"
        state: "present"

    - name: Installing ca-certificates
      apt:
        name: "ca-certificates"
        state: "latest"

    - name: Installing Logstash Plugins Pre-Reqs
      apt:
        name: "{{ item }}"
        state: "present"
        install_recommends: no
      with_items:
        - 'libzmq3'

    - name: Ensuring /usr/local/lib Exists
      file:
        path: "/usr/local/lib"
        state: "directory"

    # - name: Symlinking libzmq.so
    #   file:
    #     src: "/usr/lib/*/libzmq.so.3"
    #     dest: "/usr/local/lib/libzmq.so"
    #     state: "link"

    - name: Installing dumb-init
      apt:
        deb: "https://github.com/Yelp/dumb-init/releases/download/v1.0.2/dumb-init_1.0.2_amd64.deb"

    - name: Installing gosu
      get_url:
        url: "https://github.com/tianon/gosu/releases/download/{{ gosu_ver }}/gosu-amd64"
        dest: "/usr/local/bin/gosu"
        mode: 0755

    - name: Installing JRE
      apt:
        name: "default-jre-headless"
        state: "present"

    - name: Adding Elasticsearch Repo Key
      apt_key:
        url: "https://packages.elastic.co/GPG-KEY-elasticsearch"
        state: "present"

    - name: Adding Logstash Repo
      apt_repository:
        repo: "deb https://packages.elastic.co/logstash/{{ logstash_ver }}/debian stable main"

    - name: Installing Logstash
      apt:
        name: "logstash"
        state: "present"
        install_recommends: no

# We are doing this to redirect TCP/514 and UDP/514 to Logstash on TCP/10514
    - name: Configuring Rsyslogd 50-default.conf
      lineinfile:
        line: "*.* @@127.0.0.1:10514"
        dest: "/etc/rsyslog.d/50-default.conf"

# We are doing this to enable Rsyslogd to listen on tcp/514 and udp/514
    - name: Configuring Rsyslogd To Listen On TCP/514 and UDP/514
      lineinfile:
        dest: "/etc/rsyslog.conf"
        line: "{{ item }}"
      with_items:
        - '$ModLoad imudp'
        - '$UDPServerRun 514'
        - '$ModLoad imtcp'
        - '$InputTCPServerRun 514'
</pre>
<blockquote><p>logstash.conf</p></blockquote>
<pre>input {
  beats {
    port =&gt; 5044
  }
}

input {
  tcp {
    type =&gt; "syslog"
    port =&gt; "10514"
  }
}

input {
  udp {
    type =&gt; "syslog"
    port =&gt; "10514"
  }
}

output {
  elasticsearch {
    hosts =&gt; ["http://elasticsearch:9200"]
  }
}
</pre>
<p><a href="https://github.com/mrlesmithjr/docker-ansible-kibana"><strong>Kibana</strong></a></p>
<hr />
<blockquote><p>Dockerfile</p></blockquote>
<pre>FROM ubuntu:14.04

MAINTAINER Larry Smith Jr. &lt;mrlesmithjr@gmail.com&gt;

# Update apt-cache
RUN apt-get update

# Install Ansible
RUN apt-get -y install git software-properties-common &amp;&amp; \
    apt-add-repository ppa:ansible/ansible &amp;&amp; \
    apt-get update &amp;&amp; \
    apt-get -y install ansible

# Copy Ansible Playbook
COPY playbook.yml /playbook.yml

# Run Ansible playbook
RUN ansible-playbook -i "localhost," -c local /playbook.yml

# Cleanup
RUN apt-get -y clean &amp;&amp; \
    apt-get -y autoremove &amp;&amp; \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

ENV PATH /opt/kibana/bin:$PATH

# Setup entrypoint Ansible Playbook
COPY docker-entrypoint.yml /docker-entrypoint.yml

# Setup entrypoint script
COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh
RUN ln -s usr/local/bin/docker-entrypoint.sh /entrypoint.sh

ENTRYPOINT ["docker-entrypoint.sh"]

# Expose port(s)
EXPOSE 5601

# Container start-up
CMD ["kibana"]
</pre>
<blockquote><p>playbook.yml</p></blockquote>
<pre>---
- hosts: localhost
  connection: local
  become: true
  vars:
    - gosu_ver: '1.9'
    - kibana_ver: '4.5'
    - tini_ver: 'v0.9.0'
  tasks:
    - name: Installing apt-transport-https
      apt:
        name: "apt-transport-https"
        state: "present"

    - name: Installing ca-certificates
      apt:
        name: "ca-certificates"
        state: "latest"

    - name: Installing dumb-init
      apt:
        deb: "https://github.com/Yelp/dumb-init/releases/download/v1.0.2/dumb-init_1.0.2_amd64.deb"

    - name: Installing gosu
      get_url:
        url: "https://github.com/tianon/gosu/releases/download/{{ gosu_ver }}/gosu-amd64"
        dest: "/usr/local/bin/gosu"
        mode: 0755

    - name: Installing tini
      get_url:
        url: "https://github.com/krallin/tini/releases/download/{{ tini_ver }}/tini"
        dest: "/usr/local/bin/tini"
        mode: 0755

    - name: Adding Elasticsearch Repo Key
      apt_key:
        url: "https://packages.elastic.co/GPG-KEY-elasticsearch"
        state: "present"

    - name: Adding Kibana Repo
      apt_repository:
        repo: "deb http://packages.elastic.co/kibana/{{ kibana_ver }}/debian stable main"

    - name: Installing Kibana
      apt:
        name: "kibana"
        state: "present"
        install_recommends: no

    - name: Ensuring Kibana Folder Permissions
      file:
        path: "/opt/kibana"
        owner: "kibana"
        group: "kibana"

    - name: Setting Default elasticsearch.url
      replace:
        dest: "/opt/kibana/config/kibana.yml"
        regexp: "^# elasticsearch.url: \"http://localhost:9200\""
        replace: "elasticsearch.url: \"http://elasticsearch:9200\""
</pre>
<p>&nbsp;</p>
<p><strong>Using docker-compose</strong></p>
<hr />
<p>And finally if we wanted to spin up the whole stack using docker-compose we can do that by creating the following <em><strong>docker-compose.yml</strong></em> file:</p>
<pre>version: '2'
services:
  elasticsearch:
    image: mrlesmithjr/elasticsearch:latest
    volumes:
      - "./.data:/usr/share/elasticsearch/data"
    ports:
      - "9200:9200"
      - "9300:9300"
    restart: always

  kibana:
    depends_on:
      - elasticsearch
    image: mrlesmithjr/kibana:latest
    links:
      - elasticsearch
    ports:
      - "5601:5601"
    restart: always

  logstash:
    depends_on:
      - elasticsearch
    image: mrlesmithjr/logstash:latest
    links:
      - elasticsearch
    ports:
      - "5044:5044"
      - "10514:10514"
      - "10514:10514/udp"
    restart: always
</pre>
<p>And then spin it all up:</p>
<pre>docker-compose up -d
</pre>
<p>Now fire up your browser of choice and head over to <a href="http://127.0.0.1:5601">http://127.0.0.1:5601</a>.</p>
<p>And there you have it, you now have a containerized ELK Stack ready for you to get creative with your GROKing.</p>
<p>&nbsp;</p>
<p><strong>Creating your own Logstash configuration</strong></p>
<hr />
<p>If you would like to change the included <em><strong>logstash.conf</strong></em> with your own you could create your own Logstash configurations and place them in the config folder and recreate your own <em><strong>Dockerfile</strong></em> as such for example:</p>
<blockquote><p>Dockerfile</p></blockquote>
<pre>FROM mrlesmithjr/logstash:latest

COPY config/ /etc/logstash/conf.d

EXPOSE 3515 10514 10514/udp
</pre>
<blockquote><p>config/logstash.conf</p></blockquote>
<pre>input {
  tcp {
    type =&gt; "syslog"
    port =&gt; "10514"
  }
}

input {
  udp {
    type =&gt; "syslog"
    port =&gt; "10514"
  }
}

input {
  tcp {
    type =&gt; "eventlog"
    port =&gt; "3515"
    codec =&gt; "json"
  }
}

output {
  elasticsearch {
    hosts =&gt;; ["http://elasticsearch:9200"]
  }
}
</pre>
<p>Now you are ready to build your new Docker container for Logstash:</p>
<pre>docker build -t mycustom/logstash .
</pre>
<p>And when that completes spin it up:</p>
<pre>docker run -d -p 3515:3515 -p 10514:10514 -p 10514:10514/udp mycustom/logstash
</pre>
<p>Now enjoy your new custom Logstash configuration but don't let your customization stop there. Head over to my GitHub repo <a href="https://github.com/mrlesmithjr/ansible-elk-processors/tree/master/templates/etc/logstash/conf.d">here</a> to get more ideas on your parsing and etc.</p>
<p>Hope you have enjoyed this post and I definitely look forward to any comments, thoughts, or opinions.</p>
<p>Enjoy!</p>
