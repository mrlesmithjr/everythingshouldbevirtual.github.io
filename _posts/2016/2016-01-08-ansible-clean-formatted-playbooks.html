---
layout: post
title: Ansible - Clean Formatted Playbooks
date: 2016-01-08 17:00:56.000000000 -05:00
type: post
published: true
status: publish
categories:
- Ansible
- Automation
tags:
- Ansible
- automation
meta:
  snapFB: s:350:"a:1:{i:0;a:10:{s:8:"postType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:9:"msgFormat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:2:"do";i:0;}}";
  catchbox-sidebarlayout: default
  _yoast_wpseo_content_score: '30'
  _wpcom_is_markdown: '1'
  _snap_forceSURL: '2'
  _yoast_wpseo_focuskw_text_input: Ansible - Clean Formatted Playbooks
  _s2mail: 'yes'
  wp_github_commits_page_fields: a:3:{s:15:"gc_widget_title";s:0:"";s:11:"github_user";s:0:"";s:11:"github_repo";s:0:"";}
  _edit_last: '7644'
  snap_MYURL: ''
  snapEdIT: '1'
  snapLI: s:331:"a:1:{i:0;a:10:{s:8:"postType";s:1:"A";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"SNAPformatT";s:1:" ";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:9:"msgFormat";s:41:"New
    post has been published on %SITENAME%";s:2:"do";i:0;}}";
  _yoast_wpseo_focuskw: Ansible - Clean Formatted Playbooks
  _yoast_wpseo_linkdex: '69'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:4:"4386";s:5:"score";s:17:"59.45187541709754";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:4:"4648";s:5:"score";s:18:"58.547905169611425";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:4:"4391";s:5:"score";s:17:"58.21379700025912";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:4:"4934";s:5:"score";s:17:"56.23299959222935";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"4619";s:5:"score";s:17:"56.23299959222935";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"4708";s:5:"score";s:17:"54.56304484032192";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:4:"4713";s:5:"score";s:17:"52.63288304814384";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"5734";s:5:"score";s:18:"52.248139262939844";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"7702";s:5:"score";s:17:"51.88349614926102";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"5057";s:5:"score";s:17:"51.88349614926102";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:4:"4962";s:5:"score";s:17:"51.88349614926102";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"7363";s:5:"score";s:17:"50.31797747076176";}}
  _wp_rp_related_posts_query_result_cache_expiration: '1510573503'
  _wp_rp_image: empty
  snapTW: 's:434:"a:1:{i:0;a:12:{s:10:"SNAPformat";s:71:"%TITLE% - %URL% #everythingshouldbevirtual
    #automation #DevOPS #ansible";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"685582621510746112";s:5:"pDate";s:19:"2016-01-08
    22:03:29";s:9:"msgFormat";s:42:"%TITLE% - %URL% #everythingshouldbevirtual";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:2:"do";i:0;}}";'
  snap_isAutoPosted: '1'
  snapDL: s:347:"a:1:{i:0;a:11:{s:11:"SNAPformatT";s:7:"%TITLE%";s:10:"SNAPformat";s:9:"%EXCERPT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:32:"7af1c3b7625310848ce742d95a66d96e";s:5:"pDate";s:19:"2016-01-08
    22:03:16";s:10:"msgTFormat";s:7:"%TITLE%";s:9:"msgFormat";s:9:"%EXCERPT%";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:2:"do";i:0;}}";
  snapSU: s:406:"a:1:{i:0;a:13:{s:7:"apSUCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:6:"2ZzCQJ";s:7:"postURL";s:50:"http://www.stumbleupon.com/content/2ZzCQJ/comments";s:5:"pDate";s:19:"2016-01-08
    22:03:28";s:9:"msgFormat";s:16:"%TITLE% - %TEXT%";s:5:"suCat";s:2:"IT";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:2:"do";i:0;}}";
  _yoast_wpseo_primary_category: ''
author:
  login: mrlesmithjr
  email: mrlesmithjr@gmail.com
  display_name: Larry Smith Jr.
  first_name: ''
  last_name: ''
---
<blockquote>
<p style="text-align: center;"><strong>Ansible - Clean Formatted Playbooks</strong></p>
</blockquote>
<p style="text-align: left;">While going through and doing some cleanup to various different roles and playbooks in my Ansible collection I wanted to share what I feel is good clean formatting. This will of course not be for everyone but I wanted to share this nonetheless. The goal of writing playbooks is clean formatted tasks and such to make them easily readable to other or even yourself when going back to look your playbooks. One thing I have noticed over time is that not everyone follows this and sometimes it is extremely difficult to understand what is going on and especially so for those who are just learning. So below you will find an example of an Ansible playbook that is running many different plays and utilizing roles throughout. Feel free to leave your thoughts so others may learn from this as well.</p>
<pre>---
- name: Configure DDI Nodes
  hosts: ddi-nodes
  become: true
#  remote_user: remote
  roles:
    - role: ansible-manage-lvm
      when: manage_lvm is defined and manage_lvm
      tags:
        - manage_lvm
    - role: ansible-config-interfaces
      tags:
        - config_interfaces
    - role: ansible-apache2
    - role: ansible-ntp
      tags:
        - config_ntp
    - role: ansible-mariadb-galera-cluster
    - role: ansible-logstash
      <strong>when: install_logstash is defined and install_logstash</strong>

- name: Configure Quagga on DDI Nameserver Nodes
  hosts: ddi-nameserver-nodes
  become: true
#  remote_user: remote
  roles:
    - role: ansible-quagga
      <strong>when: &gt;</strong>
            <strong>(install_quagga is defined and install_quagga) and</strong>
            <strong>(enable_pdns_anycast is defined and enable_pdns_anycast)</strong>

- name: Configure DDI Services on DDI Nameserver Nodes
  hosts: ddi-nameserver-nodes
  become: true
#  remote_user: remote
  tasks:
    - name: debian | uninstalling ISC-DHCP
      apt:
        name: isc-dhcp-server
        state: absent
      when: install_dhcp is defined and not install_dhcp
  roles:
    - role: ansible-powerdns
      when: install_dns is defined and install_dns
    - role: ansible-phpipam
      when: install_phpipam is defined and install_phpipam
    - role: ansible-isc-dhcp
      tags:
        - config_dhcp
      when: install_dhcp is defined and install_dhcp

- name: Configure DDI Services on DDI Nameserver RO Nodes
  hosts: ddi-nameserver-ro-nodes
  become: true
#  remote_user: remote
  tasks:
  roles:
    - role: ansible-config-interfaces
      tags:
        - config_interfaces
    - role: ansible-logstash
      when: install_logstash is defined and install_logstash
    - role: ansible-ntp
      tags:
        - config_ntp
    - role: ansible-powerdns
      when: install_dns is defined and install_dns
</pre>
<p>As you can see from above the when conditions are being derived from either the defaults in the roles themselves or from group_vars and/or host_vars. Also note the when conditions highlighted and see how we can write them differently. The second one is a good way to format a clean extended when condition so the whole when condition is not across the whole screen (I am guilty of this one as well).</p>
<p>How about another way to define these differently then using external var definitions? In the example below you will see how we can define within our playbook on how to define vars for specific roles within each of our plays in our playbook.</p>
<pre>---
- name: Configure DDI Nodes
  hosts: ddi-nodes
  become: true
#  remote_user: remote
  roles:
    - role: ansible-manage-lvm
      <strong>manage_lvm: true</strong>
      when: manage_lvm is defined and manage_lvm
      tags:
        - manage_lvm
    - role: ansible-config-interfaces
      tags:
        - config_interfaces
    - role: ansible-apache2
    - role: ansible-ntp
      tags:
        - config_ntp
    - role: ansible-mariadb-galera-cluster
    - role: ansible-logstash
      <strong>install_logstash: false</strong>
      when: install_logstash is defined and install_logstash

- name: Configure Quagga on DDI Nameserver Nodes
  hosts: ddi-nameserver-nodes
  become: true
#  remote_user: remote
  roles:
    - role: ansible-quagga
      <strong>install_quagga: false</strong>
      <strong>enable_pdns_anycast: false</strong>
      when: &gt;
            (install_quagga is defined and install_quagga) and
            (enable_pdns_anycast is defined and enable_pdns_anycast)

- name: Configure DDI Services on DDI Nameserver Nodes
  hosts: ddi-nameserver-nodes
  become: true
#  remote_user: remote
  tasks:
    - name: debian | uninstalling ISC-DHCP
      apt:
        name: isc-dhcp-server
        state: absent
      when: install_dhcp is defined and not install_dhcp
  roles:
    - role: ansible-powerdns
      <strong>install_dns: true</strong>
      when: install_dns is defined and install_dns
    - role: ansible-phpipam
      <strong>install_phpipam: true</strong>
      when: install_phpipam is defined and install_phpipam
    - role: ansible-isc-dhcp
      <strong>install_dhcp: true</strong>
      tags:
        - config_dhcp
      when: install_dhcp is defined and install_dhcp

- name: Configure DDI Services on DDI Nameserver RO Nodes
  hosts: ddi-nameserver-ro-nodes
  become: true
#  remote_user: remote
  tasks:
  roles:
    - role: ansible-config-interfaces
      tags:
        - config_interfaces
    - role: ansible-logstash
      <strong>install_logstash: true</strong>
      when: install_logstash is defined and install_logstash
    - role: ansible-ntp
      tags:
        - config_ntp
    - role: ansible-powerdns
      <strong>install_dns: true</strong>
      when: install_dns is defined and install_dns
</pre>
<p>As you can see from the highlighted lines dictate what our vars should be set to for that specific play against its respective role.</p>
<p>And yet one other example of defining variables for a whole play to be applied against all roles.</p>
<pre>---
- name: Configure DDI Nodes
  hosts: ddi-nodes
  become: true
#  remote_user: remote
  <strong>vars:</strong>
    <strong>install_logstash: false</strong>
    <strong>manage_lvm: true</strong>
  roles:
    - role: ansible-manage-lvm
      when: manage_lvm is defined and manage_lvm
      tags:
        - manage_lvm
    - role: ansible-config-interfaces
      tags:
        - config_interfaces
    - role: ansible-apache2
    - role: ansible-ntp
      tags:
        - config_ntp
    - role: ansible-mariadb-galera-cluster
    - role: ansible-logstash
      when: install_logstash is defined and install_logstash

- name: Configure Quagga on DDI Nameserver Nodes
  hosts: ddi-nameserver-nodes
  become: true
#  remote_user: remote
  <strong>vars:</strong>
    <strong>enable_pdns_anycast: false</strong>
    <strong>install_quagga: false</strong>
  roles:
    - role: ansible-quagga
      when: &gt;
            (install_quagga is defined and install_quagga) and
            (enable_pdns_anycast is defined and enable_pdns_anycast)

- name: Configure DDI Services on DDI Nameserver Nodes
  hosts: ddi-nameserver-nodes
  become: true
#  remote_user: remote
  <strong>vars:</strong>
    <strong>install_dhcp: true</strong>
    <strong>install_dns: true</strong>
    <strong>install_phpipam: true</strong>
    <strong>install_dhcp: true</strong>
  tasks:
    - name: debian | uninstalling ISC-DHCP
      apt:
        name: isc-dhcp-server
        state: absent
      when: install_dhcp is defined and not install_dhcp
  roles:
    - role: ansible-powerdns
      when: install_dns is defined and install_dns
    - role: ansible-phpipam
      when: install_phpipam is defined and install_phpipam
    - role: ansible-isc-dhcp
      tags:
        - config_dhcp
      when: install_dhcp is defined and install_dhcp

- name: Configure DDI Services on DDI Nameserver RO Nodes
  hosts: ddi-nameserver-ro-nodes
  become: true
#  remote_user: remote
  <strong>vars:</strong>
    <strong>install_dns: true</strong>
    <strong>install_logstash: true</strong>
  tasks:
  roles:
    - role: ansible-config-interfaces
      tags:
        - config_interfaces
    - role: ansible-logstash
      when: install_logstash is defined and install_logstash
    - role: ansible-ntp
      tags:
        - config_ntp
    - role: ansible-powerdns
      when: install_dns is defined and install_dns
</pre>
<p>As you can see from above we have defined all of our vars outside of the roles and within the actual play details.</p>
<p>The above are only a few examples of what I would consider writing good clean Ansible playbooks, tasks and etc.</p>
<p>One last item I would like to share is when writing Ansible handlers. One may assume that handlers can/or only look like the example below.</p>
<pre>- name: Example Handler Playbook
  hosts: all
  become: true
  vars:
    <strong>are_you_sure: false</strong>
    <strong>reconfigure_apache2: true</strong>
  handlers:
    - name: restart apache2
      service:
        name: apache2
        state: restarted
      <strong>when: are_you_sure is defined and are_you_sure</strong>
  tasks:
    - name: Reconfigure Apache2
      template:
        src: "etc/apache2/apache2.conf.j2"
        dest: "/etc/apache2/apache2/conf"
        owner: root
        group: root
        mode: 0644
      <strong>notify:</strong>
        <strong>- restart apache2</strong>
      <strong>when: reconfigure_apache2 is defined and reconfigure_apache2
</strong></pre>
<p>What is being shown above is that we can add a when condition to a handler as well. This short play would reconfigure Apache2 because we have <strong>reconfigure_apache2: true&nbsp;</strong>but the handler defined to notify the restart of apache2 will not occur because we have the variable<strong> are_you_sure: false</strong>.</p>
<p>This is all for now and hope this may find to be useful to others as well as encourage others to share their thoughts or even tips and tricks.</p>
<p>Enjoy!</p>
