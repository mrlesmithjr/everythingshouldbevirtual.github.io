---
layout: post
title: Vagrant - Complex Vagrantfile Configurations
date: 2016-03-09 00:43:25.000000000 -05:00
type: post
published: true
status: publish
categories:
- Vagrant
- Virtualization
tags:
- vagrant
meta:
  snapFB: s:298:"a:1:{i:0;a:10:{s:4:"doFB";s:1:"1";s:8:"postType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:2:"do";s:1:"1";s:11:"isPrePosted";s:1:"1";}}";
  snapLI: s:290:"a:1:{i:0;a:10:{s:4:"doLI";s:1:"1";s:8:"postType";s:1:"A";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:12:"liMsgFormatT";s:1:" ";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:2:"do";s:1:"1";s:11:"isPrePosted";s:1:"1";}}";
  _edit_last: '7644'
  _snap_forceSURL: '2'
  snap_MYURL: ''
  snapEdIT: '1'
  snapDL: s:370:"a:1:{i:0;a:12:{s:4:"doDL";s:1:"1";s:11:"SNAPformatT";s:7:"%TITLE%";s:10:"SNAPformat";s:9:"%EXCERPT%";s:2:"do";s:1:"1";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:32:"28d4fedefb5cd93f008934676c6c6e1a";s:5:"pDate";s:19:"2016-03-09
    05:43:26";s:10:"msgTFormat";s:7:"%TITLE%";s:9:"msgFormat";s:9:"%EXCERPT%";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";}}";
  snap_isAutoPosted: '1'
  _yoast_wpseo_primary_category: '4'
  _s2mail: 'yes'
  wp_github_commits_page_fields: a:3:{s:15:"gc_widget_title";s:0:"";s:11:"github_user";s:0:"";s:11:"github_repo";s:0:"";}
  _wp_rp_image: empty
  snapTW: 's:325:"a:1:{i:0;a:10:{s:4:"doTW";s:1:"1";s:10:"SNAPformat";s:51:"%TITLE%
    - %URL% #everythingshouldbevirtual #Vagrant";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:2:"do";s:1:"1";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"707441679855390722";s:5:"pDate";s:19:"2016-03-09
    05:43:34";}}";'
  _wp_rp_related_posts_query_result_cache_expiration: '1509525668'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:4:"5734";s:5:"score";s:18:"112.04893738633243";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:4:"4902";s:5:"score";s:17:"91.81487812342989";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:4:"5700";s:5:"score";s:17:"81.68011284491305";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:4:"4824";s:5:"score";s:16:"76.6600877031723";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"6225";s:5:"score";s:17:"75.14932116388088";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"4915";s:5:"score";s:17:"66.11880622868958";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:4:"4944";s:5:"score";s:18:"63.004301910182015";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"4803";s:5:"score";s:17:"62.63185711309633";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"4886";s:5:"score";s:17:"59.45439720833918";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"4934";s:5:"score";s:17:"56.14927253022295";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:4:"4879";s:5:"score";s:17:"56.14927253022295";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"6033";s:5:"score";s:17:"53.66695328296222";}}
  snapSU: s:429:"a:1:{i:0;a:14:{s:4:"doSU";s:1:"1";s:7:"apSUCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:2:"do";s:1:"1";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:6:"32MHPU";s:7:"postURL";s:50:"http://www.stumbleupon.com/content/32MHPU/comments";s:5:"pDate";s:19:"2016-03-09
    05:43:34";s:9:"msgFormat";s:16:"%TITLE% - %TEXT%";s:5:"suCat";s:2:"IT";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";}}";
author:
  login: mrlesmithjr
  email: mrlesmithjr@gmail.com
  display_name: Larry Smith Jr.
  first_name: ''
  last_name: ''
---
<blockquote><strong>Vagrant - Complex Vagrantfile Configurations</strong></p>
<hr />
</blockquote>
<p>&nbsp;</p>
<p>I will be using this a reference for adding various Vagrant configurations for setting up testing environments. I really just wanted to put this out here because some of these configurations have been difficult to find so hopefully they will be of some use to others.</p>
<pre># -*- mode: ruby -*-
# vi: set ft=ruby :

# All Vagrant configuration is done below. The "2" in Vagrant.configure
# configures the configuration version (we support older styles for
# backwards compatibility). Please don't change it unless you know what
# you're doing.

# ---- Define number of nodes to spin up ----
N = 1

# ---- Define any custom memory/cpu requirement ----
# if custom requirements are desired...ensure to set
# custom_cpu_mem == "yes" otherwise set to "no"
# By default if custom requirements are defined and set below
# any node not defined will be configured as the default...
# which is 1vCPU/512mb...So if setting custom requirements
# only define any node which requires more than the defaults.
nodes = [
  {
    :node =&gt; "node0",
    :box =&gt; "mrlesmithjr/trusty64",
    :cpu =&gt; 1,
    :mem =&gt; 1024
  }
]

# ---- Define variables below ----
additional_disks = "no"  #Define if additional drives defined should be added (yes | no)
additional_disks_controller = "SATA Controller"
additional_disks_num = 1  #Define the number of additional disks to add
additional_disks_size = 10  #Define disk size in GB
additional_nics = "yes"  #Define if additional network adapters should be created (yes | no)
additional_nics_dhcp = "yes"  #Define if additional network adapters should be DHCP assigned
additional_nics_num = 1  #Define the number of additional nics to add
ansible_groups = {
  "test-nodes" =&gt; [
    "node[0:#{N-1}"
  ]
}
box = "mrlesmithjr/trusty64"  #Define Vagrant box to load
custom_cpu_mem = "yes"  #Define if custom cpu and memory requirements are needed (yes| no)...defined within nodes variable above
desktop = "no"  #Define if running desktop OS (yes | no)
enable_custom_boxes = "no"  #Define if custom boxes should be used...defined in nodes var..
enable_port_forwards = "yes"  #Define if port forwards should be enabled
linked_clones = "no"  #Defines if nodes should be linked from master VM (yes | no)
port_forwards = [
  {
    :node =&gt; "node0",
    :guest =&gt; 3306,
    :host =&gt; 3306
  },
  {
    :node =&gt; "node0",
    :guest =&gt; 80,
    :host =&gt; 8080
  },
  {
    :node =&gt; "node0",
    :guest =&gt; 8000,
    :host =&gt; 8000
  }
]
provision_nodes = "yes"  #Define if provisioners should run (yes | no)
server_cpus = 1  #Define number of CPU cores...will be ignored if custom_cpu_mem == "yes"
server_memory = 512  #Define amount of memory to assign to node(s)...will be ignored if custom_cpu_mem == "yes"
subnet = "192.168.202."  #Define subnet for private_network (If not using DHCP)
subnet_ip_start = 200  #Define starting last octet of the subnet range to begin addresses for node(s)

Vagrant.configure(2) do |config|

  #Iterate over nodes
  (1..N).each do |node_id|
    nid = (node_id - 1)

    config.vm.define "node#{nid}" do |node|
      if enable_custom_boxes == "yes"
        box_set = "no"  #Initially set to no so it can be set to true if found in custom box defined
        nodes.each do |cust_box|
          if cust_box[:node] == "node#{nid}"
            node.vm.box = cust_box[:box]
            box_set = "yes"
          end
        end
        if box_set == "no"
          node.vm.box = box
        end
      end
      if enable_custom_boxes == "no"
        node.vm.box = box
      end
      node.vm.provider "virtualbox" do |vb|
        if linked_clones == "yes"
          vb.linked_clone = true
        end
        if custom_cpu_mem == "no"
          vb.customize ["modifyvm", :id, "--cpus", server_cpus]
          vb.customize ["modifyvm", :id, "--memory", server_memory]
        end
        if custom_cpu_mem == "yes"
          nodes.each do |cust_node|
            if cust_node[:node] == "node#{nid}"
              vb.customize ["modifyvm", :id, "--cpus", cust_node[:cpu]]
              vb.customize ["modifyvm", :id, "--memory", cust_node[:mem]]
            end
          end
        end
        if desktop == "yes"
          vb.gui = true
          vb.customize ["modifyvm", :id, "--graphicscontroller", "vboxvga"]
          vb.customize ["modifyvm", :id, "--accelerate3d", "on"]
          vb.customize ["modifyvm", :id, "--ioapic", "on"]
          vb.customize ["modifyvm", :id, "--vram", "128"]
          vb.customize ["modifyvm", :id, "--hwvirtex", "on"]
        end
        if additional_disks == "yes"
          (1..additional_disks_num).each do |disk_num|
            dnum = (disk_num + 1)
            ddev = ("node#{nid}_Disk#{dnum}.vdi")
            unless File.exist?("#{ddev}")
              vb.customize ['createhd', '--filename', ("#{ddev}"), '--variant', 'Fixed', '--size', additional_disks_size * 1024]
            end
            vb.customize ['storageattach', :id,  '--storagectl', "#{additional_disks_controller}", '--port', dnum, '--device', 0, '--type', 'hdd', '--medium', "node#{nid}_Disk#{dnum}.vdi"]
          end
        end
      end
      node.vm.hostname = "node#{nid}"

      ### Define additional network adapters below
      if additional_nics == "yes"
        if additional_nics_dhcp == "no"
          (1..additional_nics_num).each do |nic_num|
            nnum = Random.rand(0..50)
            node.vm.network :private_network, ip: subnet+"#{subnet_ip_start + nid + nnum}"
          end
        end
        if additional_nics_dhcp == "yes"
          (1..additional_nics_num).each do |nic_num|
            node.vm.network :private_network, type: "dhcp"
          end
        end
      end

      ### Define port forwards below
      if enable_port_forwards == "yes"
        port_forwards.each do |pf|
          if pf[:node] == "node#{nid}"
            node.vm.network "forwarded_port", guest: pf[:guest], host: pf[:host] + nid
          end
        end
      end
      if provision_nodes == "yes"
        if node_id == N
          node.vm.provision "ansible" do |ansible|  #runs bootstrap Ansible playbook
            ansible.limit = "all"
            ansible.playbook = "bootstrap.yml"
          end
          node.vm.provision "ansible" do |ansible|  #runs Ansible playbook for installing roles/executing tasks
            ansible.limit = "all"
            ansible.playbook = "playbook.yml"
            ansible.groups = ansible_groups
          end
        end
      end

    end
  end
  if provision_nodes == "yes"
    config.vm.provision :shell, path: "bootstrap.sh", keep_color: "true"  #runs initial shell script
  end
end
</pre>
<p>As you can tell from the above there is a lot going on. We have the ability to add additional disks, network adapters (with random generated IP addresses) and etc. using variables.</p>
<p>This is no where near a complete list but more or less just a brain-dump of some configurations that I will be putting together over time.</p>
<p>Below is another Vagrantfile built upon the one above with the additions of custom boxes...</p>
<p>https://gist.github.com/mrlesmithjr/7dec6018eef36600a64c0c873f2f60bf</p>
<p>Enjoy!</p>
