---
layout: post
title: Migrating VMs from PF9 KVM to ESXi
date: 2016-01-12 15:45:27.000000000 -05:00
type: post
published: true
status: publish
categories:
- KVM
- Virtualization
- VMware
- vSphere 5.5
- vSphere 6.0
tags:
- esxi
- KVM
- VMware
meta:
  _snap_forceSURL: '2'
  snap_MYURL: ''
  snapEdIT: '1'
  snapLI: s:271:"a:1:{i:0;a:9:{s:4:"doLI";s:1:"1";s:8:"postType";s:1:"A";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:11:"SNAPformatT";s:1:" ";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";}}";
  _edit_last: '7644'
  _s2mail: 'yes'
  wp_github_commits_page_fields: a:3:{s:15:"gc_widget_title";s:0:"";s:11:"github_user";s:0:"";s:11:"github_repo";s:0:"";}
  _yoast_wpseo_focuskw_text_input: Migrating VMs from PF9 to ESXi
  _yoast_wpseo_focuskw: Migrating VMs from PF9 to ESXi
  _yoast_wpseo_linkdex: '64'
  snap_isAutoPosted: '1'
  snapDL: s:242:"a:1:{i:0;a:7:{s:4:"doDL";s:1:"1";s:11:"SNAPformatT";s:7:"%TITLE%";s:10:"SNAPformat";s:9:"%EXCERPT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:32:"2419838e0c827074e2972da18bf03de6";s:5:"pDate";s:19:"2016-01-12
    20:46:00";}}";
  snapFB: s:280:"a:1:{i:0;a:9:{s:4:"doFB";s:1:"1";s:8:"postType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:11:"isPrePosted";s:1:"1";}}";
  snapSU: s:304:"a:1:{i:0;a:9:{s:4:"doSU";s:1:"1";s:7:"apSUCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:6:"2Z7YCk";s:7:"postURL";s:50:"http://www.stumbleupon.com/content/2Z7YCk/comments";s:5:"pDate";s:19:"2016-01-12
    20:46:08";}}";
  snapTW: 's:320:"a:1:{i:0;a:9:{s:4:"doTW";s:1:"1";s:10:"SNAPformat";s:64:"%TITLE%
    - %URL% #everythingshouldbevirtual #KVM #VMWare #vSphere";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"687012711301910528";s:5:"pDate";s:19:"2016-01-12
    20:46:09";}}";'
  _wp_rp_related_posts_query_result_cache_expiration: '1510604014'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:4:"7208";s:5:"score";s:17:"85.11651959808351";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:3:"623";s:5:"score";s:17:"73.83863017006351";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:4:"1402";s:5:"score";s:17:"67.87454167624948";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:3:"118";s:5:"score";s:17:"65.44275188465411";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:3:"747";s:5:"score";s:18:"63.610276581221996";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:3:"522";s:5:"score";s:17:"63.26580324610296";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:4:"1494";s:5:"score";s:17:"61.11159092119286";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"2329";s:5:"score";s:17:"58.50798454746045";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"1390";s:5:"score";s:18:"56.565458549385966";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"2586";s:5:"score";s:16:"54.9090593528993";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:2:"69";s:5:"score";s:17:"51.51818062401911";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"4145";s:5:"score";s:17:"51.15450418295972";}}
  _wp_rp_image: '5560'
author:
  login: mrlesmithjr
  email: mrlesmithjr@gmail.com
  display_name: Larry Smith Jr.
  first_name: ''
  last_name: ''
---
<p style="text-align: center;"><strong>Migrating VMs from PF9 KVM to ESXi</strong></p>
<p style="text-align: left;">I have been doing some testing over the past few months of Platform9 running on top of KVM and I have to admit that it has been a very good experience. However because my lab is a little resource lacking I wanted to begin converting my KVM hosts back into ESXi hosts to begin some additional testing coming soon. But before I could do this I wanted to migrate some of the VMs that I have been using for a while over to ESXi. How can I accomplish this I was thinking to myself. Luckily it is a fairly easy process and works very well.</p>
<p style="text-align: left;">First thing is first. You must have an existing ESXi host. I have one that was already running while my other two hosts were running KVM so I am good here.</p>
<p style="text-align: left;">The below process will be performed on an Ubuntu 14.04 LTS VM as an example. And I am using NFS for my datastores on ESXi and KVM as well so we need to make sure that both ESXi and KVM are attached to the same NFS mounts in order to do this in this example.</p>
<p style="text-align: left;">Log onto your KVM host and perform the following in the directory in which your PF9 images are stored. In my case I would do the following. Obviously we need to somehow determine which UUID is the correct one for the VM we want to manipulate.</p>
<p>Within your PF9 instances view identify the VM to obtain the instance name.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-12-at-2.55.02-PM-1024x293.png"><img class="alignnone wp-image-5492 size-full" src="{{ site.baseurl }}/assets/Screen-Shot-2016-01-12-at-2.55.02-PM-e1452830397633.png" alt="Screen Shot 2016-01-12 at 2.55.02 PM" width="1024" height="293" /></a></p>
<p>&nbsp;</p>
<p>The instance name for gerrit isÂ <strong>instance-000000be</strong> and make sure to shut it down.</p>
<pre>ssh kvm-01
sudo virsh list --all
</pre>
<pre> Id    Name                           State
----------------------------------------------------
 -     <strong>instance-000000be</strong>              shut off

</pre>
<p>And sure enough they match and it is shut off as we wanted.</p>
<p>Now we need to obtain the UUID of this instance.</p>
<pre>remote@kvm-01:~$ sudo virsh dominfo instance-000000be
Id:             -
Name:           <strong>instance-000000be</strong>
<strong>UUID:</strong>           <strong>91ecc01f-41f8-4f1d-a5a6-e25c0e558246</strong>
OS Type:        hvm
State:          shut off
CPU(s):         1
Max memory:     1048576 KiB
Used memory:    1048576 KiB
Persistent:     yes
Autostart:      disable
Managed save:   no
Security model: none
Security DOI:   0
</pre>
<p>From the above we determine that the UUID is <strong>91ecc01f-41f8-4f1d-a5a6-e25c0e558246</strong>.</p>
<p>Now we need to cd into the directory where this VM resides. In my case my PF9 data directory is <strong>/mnt/pf9/data/instances</strong>.</p>
<pre>cd /mnt/pf9/data/instances/91ecc01f-41f8-4f1d-a5a6-e25c0e558246
</pre>
<p>And now we are ready to convert our KVM instance disk from QCOW2 to VMDK. We are converting to a temp VMDK because we will be doing one additional conversion after this but that will performed on our ESXi host.</p>
<pre>sudo qemu-img convert -f qcow2 gerrit.qcow2 -O vmdk gerrit.tmp.vmdk -o compat6
</pre>
<p>The -o compat6 ensures that we do not split into 2GB disk chunks.</p>
<p>Now we will actually import the VMDK using VMWare tools. <em>(You do not have to do this but in order to convert from an IDE disk to a SCSI disk I found this next step important.)</em></p>
<p>So ssh to your ESXi host and change to the directory where you want to create a new VM.</p>
<pre>~ # cd /vmfs/volumes
/vmfs/volumes # ls
5078649c-69230922-3c11-d48564578160     ESXi03-Boot                             <strong>Tier-3 (NAS01)</strong>                          e8b09192-70615910
507864a7-76cd6a9d-db0e-d48564578160     HD-Pool (KVM)                           Veeam (NAS02)                           ff03567d-152e321f-c407-7f3bdcf49b3b
5196d286-1fb87f99                       <strong>HD-Pool (PF9)</strong>                           ab435954-c62a44e9                       vsan:52a59308860999bb-a80c6ed5bd953476
5249f964-a2e71f7f-510b-001cc447c615     ISO's (NAS01)                           ca8a927c-6c75b16e-17d4-621d9b25fc79     vsanDatastore
663e335e-dcaeabe2                       Templates (NAS01)                       e863b35d-c9134f70
99b256e8-309ffc2e                       Tier-2 (NAS01)                          e8938b46-d28efa89
/vmfs/volumes #
</pre>
<p>I will be using Tier-3 (NAS01) here.</p>
<pre>cd Tier-3\ \(NAS01\)/
mkdir gerrit
cd gerrit
</pre>
<p>Now we are ready to import our temp VMDK.</p>
<p>And from the output above from our directory listing we will be importing from our <strong>HD-Pool (PF9) datastore</strong>.</p>
<pre>vmkfstools -i /vmfs/volumes/HD-Pool\ \(PF9\)/91ecc01f-41f8-4f1d-a5a6-e25c0e558246/gerrit.tmp.vmdk -d thin gerrit.vmdk
</pre>
<p>After performing the above step you should now have two VMDK files in the current directory.</p>
<pre>/vmfs/volumes/663e335e-dcaeabe2/gerrit # ls -l *.vmdk
-rw-------    1 root     root     38654705664 Jan 12 19:29 gerrit-flat.vmdk
-rw-------    1 root     root           554 Jan 12 19:27 gerrit.vmdk
/vmfs/volumes/663e335e-dcaeabe2/gerrit #
</pre>
<p>Now in order to change from IDE to SCSI we will do the following and change IDE to lsilogic. Settings to change are in <strong>bold</strong>.</p>
<pre>vi gerrit.vmdk
</pre>
<p>Original:</p>
<pre># Disk DescriptorFile
version=1
CID=05e9aba7
parentCID=ffffffff
isNativeSnapshot="no"
createType="vmfs"

# Extent description
RW 75497472 VMFS "gerrit-flat.vmdk"

# The Disk Data Base
#DDB

ddb.adapterType = <strong>"ide"</strong>     
ddb.deletable = "true"
ddb.encoding = "UTF-8"
ddb.geometry.cylinders = "74898"
ddb.geometry.heads = "16"
ddb.geometry.sectors = "63"
ddb.longContentID = "8124c2c9cf1609f2921a6b6705e9aba7"
ddb.thinProvisioned = "1"
ddb.toolsVersion = "2147483647"
ddb.uuid = "60 00 C2 90 d1 69 8c d2-f6 65 3b 98 be 64 04 5e"
ddb.virtualHWVersion = "6"
</pre>
<p>Change to:</p>
<pre># Disk DescriptorFile
version=1
CID=05e9aba7
parentCID=ffffffff
isNativeSnapshot="no"
createType="vmfs"

# Extent description
RW 75497472 VMFS "gerrit-flat.vmdk"

# The Disk Data Base
#DDB

ddb.adapterType = <strong>"lsilogic"</strong>     
ddb.deletable = "true"
ddb.encoding = "UTF-8"
ddb.geometry.cylinders = "74898"
ddb.geometry.heads = "16"
ddb.geometry.sectors = "63"
ddb.longContentID = "8124c2c9cf1609f2921a6b6705e9aba7"
ddb.thinProvisioned = "1"
ddb.toolsVersion = "2147483647"
ddb.uuid = "60 00 C2 90 d1 69 8c d2-f6 65 3b 98 be 64 04 5e"
ddb.virtualHWVersion = "6"
</pre>
<p>Now we are ready to use our new VMDK for a newly created ESXi VM. So follow your normal process of creating a new VM but specify custom and when you get to the disk selection choose use existing VMDK and browse to the datastore where we did our final import on our ESXi host.</p>
<p>Once completed on creating a new VM called gerrit in this case. Boot it up and all should be good.</p>
<p>When booting up the first time cloud-init will kick in like the screenshot below.</p>
<p><a href="http://everythingshouldbevirtual.com/wp-content/uploads/2016/01/Screen-Shot-2016-01-12-at-2.24.10-PM.png"><img class="alignnone size-medium wp-image-5486" src="{{ site.baseurl }}/assets/Screen-Shot-2016-01-12-at-2.24.10-PM-300x209.png" alt="Screen Shot 2016-01-12 at 2.24.10 PM" width="300" height="209" /></a></p>
<p>Once the VM is completely booted up we can fix the cloud-init. And we will do this by actually just uninstalling cloud-init as it is no longer needed.</p>
<pre>sudo apt-get purge cloud-init
</pre>
<p>Now reboot and all should be good.</p>
<p>And that concludes this short exercise.</p>
<p>Enjoy!</p>
