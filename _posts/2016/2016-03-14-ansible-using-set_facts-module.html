---
layout: post
title: Ansible - Using the set_facts module
date: 2016-03-14 22:43:56.000000000 -04:00
type: post
published: true
status: publish
categories:
- Ansible
- Automation
tags:
- Ansible
meta:
  _wp_rp_image: empty
  _yoast_wpseo_primary_category: '411'
  _snap_forceSURL: '2'
  snap_MYURL: ''
  snapEdIT: '1'
  _edit_last: '7644'
  snapFB: s:298:"a:1:{i:0;a:10:{s:4:"doFB";s:1:"1";s:8:"postType";s:1:"A";s:10:"AttachPost";s:1:"1";s:10:"SNAPformat";s:51:"New
    post (%TITLE%) has been published on %SITENAME%";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:2:"do";s:1:"1";s:11:"isPrePosted";s:1:"1";}}";
  snapLI: s:290:"a:1:{i:0;a:10:{s:4:"doLI";s:1:"1";s:8:"postType";s:1:"A";s:10:"SNAPformat";s:41:"New
    post has been published on %SITENAME%";s:12:"liMsgFormatT";s:1:" ";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:9:"isAutoURL";s:1:"A";s:8:"urlToUse";s:0:"";s:2:"do";s:1:"1";s:11:"isPrePosted";s:1:"1";}}";
  _s2mail: 'yes'
  wp_github_commits_page_fields: a:3:{s:15:"gc_widget_title";s:0:"";s:11:"github_user";s:0:"";s:11:"github_repo";s:0:"";}
  _yoast_wpseo_focuskw_text_input: Ansible - Using the set_facts module
  _yoast_wpseo_focuskw: Ansible - Using the set_facts module
  _yoast_wpseo_linkdex: '72'
  snap_isAutoPosted: '1'
  snapDL: s:259:"a:1:{i:0;a:8:{s:4:"doDL";s:1:"1";s:11:"SNAPformatT";s:7:"%TITLE%";s:10:"SNAPformat";s:9:"%EXCERPT%";s:2:"do";s:1:"1";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:32:"fecf7deb4e94f1ff2392bbafd0673dd3";s:5:"pDate";s:19:"2016-03-15
    02:43:57";}}";
  snapSU: s:322:"a:1:{i:0;a:10:{s:4:"doSU";s:1:"1";s:7:"apSUCat";s:2:"IT";s:4:"nsfw";s:1:"0";s:10:"SNAPformat";s:16:"%TITLE%
    - %TEXT%";s:2:"do";s:1:"1";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:6:"2Qkt2U";s:7:"postURL";s:50:"http://www.stumbleupon.com/content/2Qkt2U/comments";s:5:"pDate";s:19:"2016-03-15
    02:44:07";}}";
  _wp_rp_related_posts_query_result_cache_expiration: '1510216369'
  _wp_rp_related_posts_query_result_cache_6: a:12:{i:0;O:8:"stdClass":2:{s:7:"post_id";s:4:"6225";s:5:"score";s:17:"69.05033254820262";}i:1;O:8:"stdClass":2:{s:7:"post_id";s:4:"4386";s:5:"score";s:18:"59.727599160064486";}i:2;O:8:"stdClass":2:{s:7:"post_id";s:4:"4367";s:5:"score";s:18:"55.247385355793625";}i:3;O:8:"stdClass":2:{s:7:"post_id";s:4:"4915";s:5:"score";s:18:"54.974331551922646";}i:4;O:8:"stdClass":2:{s:7:"post_id";s:4:"4944";s:5:"score";s:18:"54.232373687634365";}i:5;O:8:"stdClass":2:{s:7:"post_id";s:4:"4505";s:5:"score";s:18:"54.232373687634365";}i:6;O:8:"stdClass":2:{s:7:"post_id";s:4:"4648";s:5:"score";s:17:"54.02165265633171";}i:7;O:8:"stdClass":2:{s:7:"post_id";s:4:"4391";s:5:"score";s:16:"53.5300621176991";}i:8;O:8:"stdClass":2:{s:7:"post_id";s:4:"4449";s:5:"score";s:15:"53.352471119477";}i:9;O:8:"stdClass":2:{s:7:"post_id";s:4:"5734";s:5:"score";s:17:"51.30916862442603";}i:10;O:8:"stdClass":2:{s:7:"post_id";s:4:"5498";s:5:"score";s:18:"50.944525510708246";}i:11;O:8:"stdClass":2:{s:7:"post_id";s:4:"5383";s:5:"score";s:18:"50.549975297935575";}}
  snapTW: 's:352:"a:1:{i:0;a:10:{s:4:"doTW";s:1:"1";s:10:"SNAPformat";s:78:"%TITLE%
    - %URL% #everythingshouldbevirtual #Ansible #automation #DevOPS #Cacti";s:8:"attchImg";s:1:"0";s:9:"isAutoImg";s:1:"A";s:8:"imgToUse";s:0:"";s:2:"do";s:1:"1";s:11:"isPrePosted";s:1:"1";s:8:"isPosted";s:1:"1";s:4:"pgID";s:18:"709570845111230465";s:5:"pDate";s:19:"2016-03-15
    02:44:07";}}";'
author:
  login: mrlesmithjr
  email: mrlesmithjr@gmail.com
  display_name: Larry Smith Jr.
  first_name: ''
  last_name: ''
---
<blockquote><strong>Ansible - Using the set_facts module</strong></p>
<hr />
</blockquote>
<p>Today I was writing/updating an Ansible role for installing Cacti monitoring and decided to add the ability to choose the back-end webserver being used. The original role was written based on using Apache as the webserver back-end. However I wanted the ability to choose between Apache, NGINX or Lighttpd. Being that I have created Ansible roles for each already I figured I may as well leverage those. So I started messing with different variables and testing to see how things would work and it just was becoming too complex and would be rather difficult for someone potentially not understanding what all was going on. Well I finally came around to a solution that for the most part should remain quite dynamic and wanted to share that with everyone in case you ever find yourself in this same situation.</p>
<p>So what did I need the variables to define? I needed a way to set variables for the following:</p>
<pre>web_group - which would define based on webserver type and OS type what the webserver groupname was.
web_owner - which would define based on webserver type and OS type what the webserver username was.
web_root - which would define based on webserver type and OS type what the webserver default root directory was.
webserver_handler - which would define based on webserver type and OS type what the servicename was in order to restart after configuration changes were made.
</pre>
<p>So as you can see this could get a little out of control when the end-user needs to define all of these different settings and such. So I finally settled on utilizing the <a href="http://docs.ansible.com/ansible/set_fact_module.html" target="_blank">set_facts</a> Ansible module which was a perfect fit for my needs.</p>
<p>Now for what ended up working is what I will share below.</p>
<p>In the role's main task I added the following:</p>
<pre>---
# tasks file for ansible-cacti
- include: set_facts.yml

- include: debian.yml
  when: ansible_os_family == "Debian"

- include: redhat.yml
  when: ansible_os_family == "RedHat"

- include: users.yml

- include: database.yml

- include: config_cacti.yml

- include: templates.yml
  when: cacti_import_templates
</pre>
<p>If you notice the very first include is to execute a task called <em>set_facts.yml</em> and this is where the magic comes into play. So let's take a look at that task's contents.</p>
<pre>---
- name: setting fact Debian apache2
  set_fact:
    cacti_web_group: "www-data"
    cacti_web_owner: "www-data"
    cacti_web_root: "/var/www/html"
    cacti_webserver_handler: "apache2"
  when: &gt;
        ansible_os_family == "Debian" and
        cacti_webserver_type == "apache2"

- name: setting fact Debian lighttpd
  set_fact:
    cacti_web_group: "www-data"
    cacti_web_owner: "www-data"
    cacti_web_root: "/var/www"
    cacti_webserver_handler: "lighttpd"
  when: &gt;
        ansible_os_family == "Debian" and
        cacti_webserver_type == "lighttpd"

- name: setting fact Debian nginx
  set_fact:
    cacti_web_group: "www-data"
    cacti_web_owner: "www-data"
    cacti_web_root: "/usr/share/nginx/html"
    cacti_webserver_handler: "nginx"
  when: &gt;
        ansible_os_family == "Debian" and
        cacti_webserver_type == "nginx"

- name: setting fact RedHat apache2
  set_fact:
    cacti_web_group: "apache"
    cacti_web_owner: "apache"
    cacti_web_root: "/var/www/html"
    cacti_webserver_handler: "httpd"
  when: &gt;
        ansible_os_family == "RedHat" and
        cacti_webserver_type == "apache2"

- name: setting fact RedHat lighttpd
  set_fact:
    cacti_web_group: "lighttpd"
    cacti_web_owner: "lighttpd"
    cacti_web_root: "/srv/www"
    cacti_webserver_handler: "lighttpd"
  when: &gt;
        ansible_os_family == "RedHat" and
        cacti_webserver_type == "lighttpd"

- name: setting fact RedHat nginx
  set_fact:
    cacti_web_group: "nginx"
    cacti_web_owner: "nginx"
    cacti_web_root: "/usr/share/nginx/html"
    cacti_webserver_handler: "nginx"
  when: &gt;
        ansible_os_family == "RedHat" and
        cacti_webserver_type == "nginx"
</pre>
<p>And if we take a look at the above we will see that for each different OS type (Debian or RedHat) we are setting the following facts:</p>
<pre>cacti_web_group:
cacti_web_owner:
cacti_web_root:
cacti_webserver_handler:
</pre>
<p>Doing this allows for us to leverage fewer tasks to accomplish the same things. So for example if we are deploying on an Ubuntu or Debian OS and would like to use NGINX for our back-end webserver we would set the following variable in our <em>defaults/main.yml</em>:</p>
<pre>cacti_webserver_type: 'nginx'  #defines web server type (apache2|lighttpd|nginx)
</pre>
<p>And if we were to apply the role the following variables would be set for us to use throughout the Ansible play.</p>
<pre>cacti_web_group: "www-data"
cacti_web_owner: "www-data"
cacti_web_root: "/usr/share/nginx/html"
cacti_webserver_handler: "nginx"
</pre>
<p>And when we reach a task that requires one of these variables it would be ready for use. For example:</p>
<pre>- name: config_cacti | setting site permissions
  file:
    path: "{{ cacti_web_root }}/cacti-{{ cacti_version }}"
    state: directory
    recurse: yes
    owner: "{{ cacti_web_owner }}"
    group: "{{ cacti_web_group }}"
</pre>
<p>And if we reach a task in which requires a notifier to fire off a restart of the webserver service:</p>
<pre>- name: debian | installing php5
  apt:
    name: "php5"
    state: present
  notify:
    - 'restart {{ cacti_webserver_handler }}'
</pre>
<p>So as you can see this makes for a very nice way to handle defining variables in a complex role much easier and dynamic. And if we decided we would rather use Lighttpd as our back-end webserver all we would need to do is define the following in our <em>defaults.yml</em>:</p>
<pre>cacti_webserver_type: 'lighttpd'  #defines web server type (apache2|lighttpd|nginx)
</pre>
<p>And that is the only variable we would need to define in order to change our deployment of the Cacti role. Pretty easy right?<br />
Now below is what an example playbook might look like in order to leverage setting our back-end webserver:</p>
<pre>---
- hosts: all
  become: true
  vars:
    - cacti_webserver_type: 'apache2'
    - pri_domain_name: 'vagrant.local'
  roles:
    - role: ansible-apache2
      when: cacti_webserver_type == "apache2"
    - role: ansible-lighttpd
      when: cacti_webserver_type == "lighttpd"
    - role: ansible-nginx
      when: cacti_webserver_type == "nginx"
    - role: ansible-mariadb-mysql
    - role: ansible-ntp
    - role: ansible-snmpd
    - role: ansible-timezone
    - role: ansible-cacti
  tasks:
</pre>
<p>And using the above playbook would deploy Cacti using Apache2 as our back-end webserver.</p>
<p>So there you have it. A very good use-case of using the set_facts Ansible module.</p>
<p>Enjoy!</p>
